<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/itsm/pageType/pagingListLayout}">
<head>
    <title th:text="#{cmdb.ci.label.ciInquiry}"></title>
    <th:block layout:fragment="pageHead">
        <script th:src="@{/assets/js/cmdb/zCmdbAttribute.js}"></script>
    </th:block>
</head>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{cmdb.ci.label.ciInquiry}"></h1>
    <h6 class="description ml-2 pl-2" th:text="#{cmdb.ci.msg.searchDescription}"></h6>
</div>
<div layout:fragment="pageSearching">
    <input type="hidden" sec:authorize="hasAuthority('cmdb.ci.create') || hasAuthority('cmdb.ci.update')"
           th:name="isRole" th:value="true"/>
    <input type="hidden" sec:authorize="!hasAuthority('cmdb.ci.create') && !hasAuthority('cmdb.ci.update')"
           th:name="isRole" th:value="false"/>
    <form id="searchFrm">
        <input type="text" class="z-input i-search col-5" id="searchValue" name="searchValue" maxlength="100"
               th:placeholder="#{cmdb.ci.label.searchPlaceholder}"/>
        <input type="text" class="z-input i-search col-5 mr-2" id="tagSearch" name="tagSearch" maxlength="100"
               th:placeholder="#{cmdb.ci.label.tagPlaceholder}"/>
        <input type="hidden" id="flag" name="flag" value="itsm"/>
        <th:block th:replace="layout/itsm/fragment/totalCountFragment :: totalCountFragment"></th:block>
    </form>
</div>
<div layout:fragment="pageList">
    <div class="z-list-content" id="ciList"></div>
</div>
</body>
<script layout:fragment="pageScript" th:inline="javascript">
    /*<![CDATA[*/
    window.onload = function () {
        document.getElementById('searchValue').focus();
        document.getElementById('searchValue').onkeyup = function() {
            getList();
        };

        new zTag(document.getElementById('tagSearch'), {
            suggestion: true,
            realtime: false,
            tagType: 'ci',
            targetId: '',
            callback: function () {
                getList();
            }
        });

        getList();
    }

    function openCIDetailModal(ciId) {
        restSubmit('GET', '/cmdb/cis/'+ciId+'/view', false);
    }

    function getList(pageNum = 1) {
        restSubmit('get', '/cmdb/cis?' + aliceJs.serialize(document.getElementById('searchFrm')) + '&pageNum=' + pageNum);
        let ciListTags = document.querySelectorAll('input[name=ciListTags]');
        let ciIdList= (document.querySelectorAll('input[name=ciId]'));
        for (let i = 0; i < ciListTags.length; i++) {
            new zTag(ciListTags[i], {
                suggestion: false,
                realtime: false,
                tagType: 'ci',
                targetId: ciIdList[i].value
            });
        }
    }

    function restSubmit(method, url) {
        const opt = {
            method: method,
            url: url,
            async: false,
            showProgressbar: false,
            callbackFunc: function (response) {
                if (url.indexOf("/view") > 0) {
                    const ciDetailModal = new modal({
                        title: i18n.msg('cmdb.ci.label.view'),
                        body: response.responseText,
                        classes: 'cmdb-ci-view-modal',
                        buttons: [{
                            content: i18n.msg('common.btn.close'),
                            classes: 'z-button secondary',
                            bindKey: false,
                            callback: function (modal) {
                                modal.hide();
                            }
                        }],
                        close: {
                            closable: false,
                        },
                        onCreate: function (modal) {
                            document.getElementById('ciAttributes').click();
                            // 스크롤바 추가
                            OverlayScrollbars(document.querySelector('.cmdb-ci-content-view'), {className: 'scrollbar'});
                            OverlayScrollbars(document.querySelectorAll('textarea'), {
                                className: 'scrollbar',
                                resize: 'vertical',
                                sizeAutoCapable: true,
                                textarea: {
                                    dynHeight: false,
                                    dynWidth: false,
                                    inheritedAttrs: "class"
                                }
                            });
                            new zTag(document.querySelector('input[name=ciDetailTags]'),{
                                suggestion: false,
                                realtime: false,
                                tagType: 'ci',
                                targetId: document.getElementById('ciId').getAttribute('value')
                            });
                            // 서버에서 전달받은 데이터의 날짜 포맷을 변경한다.
                            document.querySelectorAll('.date-time').forEach(dt => {
                                dt.textContent = i18n.userDateTime(dt.textContent.trim());
                            });
                        }
                    });
                    ciDetailModal.show();
                } else {
                    document.getElementById('ciList').innerHTML = response.responseText;
                }
            }
        };
        aliceJs.sendXhr(opt);
    }
    /*]]>*/
</script>
</html>
