<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorator="layout/defaultLayout">
<head>
    <title th:text="#{cmdb.type.label.management}"></title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="cmdb-type-header">
        <div class="header-title flex-row align-items-baseline">
            <h1 th:text="#{cmdb.type.label.management}"></h1>
            <h6 class="description" th:text="#{cmdb.type.msg.searchDescription}"></h6>
        </div>
        <div class="header-search flex-row">
            <input type="text" class="search col-5 mr-2" id="search" name="search" maxlength="100"
                   th:placeholder="#{cmdb.type.label.searchPlaceholder}"/>
            <span id="totalCount" class="txt-num"></span>
            <div class="ml-auto">
                <button type="button" class="default-fill" id="btnImport" name="btnImport"
                        sec:authroize="hasAuthority('cmdb.class.create')" th:text="#{cmdb.type.btn.import}"></button>
                <button type="button" class="default-fill" id="btnCreate" name="btnCreate" onclick="onCreate();"
                        sec:authorize="hasAuthority('cmdb.type.create')" th:text="#{common.btn.add}"></button>
            </div>
        </div>
    </div>
    <div class="cmdb-type-content flex-fill">
        <div class="list-tree">
            <div id="treeList"></div>
        </div>
    </div>
</th:block>
<th:block layout:fragment="aside">
    <div class="aside tree">
        <div class="cmdb-type-content-edit flex-column">
            <div class="edit-form">
                <div class="edit-row flex-column">
                    <label class="required" th:text="#{cmdb.type.label.parentType}" for="parentTypeName"></label>
                    <input id="parentTypeName" name="parentTypeName" type="text" maxlength="100" readonly/>
                    <input id="parentTypeId" name="parentTypeId" type="hidden"/>
                </div>
                <div class="edit-row flex-column">
                    <label class="required" th:text="#{cmdb.type.label.name}" for="typeName"></label>
                    <input id="typeName" name="typeName" type="text" maxlength="100"/>
                    <input id="typeId" name="typeId" type="hidden"/>
                </div>
                <div class="edit-row flex-column">
                    <label th:text="#{cmdb.type.label.description}" for="typeDesc"></label>
                    <textarea id="typeDesc" name="typeDesc" th:maxlength="200" th:rows="7"
                              class="textarea-scroll-wrapper" text=""></textarea>
                </div>
                <div class="edit-row flex-column">
                    <label th:text="#{cmdb.type.label.icon}" for="typeIcon"></label>
                    <div class="flex-row input-button">
                        <input class="col-pct-12 inherit" id="typeIcon" name="typeIcon" type="text" readonly>
                        <button class="default-line col-1" name="typeIconSelector" type="button" onclick="" th:text="#{common.btn.select}"></button>
                    </div>
                </div>
                <div class="edit-row flex-column">
                    <label th:text="#{cmdb.type.label.class}" for="typeClass"></label>
                    <div class="flex-row input-button">
                        <input class="col-pct-12 inherit" id="typeClass" name="typeClass" type="text" readonly>
                        <input id="typeClassId" name="typeClassId" type="hidden"/>
                        <button class="default-line col-1" name="typeClassSelector" type="button" onclick="classPopUp();" th:text="#{common.btn.select}"></button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-row justify-content-end">
            <div class="btn-list">
                <button sec:authorize="hasAuthority('cmdb.class.create')"
                        class="default-fill" type="button" id="btnExport" name="btnExport"
                        th:text="#{cmdb.type.btn.export}"></button>
                <button sec:authorize="hasAuthority('cmdb.type.create')"
                        class="point-fill" type="button" id="btnRegist" name="btnRegist"
                        th:onclick="|javascript:onSave('post')|" th:text="#{common.btn.register}"></button>
                <button sec:authorize="hasAuthority('cmdb.type.update')"
                        class="point-fill" type="button" id="btnUpdate" name="btnUpdate"
                        th:onclick="|javascript:onSave('put')|" th:text="#{common.btn.update}"></button>
                <button sec:authorize="hasAuthority('cmdb.type.delete')"
                        class="point-fill" type="button" id="btnDelete" name="btnDelete"
                        th:onclick="|javascript:aliceJs.confirmIcon(i18n.msg('common.msg.confirmDelete'), onDelete)|" th:text="#{common.btn.delete}"></button>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        const STATUS_SUCCESS = '0';
        const STATUS_SUCCESS_EDIT_TYPE = '1';

        window.addEventListener('load', function() {
            document.getElementById('search').focus();
            onCreate();

            function getTypeList() {
                tree.load({
                    search: encodeURIComponent(document.querySelector('#search').value),
                    source: 'ciType',
                    target: 'treeList',
                    text: 'typeName',
                    totalCount: true,
                    selectedNode: function(response) {
                        onGetDetail(response.id)
                    }
                });
            }
            getTypeList();

            // 상세조회
            function onGetDetail(typeId) {
                document.querySelectorAll('input[type=text]').forEach(function(object){
                    object.value = '';
                });
                document.querySelector('textarea').value = '';

                const opt = {
                    method: 'get',
                    url: '/rest/cmdb/types/' + typeId,
                    showProgressbar: false,
                    callbackFunc: function(response) {
                        let responseJson = JSON.parse(response.responseText);
                        document.getElementById('parentTypeName').setAttribute('disabled','');
                        document.getElementById('parentTypeName').value = responseJson.ptypeName;
                        document.getElementById('parentTypeId').value = responseJson.ptypeId;
                        document.getElementById('typeName').value = responseJson.typeName;
                        document.getElementById('typeId').value = responseJson.typeId;
                        document.getElementById('typeDesc').value = responseJson.typeDesc;
                        document.getElementById('typeIcon').value = responseJson.typeIcon;
                        document.getElementById('typeClassId').value = responseJson.defaultClassId;
                        document.getElementById('typeClass').value = responseJson.defaultClassName;
                        if (responseJson.ptypeId !== null) {
                            document.querySelector('#btnUpdate').removeAttribute('disabled');
                            document.querySelector('#btnDelete').removeAttribute('disabled');
                            document.querySelector('button[name=typeIconSelector]').removeAttribute('disabled');
                            document.querySelector('button[name=typeClassSelector]').removeAttribute('disabled');
                        } else {
                            document.getElementById('btnUpdate').disabled = true;
                            document.getElementById('btnDelete').disabled = true;
                            document.getElementById('btnDelete').disabled = true;
                            document.querySelector('button[name=typeIconSelector]').disabled = true;
                            document.querySelector('button[name=typeClassSelector]').disabled = true;
                        }
                        onEdit();
                    }
                };
                aliceJs.sendXhr(opt);
            }
            OverlayScrollbars(document.querySelector('.list-tree'), { className: 'scrollbar' });
            document.getElementById('search').addEventListener('keyup', function() {
                getTypeList();
            });
            OverlayScrollbars(document.querySelector('.type-content-edit'), { className: 'scrollbar' });
            OverlayScrollbars(document.querySelectorAll('#typeDesc'), {
                className: 'scrollbar',
                resize: 'vertical',
                sizeAutoCapable: true,
                textarea: {
                    dynHeight: false,
                    dynWidth: false,
                    inheritedAttrs: "class"
                }
            });
        });

        /** create **/
        function onCreate() {
            document.querySelector('#btnUpdate').style.display = 'none';
            document.querySelector('#btnDelete').style.display = 'none';
            document.querySelector('#btnRegist').style.display = 'block';
            document.querySelector('button[name=typeIconSelector]').removeAttribute('disabled');
            document.querySelector('button[name=typeClassSelector]').removeAttribute('disabled');
            document.querySelectorAll('input[type=text]:not(.inherit)').forEach(function(object){
                object.value = '';
            });
            document.querySelector('textarea').value = '';

            let selectedNode = tree.getTreeSelectNode();
            if (selectedNode !== null) {
                document.querySelector('#parentTypeName').value = selectedNode.dataset.name;
                document.querySelector('#parentTypeId').value = selectedNode.id;
            }
        }

        function onEdit() {
            document.querySelector('#btnUpdate').style.display = 'block';
            document.querySelector('#btnDelete').style.display = 'block';
            document.querySelector('#btnRegist').style.display = 'none';
        }

        /** save **/
        function onSave(method) {
            const jsonData = {
                typeId: document.getElementById('typeId').value,
                pTypeId: document.getElementById('parentTypeId').value,
                typeName: document.getElementById('typeName').value,
                typeDesc: document.getElementById('typeDesc').value,
                typeIcon: document.getElementById('typeIcon').value,
                defaultClassId: document.getElementById('typeClassId').value,
                defaultClassName: document.getElementById('typeClass').value
            };
            if (jsonData.pTypeId === null || jsonData.pTypeId.trim() === '') {
                aliceJs.alertWarning([[#{cmdb.type.msg.enterPType}]]);
                return false;
            }
            if (jsonData.typeName === null || jsonData.typeName.trim() === '') {
                aliceJs.alertWarning([[#{cmdb.type.msg.enterTypeName}]]);
                return false;
            }
            let url = '/rest/cmdb/types';
            if (method !== 'post') {
                url += '/' + document.getElementById('typeId').value;
            }
            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(jsonData),
                contentType: 'application/json',
                callbackFunc: function (response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            aliceJs.alertSuccess(i18n.msg('common.msg.register'), function () {
                                window.location.href = '/cmdb/types/edit';
                            });
                            break;
                        case STATUS_SUCCESS_EDIT_TYPE:
                            aliceJs.alertSuccess(i18n.msg('common.msg.update'), function () {
                                window.location.href = '/cmdb/types/edit';
                            });
                            break;
                        default:
                            aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                            break;
                    }
                }
            };
            aliceJs.sendXhr(opt);
        }

        /** delete **/
        function onDelete() {
            const opt = {
                method: 'delete',
                url: '/rest/cmdb/types/' + document.getElementById('typeId').value,
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            aliceJs.alertSuccess(i18n.msg('common.msg.delete'), function() {
                                window.location.href ='/cmdb/types/edit';
                            });
                            break;
                        default:
                            aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                            break;
                    }
                }
            };
            aliceJs.sendXhr(opt);
        }

        /** Type-Class **/
        function classPopUp() {
            if (document.getElementById('typeClass').value !== '') {
                tree.load({
                    view: 'modal',
                    title: i18n.msg('cmdb.type.label.class'),
                    source: 'ciClass',
                    target: 'modalTreeList',
                    text: 'className',
                    selectedValue: document.getElementById('typeClassId').value,
                    callbackFunc: function(response) {
                        if (response.id !== 'root') {
                            document.querySelector('#typeClass').value = response.dataset.name;
                            document.querySelector('#typeClassId').value = response.id;
                        } else {
                            aliceJs.alertWarning([[#{cmdb.type.msg.selectAvilableClass}]]);
                        }
                    }
                });
            } else {
                aliceJs.alertWarning([[#{cmdb.type.msg.selectType}]]);
            }
        }
        /*]]>*/
    </script>
</th:block>
</html>
