<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/itsm/itsmLayout}">
<head>
    <title th:text="#{calendar.label.calendar}"></title>
</head>
<th:block layout:fragment="pageHead">
    <link th:href="@{/assets/vendors/tuiCalendar/tui-date-picker.css}" rel="stylesheet"/>
    <link th:href="@{/assets/vendors/tuiCalendar/tui-time-picker.css}" rel="stylesheet"/>
    <link th:href="@{/assets/vendors/tuiCalendar/tui-calendar.css}" rel="stylesheet"/>
    <script th:src="@{/assets/vendors/tuiCalendar/tui-code-snippet.min.js}"></script>
    <script th:src="@{/assets/vendors/tuiCalendar/tui-date-picker.min.js}"></script>
    <script th:src="@{/assets/vendors/tuiCalendar/tui-time-picker.min.js}"></script>
    <script th:src="@{/assets/vendors/tuiCalendar/tui-calendar.min.js}"></script>
    <script th:src="@{/assets/vendors/tuiCalendar/tui-calendar.custom.js}"></script>
</th:block>
<body>
<div layout:fragment="pageTitle" class="z-main-title--empty">
</div>
<th:block layout:fragment="pageContent">
    <div class="calendar">
        <div class="calendar__menu" id="calendarMenu">
            <div class="calendar__button-group">
                <button type="button" class="z-button-icon calendar__action calendar__move" data-action="prev"
                        onclick="javascript:onClickCalendarMenu(this);">
                    <span class="z-icon i-arrow-right move--prev"></span>
                </button>
                <button type="button" class="z-button-icon calendar__action calendar__move" data-action="next"
                        onclick="javascript:onClickCalendarMenu(this);">
                    <span class="z-icon i-arrow-right move--next"></span>
                </button>
                <button type="button" class="z-button calendar__action secondary" th:text="#{calendar.label.today}"
                        data-action="today" onclick="onClickCalendarMenu(this);"></button>
                <div class="z-button-switch-group" id="calendarViewType">
                    <button class="z-button-switch selected" type="button" data-action="month"
                            onclick="javascript:onClickCalendarType(this);">
                        <span class="z-text" th:text="#{calendar.label.month}"></span>
                    </button>
                    <button class="z-button-switch" type="button" data-action="week"
                            onclick="javascript:onClickCalendarType(this);">
                        <span class="z-text" th:text="#{calendar.label.week}"></span>
                    </button>
                    <button class="z-button-switch" type="button" data-action="day"
                            onclick="javascript:onClickCalendarType(this);">
                        <span class="z-text" th:text="#{calendar.label.day}"></span>
                    </button>
                    <button class="z-button-switch" type="button" data-action="task"
                            onclick="javascript:onClickCalendarType(this);">
                        <span class="z-text" th:text="#{calendar.label.task}"></span>
                    </button>
                </div>
            </div>
            <h3 class="calendar__render-range-text align-center"></h3>
            <div class="ml-auto">
                <button type="button" class="z-button secondary" id="calendarTemplateUpload" onclick="javascript:openTemplateUploadModal()" th:text="#{cmdb.ci.btn.importTemplate}"></button>
                <button type="button" class="z-button-icon secondary" id="excelDownload" onclick="javascript:onExcelDownload();" th:title="#{common.btn.export}">
                    <img class="load-svg" th:src="@{/assets/media/icons/icon_download_xls.svg}" />
                </button>
            </div>
        </div>
        <div class="calendar__view on" id="calendarView" style="height: 780px;"></div>
        <div class="calendar__view calendar__view--task" id="taskView"></div>
    </div>
</th:block>
<script layout:fragment="pageScript" type="text/javascript" th:inline="javascript">
    const calendarList = /*[[${calendarList}]]*/ '';
    let myCalendar = null; // tui calendar 객체
    let prevStandardDate = '';
    window.onload = function() {
        // 달력 초기화
        myCalendar = new zCalendar('calendarView', {
            viewType: 'month'
        });
        myCalendar.setRenderRangeText();
        // 목록 초기화
        myCalendar.setCalendars(calendarList);
        // 일정 조회
        setSchedules();

        OverlayScrollbars(document.querySelector('.z-main-content'), { className: 'scrollbar' });
    };

    /**
     * 일정 목록 조회
     */
    function setSchedules() {
        // 기존 목록 삭제
        myCalendar.clear();

        // 데이터 재조회
        const calendarIds = calendarList.reduce((acc, cur) => {
            acc.push(cur.calendarId);
            return acc;
        }, []);
        const viewType = document.querySelector('#calendarViewType .z-button-switch.selected')
            .getAttribute('data-action');
        prevStandardDate = myCalendar.getDate().toFormat('yyyy-MM');
        const searchData = {
            viewType: viewType,
            standard: getStandardDate(viewType, myCalendar.getDate()),
            calendarIds: calendarIds
        };
        aliceJs.fetchJson('/rest/calendars', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(searchData)
        }).then((response) => {
            if (response.status === aliceJs.response.success) {
                const schedules = [];
                response.data.calendars.forEach((calendar) => {
                    calendar.schedules.forEach((schedule) => {
                        schedules.push({
                            id: schedule.id,
                            calendarId: calendar.id,
                            title: schedule.title,
                            body: schedule.contents,
                            isAllDay: schedule.allDayYn,
                            start: luxon.DateTime.fromISO(schedule.startDt, { zone: 'utc' }).setZone(i18n.timezone)
                                .toJSDate(),
                            end: luxon.DateTime.fromISO(schedule.endDt, { zone: 'utc' }).setZone(i18n.timezone)
                                .toJSDate(),
                            category: schedule.allDayYn ? 'allday' : 'time',
                            raw: {
                                dataId: schedule.dataId,
                                repeatId: '',
                                repeatSeq: 1,
                                repeatYn: schedule.repeatYn,
                                repeatType: schedule.repeatType,
                                repeatValue: schedule.repeatValue,
                                repeatPeriod: schedule.repeatPeriod,
                                ownerName: schedule.ownerName
                            }
                        });
                    });
                    calendar.repeats.forEach((repeat) => {
                        schedules.push({
                            id: repeat.dataId + repeat.index,
                            calendarId: calendar.id,
                            title: repeat.title,
                            body: repeat.contents,
                            isAllDay: repeat.allDayYn,
                            start: luxon.DateTime.fromISO(repeat.startDt, { zone: 'utc' }).setZone(i18n.timezone)
                                .toJSDate(),
                            end: luxon.DateTime.fromISO(repeat.endDt, { zone: 'utc' }).setZone(i18n.timezone).toJSDate(),
                            category: repeat.allDayYn ? 'allday' : 'time',
                            raw: {
                                dataId: repeat.dataId,
                                repeatId: repeat.id,
                                repeatSeq: repeat.index,
                                repeatYn: repeat.repeatYn,
                                repeatType: repeat.repeatType,
                                repeatValue: repeat.repeatValue,
                                repeatPeriod: repeat.repeatPeriod,
                                ownerName: repeat.ownerName
                            }
                        });
                    });
                });
                myCalendar.addSchedule(viewType, schedules);
            }
        });
    }

    /**
     * viewType에 따라서 조회 날짜 변경
     */
    function getStandardDate(viewType, date) {
        switch (viewType) {
            case 'month': // 2022-05
            case 'task':
                return date.toFormat('yyyy-MM');
            case 'week': // 2022-05-13
                return date.toFormat('yyyy-MM-dd');
            case 'day': // 2022-05-13
                return date.toFormat('yyyy-MM-dd');
            default:
                break;
        }
    }

    /**
     * 월, 주, 일, 일정리스트 클릭
     */
    function onClickCalendarType(e) {
        const viewType = e.getAttribute('data-action');
        const buttonGroup = e.parentNode;
        // 초기화
        for (let i = 0, len = buttonGroup.children.length ; i< len; i++) {
            let child = buttonGroup.children[i];
            if (child.classList.contains('selected')) {
                child.classList.remove('selected');
            }
        }
        e.classList.add('selected');

        myCalendar.setCalendarViewType(viewType, setSchedules);
    }

    /**
     * 상단 메뉴 이벤트 처리
     * @param {e} 이벤트 객체
     */
    function onClickCalendarMenu(e) {
        myCalendar.onClickCalendarMenu(e.getAttribute('data-action'), (e) => {
            // 월 데이터가 변경되지 않는 다면 다시 데이터를 가져오지 않는다.
            // (버튼 클릭시 주, 일 반복 일정을 서버에서 계산하기 때문에 조회 수를 줄여서 부하를 낮추기 위함)
            if (luxon.DateTime.fromMillis(e.getDate().getTime()).toFormat('yyyy-MM') !== prevStandardDate) {
                setSchedules();
            }
        });
    }

    /**
     * 일괄 등록 모달 호출
     */
    function openTemplateUploadModal() {

    }

    /**
     * 일정 다운로드(엑셀)
     */
    function onExcelDownload() {

    }
</script>
</body>
</html>
