<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="report/reportCore">
<head>
    <title th:text="#{common.label.preview}"></title>
</head>
<th:block layout:fragment="css">
    <link th:href="@{/assets/css/report.css}" rel="stylesheet"/>
</th:block>
<body>
<th:block layout:fragment="content">
    <div class="z-report">
        <div class="z-report-main">
            <div class="z-report-main-header align-center" id="reportName"></div>
            <div class="z-report-area">
                <div class="z-drawing-board" id="reportContents">
                </div>
            </div>
            <div class="z-report-main-footer flex-row justify-content-between">
                <div class="z-logo"></div>
                <div class="z-paging"></div>
                <div class="z-info float-right align-right" id="report-information"></div>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script type="module">
        /*<![CDATA[*/
        import ZChart from '../../assets/js/chart/zChart.js';

        const CHART_DATE_FORMAT = 'yyyy-MM-dd HH:mm:ss';
        const zChartManager = {
            load: function(id, data) {
                // 차트 초기화
                this.zChart = new ZChart(id, data);

                // 데이터 업데이트
                this.zChart.update(data.chartData);
            },
            destroy: function () {
                if (this.zChart) {
                    this.zChart.destroy();
                    this.zChart = null;
                    delete this.zChart;
                }
            }
        }
        window.zChartManager = zChartManager;
        window.onload = function() {
            const userName = '[[${#authentication.details.userName}]]';
            const userEmail = '[[${#authentication.details.email}]]';
            const time = '[[${time}]]';

            let reportData = sessionStorage.getItem('alice_report');
            let data = JSON.parse(reportData)

            // 보고서 제목
            document.querySelector('#reportName').innerHTML = data.reportName;

            // footer
            const reportInfo = document.getElementById('report-information');
            reportInfo.innerHTML = userName + ' [' + userEmail + ']<br>' + i18n.printFormat(time);

            // 차트 데이터 조회
            if (data.charts !== undefined) {
                let urlParam = '';
                data.charts.forEach((item, index) => {
                    if (index > 0) {
                        urlParam += '&';
                    }
                    urlParam += 'chartId=' + item.chartId;
                });
                aliceJs.fetchJson('/rest/reports/template/charts?' + urlParam, {
                    method: 'GET',
                    showProgressbar: true
                }).then((dataList) => {
                    if (dataList.length === 0) { return false; }
                    dataList.forEach((data) => {
                        addChartContent(data);
                    });
                });
            }
        };

        // 차트 추가
        function addChartContent(data) {
            let chartTarget = document.querySelector('#reportContents');
            let element =
                `<div class="z-chart-content">` +
                `<div class="z-title align-left">${data.chartName}</div>` +
                `<div class="z-chart" id="${data.chartId}_chart"></div>` +
                `</div>`;
            chartTarget.insertAdjacentHTML('beforeend', element);

            // 사용자 날짜 데이터 변경
            const fromDt = data.chartConfig.range.from;
            const toDt = data.chartConfig.range.to;
            data.chartConfig.range.from = i18n.userDateTime(fromDt, CHART_DATE_FORMAT);
            data.chartConfig.range.to = i18n.userDateTime(toDt, CHART_DATE_FORMAT);

            // 태그 데이터는 Get 일때는 tagValue 로 전달되나 서버 및 하이차트에서는 value로 처리해야 함
            const tags = data.tags.reduce((acc, cur) => {
                acc.push({ value: cur.tagValue });
                return acc;
            }, []);
            data.tags = tags;

            // 차트 초기화
            zChartManager.load(data.chartId + '_chart', data);
        }
        /*]]>*/
    </script>
</th:block>
</html>
