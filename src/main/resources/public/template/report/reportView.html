<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="report/reportCore">
<head>
    <title th:text="#{report.label.preview}"></title>
</head>
<th:block layout:fragment="css">
    <link th:href="@{/assets/css/report.css}" rel="stylesheet"/>
</th:block>
<body>
<th:block layout:fragment="content">
    <div class="z-report-wrapper">
        <div class="z-option-button align-right">
            <button type="button" class="z-button secondary" th:text="PDF" th:onclick="download()"></button>
        </div>
        <div class="z-report">
            <div class="z-report-main">
                <div class="z-report-main-header align-center" th:text="${report.reportName}"></div>
                <div class="z-report-area">
                    <div class="z-drawing-board" id="reportContents">
                    </div>
                </div>
                <div class="z-report-main-footer flex-row justify-content-between">
                    <div>
                        <img class="z-img i-portal-notice pointer" th:src="@{/assets/media/icons/logo/icon_logo_print.svg}" width="152" height="26" alt="logo">
                    </div>
                    <div class="z-paging"></div>
                    <div class="align-right mr-4" id="report-information"></div>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA[*/
        const CHART_YEAR = 'Y';
        const CHART_MONTH = 'M';
        const CHART_DAY = 'D';
        const CHART_HOUR = 'H';
        const PIE_CHART = 'chart.pie';
        const STACKED_COLUMN_CHART = 'chart.stackedColumn';
        const STACKED_BAR_CHART = 'chart.stackedBar';
        const LINE_AND_COLUMN_CHART = 'chart.lineAndColumn';
        const BASIC_LINE_CHART = 'chart.basicLine';
        const ACTIVITY_GAUGE_CHART = 'chart.activityGauge';
        let chart = null;

        const report = /*[[${report}]]*/ null;

        function download() {
            html2pdf().from(document.querySelector('.z-report')).set({
                margin: 6,
                filename: report['reportName'] + '.pdf',
                html2canvas: { scale: 1 },
                jsPDF: {orientation: 'portrait', unit: 'mm', format: 'a4', compressPDF: true}
            }).save();
        }
        /*]]>*/
    </script>
    <script type="module">
        /*<![CDATA[*/
        window.onload = function() {
            // footer
            const userName = '[[${#authentication.details.userName}]]';
            const userEmail = '[[${#authentication.details.email}]]';
            const time = '[[${report.publishDt}]]';
            const reportInfo = document.getElementById('report-information');
            reportInfo.innerHTML = userName + ' [' + userEmail + ']<br>' + i18n.printFormat(time);

            // chart 그리기
            if (report['data'] !== undefined) {
                report['data'].forEach((item) => {
                    addChartContent(item);
                });
            }
        };

        function addChartContent(data) {
            let chartTarget = document.querySelector('#reportContents');
            let element =
                `<div class="z-chart-content">` +
                `<div class="z-title align-left">${data.chartName}</div>` +
                `<div class="z-chart" id="${data.chartId}_chart"></div>` +
                `</div>`;
            chartTarget.insertAdjacentHTML('beforeend', element);

            setChart(data.chartType, data.propertyJson, data.chartId + '_chart');
            parsedPropertyJson(data.chartConfig, data.propertyJson);
        }

        /** 하이차트 초기화 */
        function setChart(chartType, property, target) {
            chart = new ZChart(target, chartType, property);
        }

        /** chartConfig 파싱 진행 **/
        function parsedPropertyJson(chartConfig, property) {
            chart.parsedPropertyJson(chartConfig, property);
        }
        /*]]>*/
    </script>
</th:block>
</html>
