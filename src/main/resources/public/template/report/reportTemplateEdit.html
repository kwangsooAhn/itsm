<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/itsm/pageType/commonEditLayout}">
<head>
    <title th:text="${template != null} ? #{report.label.templateEdit} : #{report.label.templateRegister}"></title>
</head>
<th:block layout:fragment="pageHead">
    <script th:src="@{/assets/js/workflow/zWorkflowUtil.js}"></script>
</th:block>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{report.label.template}"></h1>
    <h6 class="description ml-2 pl-2" th:text="#{report.msg.editDescription}"></h6>
</div>
<div layout:fragment="pageEdit">
    <div class="z-edit-form flex-fill">
        <div class="flex-column z-edit-row">
            <label for="templateName">
                <span th:text="#{report.label.templateName}"></span>
                <span class="required"></span>
            </label>
            <input type="text" id="templateName" class="z-input" required="true" maxlength="100"
                   th:attr="data-validation-required-name=#{report.label.templateName}"
                   th:value="${template?.templateName}"/>
        </div>
        <div class="flex-column z-edit-row">
            <label for="templateDesc">
                <span th:text="#{report.label.description}"></span>
            </label>
            <textarea id="templateDesc" name="templateDesc" class="z-textarea textarea-scroll-wrapper"
                      maxlength="250" rows="5" th:text="${template?.templateDesc}"></textarea>
        </div>
        <div class="flex-column z-edit-row">
            <label for="reportName">
                <span th:text="#{report.label.reportName}"></span>
                <div class="z-help-tooltip">
                    <span class="z-icon i-tooltip"></span>
                    <div class="z-tooltip-contents">
                        <span th:utext="#{report.tooltip.reportName}"></span>
                    </div>
                </div>
            </label>
            <input type="text" id="reportName" class="z-input" maxlength="100"
                   th:value="${template?.reportName}"/>
        </div>
        <div class="flex-column z-edit-row">
            <label class="z-switch">
                <input type="checkbox" id="automatic" name="automatic"
                       th:checked="${template?.automatic == true}">
                <span></span>
                <span class="z-label" th:text="#{report.label.automatic}"></span>
            </label>
        </div>
        <div class="flex-column z-edit-row">
            <div class="under-bar">
                <label>
                    <span th:text="#{report.label.chart}"></span>
                </label>
            </div>
            <div id="details" class="template">
                <div class="flex-row justify-content-end">
                    <button type="button" class="z-button-icon extra" onclick="addChart()">
                        <span class="z-icon i-plus"></span>
                    </button>
                </div>
                <div id="chartList" class="chart"></div>
            </div>
        </div>
        <div class="flex-row justify-content-between z-edit-row">
            <div class="z-button-list">
                <a class="z-button secondary" href="/reports/template/search" th:text="#{common.btn.list}"></a>
            </div>
            <div class="z-button-list">
                <button class="z-button primary" th:if="${template == null}"
                        sec:authorize="hasAuthority('report.create')"
                        onclick="actionTemplate('post')" th:text="#{common.btn.register}"></button>
                <button class="z-button primary" th:if="${template?.templateId}"
                        sec:authorize="hasAuthority('report.update')"
                        onclick="actionTemplate('put')" th:text="#{common.btn.modify}"></button>
                <button class="z-button secondary" onclick="preview()" th:text="#{common.btn.preview}"></button>
                <button class="z-button secondary" th:if="${template?.templateId}"
                        sec:authorize="hasAuthority('report.delete')"
                        onclick="actionTemplate('delete')" th:text="#{common.btn.delete}"></button>
            </div>
        </div>
    </div>
</div>
</body>
<script layout:fragment="pageScript" th:inline="javascript">
    /*<![CDATA[*/
    const STATUS_SUCCESS = '0';
    const STATUS_ERROR_TEMPLATE_NAME_DUPLICATION = '1';
    const chartList = /*[[${chartList}]]*/ null;
    const data = /*[[${template}]]*/ null;
    window.onload = function () {
        if (data !== null) {
            data["charts"].forEach((item) => {
                addChart(item);
            })
        }

        OverlayScrollbars(document.querySelectorAll('.edit'), {className: 'scrollbar'});
        OverlayScrollbars(document.querySelectorAll('.textarea-scroll-wrapper'), {
            className: 'scrollbar',
            resize: 'vertical',
            sizeAutoCapable: true,
            textarea: {
                dynHeight: false,
                dynWidth: false,
                inheritedAttrs: "class"
            }
        });
    };

    // Chart 추가
    function addChart(data) {
        let target = document.querySelector('#chartList');
        let property = {};
        if (typeof data !== 'undefined' && data !== null) {
            property = data;
        }
        if (chartList != null) {
            const options = chartList.map(function (option) {
                return `<option value="${option.chartId}" ${property.chartId === option.chartId ? 'selected=\'true\'' : ''}>${aliceJs.filterXSS(option.chartName)}</option>`;
            }).join('');
            let rowId = ZWorkflowUtil.generateUUID();
            let rowElement =
                `<div class="flex-row mt-2">` +
                `<div class="flex-column col-11"><select name="chart" id="${rowId}_chart">${options}</select></div>` +
                `<div class="flex-column col-1"><button id="${rowId}_delete" type="button" class="z-button-icon extra"><span class="z-icon i-delete"></span></button></div>` +
                `</div>`;
            target.insertAdjacentHTML('beforeend', rowElement);

            const deleteBtn = document.getElementById(rowId + '_delete');
            deleteBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                this.parentElement.parentElement.remove();
            });
            aliceJs.initDesignedSelectTag();
        }
    }

    // 유효성 검사(중복 차트 체크)
    function isValid() {
        let isValid = true;
        let chartElement = document.querySelector('#chartList');
        let charts = [];
        chartElement.querySelectorAll('select[name=chart]').forEach((item) => {
            if (charts.includes(item.value)) {
                zAlert.warning(i18n.msg('report.msg.duplicateChart'));
                isValid = false;
            }
            if (item.value !== '') {
                charts.push(item.value);
            }
        });
        if (isValid && charts.length === 0) {
            zAlert.warning(i18n.msg('report.msg.emptyChart'));
            isValid = false;
        }
        return isValid;
    }

    // Action
    function actionTemplate(method) {
        if (method === 'post' || method === 'put') {
            if (isValidRequiredAll() && isValid()) {
                let data = {
                    templateId: '',
                    templateName: document.getElementById('templateName').value,
                    templateDesc: document.getElementById('templateDesc').value,
                    reportName: document.getElementById('reportName').value,
                    automatic: document.getElementById('automatic').checked
                }
                let url = '/rest/reports/template';
                if (method === 'put') {
                    url += '/' + /*[[${template?.templateId}]]*/'';
                    data.templateId = /*[[${template?.templateId}]]*/'';
                }
                let charts = [];
                let chartElement = document.getElementById('chartList');
                chartElement.querySelectorAll('select[name=chart]').forEach((item, index) => {
                    let chart = {
                        id: item.value,
                        order: index + 1
                    }
                    charts.push(chart);
                });
                data.charts = charts
                restSubmit(method, url, data);
            }
        } else if (method === 'delete') {
            zAlert.confirm(i18n.msg('common.msg.confirmDelete'), restSubmit, null, 'delete', '/rest/reports/template/' + /*[[${template?.templateId}]]*/'');
        }
    }

    // Ajax 통신
    function restSubmit(method, url, data) {
        const opt = {
            method: method,
            url: url,
            params: JSON.stringify(data),
            contentType: 'application/json',
            callbackFunc: function (response) {
                let result = JSON.parse(response.responseText);
                if (method === 'post' || method === 'put') {
                    switch (result.code) {
                        case STATUS_SUCCESS:
                            zAlert.success(i18n.msg('common.msg.save'), function () {
                                location.href = '/reports/template/search';
                            });
                            break;
                        case STATUS_ERROR_TEMPLATE_NAME_DUPLICATION:
                            zAlert.success(i18n.msg('report.msg.templateNameUsed'));
                            break;
                        default :
                            zAlert.danger(i18n.msg('common.msg.fail'));
                            break;
                    }
                } else if (method === 'delete') {
                    switch (result.code) {
                        case STATUS_SUCCESS:
                            zAlert.success(i18n.msg('common.msg.delete'), function () {
                                location.href = '/reports/template/search';
                            });
                            break;
                        default:
                            zAlert.danger(i18n.msg('common.msg.fail'));
                            break;
                    }
                }
            }
        };
        aliceJs.sendXhr(opt);
    }

    // 미리보기
    // sessionStorage 에 화면 데이터 저장
    function preview() {
        const chartElement = document.querySelector('#chartList');
        const charts = [];
        chartElement.querySelectorAll('select[name=chart]').forEach((item) => {
            if (item.value !== '') {
                charts.push({chartId: item.value});
            }
        });

        // 보고서 명이 존재하면 보고서명을 출력하고, 없으면 템플릿명을 출력한다.
        const reportNameTemp = isEmpty('reportName') ? document.getElementById('templateName').value :
            document.getElementById('reportName').value;

        const reportData = {
            reportId: '',
            reportName: reportNameTemp,
            reportDesc: document.querySelector('#templateDesc').value,
            charts: charts
        }
        sessionStorage.setItem("alice_report", JSON.stringify(reportData));
        window.open('/reports/template/preview', '_blank');
    }
    /*]]>*/
</script>
</html>
