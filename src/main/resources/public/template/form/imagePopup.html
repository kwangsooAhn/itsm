<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="form/formCore">
<head>
    <title th:text="#{form.component.image}"></title>
    <th:block layout:fragment="css">
        <link th:href="@{/assets/css/thumbnail.css}" rel="stylesheet"/>
    </th:block>
</head>
<body>
<th:block layout:fragment="content">
    <div>
        <div class="thumbnail-container"></div>
       <div class="btn-container">
            <div class="btn-check-wrapper">
                <button type="button" th:text="#{common.btn.check}" onclick="selectedImageSave();"></button>
                <button type="button" th:text="#{common.btn.close}" onclick="window.close();"></button>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="script">
    <script type="text/javascript" th:inline="javascript">
    window.onload = function() {

        // 썸네일 표시
        /*[# th:each="image : ${imageList}"]*/
        addThumbnail(/*[[${image}]]*/);
        /*[/]*/

        addThumbnailNodata();
        initSelectImage();
    };

    /**
     * 이미지 표시
     */
    function addThumbnail(image) {
        const thumbnailContainer = document.querySelector('.thumbnail-container');
        const thumbnailNodata = thumbnailContainer.querySelector('.thumbnail-nodata');
        if (thumbnailNodata) { thumbnailNodata.remove(); }
        let thumbnailTemplate = `
            <div class="thumbnail" onclick="selectImage(this);">
                <div class="thumbnail-img" style="background-image: url('data:image/${image.extension};base64,${image.data}');"></div>
                <div class="thumbnail-info">
                    <p class="thumbnail-info-text"><label>${image.name}</label></p>
                    <p class="thumbnail-info-text"><label>${image.width} X ${image.height} ${image.size}</label></p>
                </div>
                <div class="thumbnail-bottom">
                    <label>${i18n.userDateTime(image.updateDt)}</label>
                </div>
            </div>
        `;
        thumbnailContainer.insertAdjacentHTML('beforeend', thumbnailTemplate);
    }

    /**
     * 이미지가 존재하지 않을 경우 안내 문구 표시
     */
    function addThumbnailNodata() {
        const thumbnailCnt = document.querySelector('.thumbnail-container').querySelectorAll('.thumbnail').length;
        if (thumbnailCnt === 0) {
            let thumbnailNodataTemplate = `
                <div class="thumbnail-nodata">
                    <label>${i18n.get('common.msg.noData')}</label>
                </div>
            `;
            document.querySelector('.thumbnail-container').insertAdjacentHTML('beforeend', thumbnailNodataTemplate);
        }
    }

    /**
     *  이미지 선택 후 확인 버튼 클릭시 호출
     */
    function selectedImageSave() {
        // image 미선택 시 알림창 출력
        const selectedImage = document.querySelector('.thumbnail.selected');
        if (!selectedImage) {
            aliceJs.alert(i18n.get('form.msg.fileSelect'));
            return false;
        }
        if (window.opener && !window.opener.closed) {
            const pathGroupElem = window.opener.document.getElementById('properties-panel').querySelector('button').parentNode;
            if (pathGroupElem) {
                const pathElem = pathGroupElem.querySelector('input[type="text"]');
                if (pathElem) {
                    pathElem.value = 'file:///' + selectedImage.dataset.name;
                    pathElem.dispatchEvent(new Event('focusout'));
                    window.close();
                }
            }
        }
    }

    /**
     * 팝업 오픈시 이미지 선택 초기화
     */
    function initSelectImage() {
        if (!window.opener || window.opener.closed) { return false; }

        const componentId = '[(${componentId})]';
        let selectedPath = window.opener.document.getElementById(componentId).querySelector('img').dataset.path;
        const thumbnails = document.querySelectorAll('.thumbnail');
        thumbnails.forEach(thumbnail => {
            if (selectedPath.indexOf(thumbnail.dataset.name) > -1) {
                thumbnail.classList.add('selected');
            }
        });
    }

    /**
     * 이미지 선택
     */
    function selectImage(thumbnail) {
        const thumbnails = document.querySelectorAll('.thumbnail');
        for (let i = 0, len = thumbnails.length; i < len; i++) {
            thumbnails.item(i).classList.remove('selected');
        }
        thumbnail.classList.add('selected');
    }
    
    </script>
</th:block>
</html>
