<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8"/>
    <title>Main</title>
</head>
<body>

<div sec:authorize="isAuthenticated()">
    <!-- 로그아웃 -->
    <form th:action="@{/logout}" method="post">
        <div>
            <button id="btnLogout" type="submit">로그아웃</button>
        </div>
    </form>

    <div id="userMenus"></div>
    <div id="contents" style="border: 1px solid red"></div>
    <div id="layoutError" style="border: 1px solid red"></div>

    <br>
    <br>
    <br>

    <div>[ 사용자 정보 ]</div>
    <div>아이디 : <span sec:authentication="name"></span></div>
    <div>상세 :</div>

    <div>- 아이디: <span sec:authentication="details.userId"></span></div>
    <div>- 이메일: <span sec:authentication="details.email"></span></div>
    <div>- 로그인시도횟수: <span sec:authentication="details.tryLoginCount"></span></div>
    <div>- 사용여부: <span sec:authentication="details.useYn"></span></div>
    <div>- 만료일: <span sec:authentication="details.expiredDt"></span></div>

    <br>
    <br>

    <div>[ 소유 권한 ]
        <div th:each="grantedAuthority:${#authentication.details.grantedAuthories}">
            <div th:text="*{grantedAuthority.authority}"> Title</div>
        </div>
    </div>

    <br>
    <br>

    <div>[ 소유 메뉴 ]
        <div th:each="menu:${#authentication.details.menus}">
            메뉴명: <span th:text="#{*{menu.menuId}}"></span> (메뉴URL: <span th:text="*{menu.url}">xxx</span>)
        </div>
    </div>

    <br>
    <br>


    --- 테스트 데이터 ---
    <br>

    Message resource :
    <div th:text="#{service}"></div>
    <div th:text="#{service.request}"></div>


    <br>
    <br>

    <div sec:authorize="hasRole('ADMIN')">- "ROLE_ADMIN" 역할이 있을 경우 이 메시지가 보입니다.</div>
    <div sec:authorize="hasAuthority('BOARD_VIEW')">- "BOARD_VIEW" 권한이 있을 경우 이 메시지가 보입니다.</div>

    <br/>
    <br/>
    <div>ROLE / AUTH List</div>
    <span sec:authentication="authorities"></span>
    <br/>
    <br/>
</div>
<div sec:authorize="isAnonymous()">
    로그인이 필요합니다.
    <form th:action="@{/logout}" method="post">
        <label>
            <input type="submit" th:value="LOGIN"/>
        </label>
    </form>
</div>


<link rel="stylesheet" type="text/css" th:href="@{/assets/vendors/bootstrap-4.3.1-dist/css/bootstrap.css}"/>
<script th:src="@{/assets/vendors/jquery-3.4.0/jquery-3.4.0.js}"></script>
<script th:src="@{/assets/vendors/jquery-serialize-object/jquery.serializeObject.js}"></script>
<script th:src="@{/assets/vendors/bootstrap-4.3.1-dist/js/bootstrap.js}"></script>
<script th:src="@{/assets/js/aliceJs.js}"></script>
<script th:src="@{/assets/js/withoutJquery.js}"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', () => {

        /*<![CDATA[*/
        const menus = [[ ${#authentication.details.menus}]];
        menus.forEach(menu => {
            /*<![CDATA[*/
            const menuUrl = menu.url;
            const docDiv = document.createElement('div');
            docDiv.style.cursor = 'pointer';
            docDiv.innerText = menu.menuId + ' 메뉴로 이동하기 (' + menuUrl + ')';
            if (menuUrl !== '') {
                docDiv.addEventListener('click', function (e) {
                    const xhr = new XMLHttpRequest();
                    xhr.onreadystatechange = function () {
                        if (this.readyState === 4 && this.status === 200) {
                            const contents = document.getElementById('contents');
                            contents.innerHTML = this.responseText;
                            const myScripts = contents.getElementsByTagName("script");
                            if (myScripts.length > 0) {
                                Function(myScripts[0].innerHTML)();
                            }
                        } else if (this.readyState === 4 && this.status !== 200) {
                            aliceJs.xhrErrorResponse('layoutError', this.responseText);
                        } else {
                            console.log(this.readyState + ':' + this.status);
                        }

                    }
                    xhr.onerror = function () {
                        aliceJs.xhrErrorResponse('layoutError', this.responseText);
                    };
                    xhr.open('get', menuUrl, true);
                    xhr.send();
                });
            }
            document.getElementById('userMenus').appendChild(docDiv);
        });
        /*]]>*/

    })

</script>
</body>
</html>