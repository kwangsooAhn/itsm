<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorator="layout/defaultLayout">
<head>
    <title>공지사항 리스트</title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="container">
        <br />
        <form id="frm" method="post">
            <table class="table" border="1">
                <tr>
                    <th th:text="#{notice.title}"></th>
                    <td colspan="3"><input id="noticeTitle" name="noticeTitle" type="text" th:value="${notice?.noticeTitle}" maxlength="128"/></td>
                </tr>
                <tr>
                    <th th:text="#{notice.contents}"></th>
                    <td colspan="3"><textarea id="noticeContents" name="noticeContents" maxlength="2048" rows="7" style="width: 750px; resize: none;" th:text="${notice?.noticeContents}"></textarea></td>
                </tr>
                <tr>
                    <th th:text="#{common.label.attachFile}">첨부파일</th>
                    <td colspan="3">
                        <div id="dropZoneFiles"></div>
                        <div id="dropZoneUploadedFiles"></div>
                    </td>
                </tr>
                <tr>
                    <th th:text="#{notice.user}"></th>
                    <td><span sec:authentication="details.userName"></span></td>
                </tr>
                <tr>
                    <th th:text="#{notice.popUpNoticeSettings}"></th>
                    <td>
                        <div>
                            <label><input type="radio" id="popRadioBtUp" name="popYn" th:value="${notice?.popYn != null} ? ${notice.popYn} : true" checked="checked" onchange="setDisplay('popTab',true)" th:text="#{notice.set}"/></label>
                            <label><input type="radio" id="popRadioBtDown" name="popYn" th:value="${notice?.popYn != null} ? ${notice.popYn} : false" onchange="setDisplay('popTab',false)" th:text="#{notice.notSet}"/></label>
                        </div>
                    </td>
                    <th th:text="#{notice.topNoticeSettings}"></th>
                    <td>
                        <div>
                            <label><input type="radio" id="topRadioBtUp" name="topNoticeYn" th:value="${notice?.topNoticeYn != null} ? ${notice.topNoticeYn} : true" checked="checked" onchange="setDisplay('topNoticeTab',true)" th:text="#{notice.set}"/></label> 
                            <label><input type="radio" id="topRadioBtDown" name="topNoticeYn" th:value="${notice?.topNoticeYn != null} ? ${notice.topNoticeYn} : false" onchange="setDisplay('topNoticeTab',false)" th:text="#{notice.notSet}"/></label>
                        </div>
                    </td>
                </tr>
            </table>
            <div id="popTab">
                <table class="table" border="1">
                    <tr>
                        <th rowspan="4" th:text="#{notice.popUpNoticeSettingsInfo}"></th>
                        <th th:text="#{notice.height}"></th>
                        <th colspan="2"><input type="number" id="popHeight" name="popHeight" th:value="${notice?.popHeight} ? ${notice.popHeight} : 500" max="1000" maxlength="4" oninput="maxLengthCheck(this)" />px</th>
                    </tr>
                    <tr>
                        <th th:text="#{notice.width}"></th>
                        <td colspan="2"><input type="number" id="popWidth" name="popWidth" th:value="${notice?.popWidth} ? ${notice.popWidth} : 500" max="1000" maxlength="4" oninput="maxLengthCheck(this)" />px</td>
                    </tr>
                    <tr>
                        <th th:text="#{notice.strtDt}"></th>
                        <td colspan="2">
                            <div class="container">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <div class="input-group date" id="popStrtDtCal" data-target-input="nearest">
                                                <input type="text" id="popStrtDt" th:with="dateformat=${#authentication.details.timeFormat}"
                                                 th:value="${notice?.popStrtDt} ?  ${#temporals.format(notice.popStrtDt,dateformat)}:${#dates.format(#dates.createNow(), dateformat)}" 
                                                 name="popStrtDt" class="form-control datetimepicker-input" data-target="#popStrtDtCal" />
                                                <div class="input-group-append" data-target="#popStrtDtCal" data-toggle="datetimepicker">
                                                    <div class="input-group-text">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th th:text="#{notice.endDt}"></th>
                        <td colspan="2">
                            <div class="container">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <div class="input-group date" id="popEndDtCal" data-target-input="nearest">
                                                <input type="text" id="popEndDt" th:with="dateformat=${#authentication.details.timeFormat}"
                                                 th:value="${notice?.popEndDt} ?  ${#temporals.format(notice.popEndDt,dateformat)}:${addCurrentDate}" 
                                                 name="popEndDt" class="form-control datetimepicker-input" data-target="#popEndDtCal" />
                                                <div class="input-group-append" data-target="#popEndDtCal" data-toggle="datetimepicker">
                                                    <div class="input-group-text">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <div id="topNoticeTab">
                <table class="table" border="1">
                    <tr>
                        <th rowspan="4" th:text="#{notice.topNoticeSettingsInfo}"></th>
                        <th th:text="#{notice.strtDt}"></th>
                        <td colspan="2">
                            <div class="container">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <div class="input-group date" id="topNoticeStrtDtCal" data-target-input="nearest">
                                                <input type="text" id="topNoticeStrtDt" th:with="dateformat=${#authentication.details.timeFormat}"
                                                 th:value="${notice?.topNoticeStrtDt} ?  ${#temporals.format(notice.topNoticeStrtDt,dateformat)}:${#dates.format(#dates.createNow(),dateformat)}"
                                                 name="topNoticeStrtDt" class="form-control datetimepicker-input" data-target="#topNoticeStrtDtCal" />
                                                <div class="input-group-append" data-target="#topNoticeStrtDtCal" data-toggle="datetimepicker">
                                                    <div class="input-group-text">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th th:text="#{notice.endDt}"></th>
                        <td colspan="2">
                            <div class="container">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="form-group">
                                            <div class="input-group date" id="topNoticeEndDtCal"
                                                data-target-input="nearest">
                                                <input type="text" id="topNoticeEndDt" th:with="dateformat=${#authentication.details.timeFormat}"
                                                 th:value="${notice?.topNoticeEndDt} ?  ${#temporals.format(notice.topNoticeEndDt,dateformat)}:${addCurrentDate}" 
                                                 name="topNoticeEndDt" class="form-control datetimepicker-input" data-target="#topNoticeEndDtCal" />
                                                <div class="input-group-append" data-target="#topNoticeEndDtCal" data-toggle="datetimepicker">
                                                    <div class="input-group-text">
                                                        <i class="fa fa-calendar"></i>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
            <div style="float: right;">
                <button type="button" onclick="location.href='/notices/search'" th:text="#{notice.list}"></button>
                <button sec:authorize="hasAuthority('notice.create')" th:if="!${notice?.noticeNo}" type="button" id="insert" th:onclick="restSubmit('post',[[@{/rest/notices}]])" th:text="#{notice.regist}"></button>
                <button sec:authorize="hasAuthority('notice.update')" th:if="${notice?.noticeNo}" type="button" id="update" th:onclick="restSubmit('put',[[@{/rest/notices/{noticeNo}(noticeNo=${notice.noticeNo})}]])" th:text="#{notice.modifyCompleted}"></button>
            </div>
        </form>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script th:inline="javascript">
        /*<![CDATA[ */
        var format = /*[[${#authentication.details.timeFormat}]]*/;
        var lang = /*[[${#authentication.details.lang}]]*/;
        var formatArray = format.split(' ');
        var dateFormat = '';
        var timeFormat = '';
        window.addEventListener('load', function() {
            dateFormat =  formatArray[0].toUpperCase();
            if (formatArray.length === 2) {
                timeFormat = '24';
            } else if (formatArray.length === 3) {
                timeFormat = '12';
            }
            
            if (/*[[${notice?.noticeNo}]]*/ != null) {
                if (document.getElementsByName('popYn')[0].value === 'true') {
                    document.getElementById('popRadioBtUp').checked = true;
                    document.getElementById('popTab').style.display = '';
                    setDisplay('popTab',true)
                } else {
                    document.getElementById('popRadioBtDown').checked = true;
                    document.getElementById('popWidth').value = '';
                    document.getElementById('popHeight').value = '';
                    document.getElementById('popStrtDt').value = '';
                    document.getElementById('popEndDt').value = '';
                    document.getElementById('popTab').style.display = 'none';
                }

                if (document.getElementsByName('topNoticeYn')[0].value === 'true') {
                    document.getElementById('topRadioBtUp').checked = true;
                    document.getElementById('topNoticeTab').style.display = '';
                    setDisplay('topNoticeTab',true)
                } else {
                    document.getElementById('topRadioBtDown').checked = true;
                    document.getElementById('topNoticeStrtDt').value = '';
                    document.getElementById('topNoticeEndDt').value = '';
                    document.getElementById('topNoticeTab').style.display = 'none';
                }
            } else {
                document.getElementById('topRadioBtDown').checked = true;
                setDisplay('topNoticeTab', false);
                document.getElementById('popRadioBtDown').checked = true;
                setDisplay('popTab', false);
            }
            fileUploader.init({extra: {formId: 'frm', ownId: /*[[${notice?.noticeNo}]]*/''}});
        });

        function setDisplay(name, condition) {
            if (condition) {
                if (name === 'popTab') {
                    document.getElementById('popWidth').value = /*[[${notice?.popWidth} ? ${notice.popWidth} : 500]]*/;
                    document.getElementById('popHeight').value = /*[[${notice?.popHeight} ? ${notice.popHeight} : 500]]*/;
                    document.getElementById('popStrtDt').value = /*[[${notice?.popStrtDt} ?  ${#temporals.format(notice.popStrtDt,#authentication.details.timeFormat)}:${#dates.format(#dates.createNow(), #authentication.details.timeFormat)}]]*/;
                    document.getElementById('popEndDt').value = /*[[${notice?.popEndDt} ?  ${#temporals.format(notice.popEndDt,#authentication.details.timeFormat)}:${#temporals.format(addCurrentDate,#authentication.details.timeFormat)}]]*/;
                    dateTimePicker.initDateTimePicker('popStrtDt', dateFormat, timeFormat, lang);
                    dateTimePicker.initDateTimePicker('popEndDt', dateFormat, timeFormat, lang);
                    document.getElementsByName('popYn')[0].value = true;
                } else if (name === 'topNoticeTab') {
                    document.getElementById('topNoticeStrtDt').value = /*[[${notice?.topNoticeStrtDt} ?  ${#temporals.format(notice.topNoticeStrtDt,#authentication.details.timeFormat)}:${#dates.format(#dates.createNow(),#authentication.details.timeFormat)}]]*/;
                    document.getElementById('topNoticeEndDt').value = /*[[${notice?.topNoticeEndDt} ?  ${#temporals.format(notice.topNoticeEndDt,#authentication.details.timeFormat)}:${#temporals.format(addCurrentDate,#authentication.details.timeFormat)}]]*/;
                    document.getElementsByName('topNoticeYn')[0].value = true;
                    dateTimePicker.initDateTimePicker('topNoticeStrtDt', dateFormat, timeFormat, lang);
                    dateTimePicker.initDateTimePicker('topNoticeEndDt', dateFormat, timeFormat, lang);
                }
                document.getElementById(name).style.display = '';
            } else {
                if (name === 'popTab') {
                    document.getElementById('popWidth').value = '';
                    document.getElementById('popHeight').value = '';
                    document.getElementById('popStrtDt').value = '';
                    document.getElementById('popEndDt').value = '';
                    document.getElementsByName('popYn')[0].value = false;
                } else if (name === 'topNoticeTab') {
                    document.getElementById('topNoticeStrtDt').value = '';
                    document.getElementById('topNoticeEndDt').value = '';
                    document.getElementsByName('topNoticeYn')[0].value = false;
                }
                document.getElementById(name).style.display = 'none';
            }
        }

        // validation check
        function validation() {
            if (document.getElementById('noticeTitle').value === '') {
                alert('제목을 입력하세요.');
                return false;
            }
            if (document.getElementById('noticeContents').value === '') {
                alert('내용을 입력하세요.');
                return false;
            }
            if (document.getElementById('popRadioBtUp').checked) {
                if (document.getElementById('popHeight').value === '') {
                    alert('높이를 입력하세요.');
                    return false;
                }
                if (document.getElementById('popHeight').value > 1000 || document.getElementById('popHeight').value < 500 ) {
                    alert('높이는 500px부터 1000px 사이의 값만 입력 가능합니다.');
                    return false;
                }
                if (document.getElementById('popWidth').value === '') {
                    alert('넓이를 입력하세요');
                    return false;
                }
                if (document.getElementById('popWidth').value > 1000 || document.getElementById('popWidth').value < 500 ) {
                    alert('넓이는 500px부터 1000px 사이의 값만 입력 가능합니다.');
                    return false;
                }
                if (document.getElementById('popStrtDt').value === '') {
                    alert('팝업 시작일을 입력하세요.');
                    return false;
                }
                if (document.getElementById('popEndDt').value === '') {
                    alert('팝업 종료일을 입력하세요.');
                    return false;
                }
                if ((changeDateFormatYYYYMMDD(document.getElementById('popStrtDt').value,format) > changeDateFormatYYYYMMDD(document.getElementById('popEndDt').value,format)) 
                        || (changeDateFormatYYYYMMDD(document.getElementById('popStrtDt').value,format) === changeDateFormatYYYYMMDD(document.getElementById('popEndDt').value,format))) {
                    alert('팝업 알림 시작일이 종료일보다 크거나 같습니다.');
                    return false;
                }
            }

            if (document.getElementById('topRadioBtUp').checked) {
                if (document.getElementById('topNoticeStrtDt').value === '') {
                    alert('상단 공지 시작일을 입력하세요.');
                    return false;
                }
                if (document.getElementById('topNoticeEndDt').value === '') {
                    alert('상단 공지 종료일을 입력하세요.');
                    return false;
                }
                if ((changeDateFormatYYYYMMDD(document.getElementById('topNoticeStrtDt').value,format) > changeDateFormatYYYYMMDD(document.getElementById('topNoticeEndDt').value,format)) 
                        || (changeDateFormatYYYYMMDD(document.getElementById('topNoticeStrtDt').value,format) === changeDateFormatYYYYMMDD(document.getElementById('topNoticeEndDt').value,format))) {
                    alert('상단 공지 시작일이 종료일보다 크거나 같습니다.');
                    return false;
                }
            }
            return true;
        }

        function maxLengthCheck(object) {
            if (object.value.length > object.maxLength) {
                object.value = object.value.slice(0, object.maxLength);
            }
        }
        /* ]]> */
    </script>

    <script th:inline="javascript" th:if="!${notice?.noticeNo}">
        /*<![CDATA[ */
        function restSubmit(method, url, async) {
            if (!validation()) {
                return false;
            }

            const fileSeq = [];
            document.getElementsByName('fileSeq').forEach(elm => fileSeq.push(elm.value));

            const jsonData = JSON.stringify({
                noticeTitle: document.getElementById('noticeTitle').value,
                noticeContents: document.getElementById('noticeContents').value,
                popYn: document.getElementsByName('popYn')[0].value,
                popStrtDt: changeDateFormatYYYYMMDD(document.getElementById('popStrtDt').value,format),
                popEndDt: changeDateFormatYYYYMMDD(document.getElementById('popEndDt').value,format),
                popWidth: document.getElementById('popWidth').value,
                popHeight: document.getElementById('popHeight').value,
                topNoticeYn: document.getElementsByName('topNoticeYn')[0].value,
                topNoticeStrtDt: changeDateFormatYYYYMMDD(document.getElementById('topNoticeStrtDt').value,format),
                topNoticeEndDt: changeDateFormatYYYYMMDD(document.getElementById('topNoticeEndDt').value,format),
                fileSeq: fileSeq
            });

            const xmlhttp = createXmlHttpRequestObject(method, url, async);
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState === XMLHttpRequest.DONE) {
                    if (xmlhttp.status === 200) {
                        alert('글이 등록되었습니다.');
                        window.location = '/notices/search';
                    } else if (xmlhttp.status === 400) {
                        alert('There was an error 400');
                    } else {
                        alert('something else other than 200 was returned');
                    }
                }
            };
            xmlhttp.setRequestHeader('Content-Type', 'application/json');
            xmlhttp.send(jsonData);
        }
        /* ]]> */
    </script>

    <script th:inline="javascript" th:if="${notice?.noticeNo}">
        /*<![CDATA[ */
        function restSubmit(method, url, async) {
            const noticeNo = /*[[${notice.noticeNo}]]*/;

            if (!validation()) {
                return false;
            }

            const fileSeq = [];
            document.getElementsByName('fileSeq').forEach(elm => fileSeq.push(elm.value));
            const jsonData = JSON.stringify({
                noticeNo: noticeNo,
                noticeTitle: document.getElementById('noticeTitle').value,
                noticeContents: document.getElementById('noticeContents').value,
                popYn: document.getElementsByName('popYn')[0].value,
                popStrtDt: changeDateFormatYYYYMMDD(document.getElementById('popStrtDt').value,format),
                popEndDt: changeDateFormatYYYYMMDD(document.getElementById('popEndDt').value,format),
                popWidth: document.getElementById('popWidth').value,
                popHeight: document.getElementById('popHeight').value,
                topNoticeYn: document.getElementsByName('topNoticeYn')[0].value,
                topNoticeStrtDt: changeDateFormatYYYYMMDD(document.getElementById('topNoticeStrtDt').value,format),
                topNoticeEndDt: changeDateFormatYYYYMMDD(document.getElementById('topNoticeEndDt').value,format),
                fileSeq: fileSeq
            });

            const xmlhttp = createXmlHttpRequestObject(method, url, async);
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState === XMLHttpRequest.DONE) {
                    if (xmlhttp.status === 200) {
                        alert('글이 수정되었습니다.');
                        window.location = '/notices/search';
                    } else if (xmlhttp.status === 400) {
                        alert('There was an error 400');
                    } else {
                        alert('something else other than 200 was returned');
                    }
                }
            };
            xmlhttp.setRequestHeader('Content-Type', 'application/json');
            xmlhttp.send(jsonData);
        }
        /* ]]> */
    </script>
</th:block>
</html>