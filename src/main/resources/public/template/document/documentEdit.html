<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="#{help.document}"></title>
    <th:block th:replace="layout/fragments/commonHead"></th:block>
</head>
<body>
<div>
    <table style="width:95%; margin: 0 auto;">
        <colgroup>
            <col width="20%">
            <col width="*">
        </colgroup>
        <tr>
            <th class="required" th:text="#{document.label.type}"></th>
            <td>
                <select id="document_type" style="width:75%">
                    <option value="application-form" th:text="#{document.type.applicationForm}" />
                    <option value="workflow" th:text="#{document.type.workflow}" />
                </select>
            </td>
        </tr>
        <tr>
            <th class="required" th:text="#{document.label.name}"></th>
            <td>
                <input id="document_name" type="text" maxlength="50" required="required" style="width:100%"/>
            </td>
        </tr>
        <tr>
            <th th:text="#{document.label.description}"></th>
            <td>
                <textarea id="document_desc" maxlength="128" style="height:100px; width:100%"></textarea>
            </td>
        </tr>
        <tr>
            <th class="required" th:text="#{document.label.form}"></th>
            <td>
                <select id="document_form" style="width:75%" th:disabled="${documentId}">
                    <option th:each="form:${formList}"
                            th:id="${form?.id}"
                            th:value="${form?.id}"
                            th:text="#{${form?.name}}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <th class="required" th:text="#{document.label.process}"></th>
            <td>
                <select id="document_process" style="width:75%" th:disabled="${documentId}">
                    <option th:each="process:${processList}"
                            th:id="${process?.id}"
                            th:value="${process?.id}"
                            th:text="#{${process?.name}}" ></option>
                </select>
            </td>
        </tr>
        <tr>
            <th class="required" th:text="#{document.label.numberingRule}"></th>
            <td>
                <select id="document_numbering_rule" style="width:75%" th:disabled="${documentId}">
                    <option th:each="numberingRule:${numberingRuleList}"
                            th:id="${numberingRule.numberingId}"
                            th:value="${numberingRule.numberingId}"
                            th:text="#{${numberingRule.numberingName}}" ></option>
                </select>
            </td>
        </tr>
        <tr>
            <th th:text="#{document.label.status}"></th>
            <td>
                <select id="document_status" style="width:75%" th:disabled="!${documentId}">
                    <option th:each="status:${statusList}" th:value="${status.code}"
                            th:text="#{${status.code}}" th:selected="${status.code == 'document.status.use'}"></option>
                </select>
            </td>
        </tr>
        <tr>
            <th class="required"  th:text="#{document.label.businessFlowColor}"></th>
            <td>
                <div>
                    <input id="selected_color" name="selected_color" class="selected-color"/>
                    <input id="document_color" name="document_color" class="color"/>
                    <div id="document_colorPalette" name="document_colorPalette" class="color-palette"></div>
                </div>
            </td>
        </tr>
    </table>
</div>
<hr>
<div style="margin-top: 10px; text-align: center;">
    <button th:if="${documentId}" onclick="saveDocument('put')" th:text="#{common.btn.modify}"></button>
    <button th:unless="${documentId}" onclick="saveDocument('post')" th:text="#{common.btn.register}"></button>
    <button th:text="#{common.btn.close}" onclick="window.close();"></button>
</div>
</body>
<script th:src="@{/assets/js/util/validation-alice.js}"></script>
<script th:src="@{/assets/js/util/colorPalette-alice.js}"></script>
<script th:src="@{/assets/vendors/piklor/piklor.js}"></script>
<script type="text/javascript">
    function saveDocument(method) {
        if (emptyValidation()) {
            let documentType = document.getElementById('document_type');
            let documentForm = document.getElementById('document_form');
            let documentProcess = document.getElementById('document_process');
            let documentStatus = document.getElementById('document_status');
            let documentNumberingRule = document.getElementById('document_numbering_rule');
            const documentInfo = {
                documentType: documentType.options[documentType.selectedIndex].value,
                documentName: document.getElementById('document_name').value,
                documentDesc: document.getElementById('document_desc').value,
                formId: documentForm.options[documentForm.selectedIndex].value,
                processId: documentProcess.options[documentProcess.selectedIndex].value,
                documentNumberingRuleId: documentNumberingRule.options[documentNumberingRule.selectedIndex].value,
                documentStatus: documentStatus.options[documentStatus.selectedIndex].value,
                documentColor: document.getElementById('document_color').value
            };
            let parameter = '';
            if (method === 'put') {
                documentInfo.documentId = '[[${documentId}]]';
                parameter = '/[[${documentId}]]';
            }
            restSubmit(method, '/rest/documents-admin' + parameter, documentInfo);
        }
    }

    //빈 값 체크
    function emptyValidation() {
        if (isEmpty('document_name', 'document.msg.nameNotExist')) return false;
        if (isEmpty('document_color', 'document.msg.businessFlowColorNotExist')) return false;
        return true;
    }

    //REST API
    function restSubmit(method, url, data) {
        const opt = {
            method: method,
            url: url,
            params: JSON.stringify(data),
            contentType: 'application/json',
            callbackFunc: function(response) {
                let documentId = response.responseText;
                aliceJs.alert(i18n.get('common.msg.save'), function() {
                    opener.location.reload();
                    window.close();
                    const specs = "left=0, top=0, menubar=no, toolbar=no, location=no, status=no, titlebar=no,scrollbars=yes";
                    window.open('/documents-admin/' + documentId + '/display', '_blank', 'width=1500,height=920,' + specs);
                });
            }
        };
        aliceJs.sendXhr(opt);
    }

    //ColorPicker 초기화
    function initColorPicker() {
        let selectedColorBox = document.getElementById('selected_color');
        selectedColorBox.style.backgroundColor = 'rgb(0,0,0)';

        let elementObject = document.getElementById('document_color');
        elementObject.addEventListener('change', function() {
            if (this.value.trim() !== '' && !isValidRgb(this.id, function() {elementObject.focus();})) {
                this.value = '';
            }
            selectedColorBox.style.backgroundColor = this.value;
        });

        let colorPaletteBox = document.getElementById('document_colorPalette');
        colorPalette.initColorPalette(selectedColorBox, elementObject, colorPaletteBox, 'documentPaletteColors');
    }


    /**
     * Set Document Data.
     *
     * @param documentData
     */
    function setData(documentData) {
        document.getElementById('document_type').value = documentData.documentType;
        document.getElementById('document_name').value = documentData.documentName;
        document.getElementById('document_desc').value = documentData.documentDesc;
        document.getElementById('document_form').value = documentData.formId;
        document.getElementById('document_process').value = documentData.processId;
        document.getElementById('document_status').value = documentData.documentStatus;
        document.getElementById('document_numbering_rule').value = documentData.documentNumberingRuleId;
        document.getElementById('document_color').value = documentData.documentColor;
        document.getElementById('selected_color').style.backgroundColor = documentData.documentColor;
    }

    /*<![CDATA[*/
    window.onload = function() {
        initColorPicker();
        if ('[[${documentId}]]' !== '') {
            aliceJs.sendXhr({
                method: 'GET',
                url: '/rest/documents-admin/[[${documentId}]]',
                contentType: 'application/json; charset=utf-8',
                callbackFunc: function(xhr) {
                    setData(JSON.parse(xhr.responseText));
                }
            });
        }
    };
    /*]]>*/
</script>
</html>
