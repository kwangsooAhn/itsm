<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorator="layout/defaultLayout">
<head>
    <link th:href="@{/assets/css/thumbnail.css}" rel="stylesheet"/>
</head>
<body>
<th:block layout:fragment="content">
    <div class="contents">
        <div class="contents-title">
            <h1 th:text="#{image.label.list}"></h1>
            <span class="title-description" th:text="#{image.msg.description}"></span>
        </div>
        <div class="contents-body">
            <!--<div sec:authorize="hasAuthority('image.create')" class="inputWrapper">
                <label th:text="#{image.btn.upload}"/>
                <input type="file" class="fileInput" id="image-upload-file" accept=".png,.gif,.jpeg,.jpg" multiple/>
            </div>-->
            <div class="thumbnail-container"></div>
        </div>
    </div>
</th:block>
<th:block layout:fragment="pageScript">
    <script type="text/javascript" th:inline="javascript">
        window.onload = () => {
            // 썸네일 표시
            /*[# th:each="image : ${imageList}"]*/
            addThumbnail(/*[[${image}]]*/);
            /*[/]*/
            addThumbnailNodata();
        }

        function addThumbnail(image) {
            const thumbnailContainer = document.querySelector('.thumbnail-container');
            const thumbnailNodata = thumbnailContainer.querySelector('.thumbnail-nodata');
            let thumbnailTemplate = `
                <div class="thumbnail" onclick="selectImage(this);">
                    <div class="thumbnail-img" style="background-image: url('data:image/${image.extension};base64,${image.data}');"></div>
                    <div class="thumbnail-info">
                        <p class="thumbnail-info-text">
                            <label ondblclick="renameImage(this);">${image.name}</label>
                            <input type="text" class="fileName" />
                        </p>
                        <p class="thumbnail-info-text"><label>${image.size}</label></p>
                        <p class="thumbnail-info-text"><label>${image.width} X ${image.height}</label></p>
                    </div>
                    <div class="thumbnail-bottom">
                        <label>${i18n.userDateTime(image.updateDt)}</label>
                        <img src="" data-name="${image.name}" onclick="removeImage(this);"/>
                    </div>
                </div>
            `;
            if (thumbnailNodata) {
                thumbnailNodata.insertAdjacentHTML('beforebegin', thumbnailTemplate);
            } else {
                thumbnailContainer.insertAdjacentHTML('beforeend', thumbnailTemplate);
            }
        }

        function addThumbnailNodata() {
            const thumbnailCnt = document.querySelector('.thumbnail-container').querySelectorAll('.thumbnail-nodata').length;
            if (thumbnailCnt === 0) {
                let thumbnailNodataTemplate = `
                    <div class="thumbnail-nodata" onclick="document.getElementById('image-upload-file').click();">
                        <img src="" />
                        <p class="thumbnail-nodata-text">${i18n.get('image.label.upload')}</p>
                        <input type="file" class="fileInput" id="image-upload-file" accept=".png,.gif,.jpeg,.jpg" multiple onchange="uploadImage(this);"/>
                    </div>
                `;
                document.querySelector('.thumbnail-container').insertAdjacentHTML('beforeend', thumbnailNodataTemplate);
            }
        }

        function removeImage(imgObj) {
            aliceJs.confirm(i18n.get('common.msg.confirmDelete'), () => {
                aliceJs.sendXhr({
                    url: '/rest/images/' + imgObj.dataset.name,
                    method: 'delete',
                    contentType: 'application/json',
                    callbackFunc: xhr => {
                        if (xhr.responseText === 'true') {
                            document.querySelector('.thumbnail-container').removeChild(imgObj.parentNode.parentNode);
                        }
                    }
                });
            });
        }

        function renameImage(labelObj) {
            const name = labelObj.textContent.trim();
            labelObj.style.display = 'none';
            let inputObj = labelObj.parentNode.querySelector('input');
            let extension = name.split('.').pop();
            inputObj.value = name.split('.' + extension)[0];
            inputObj.style.display = 'block';
            let renameEventHandler = e => {
                e.preventDefault();
                e.target.removeEventListener('focusout', renameEventHandler);
                e.target.removeEventListener('keyup', renameEventHandler);
                inputObj.style.display = 'none';
                labelObj.style.display = 'block';
                let modifyName = labelObj.textContent;
                if (inputObj.value.trim() !== '') {
                    modifyName = inputObj.value.trim() + '.' + extension;
                }

                if (name !== modifyName) {
                    aliceJs.sendXhr({
                        url: '/rest/images',
                        method: 'put',
                        params: JSON.stringify({originName: name, modifyName: modifyName}),
                        contentType: 'application/json; charset=utf-8',
                        callbackFunc: xhr => {
                            if (xhr.responseText === 'true') {
                                labelObj.textContent = modifyName;
                                labelObj.parentNode.querySelector('img').dataset.name = modifyName;
                            } else {
                                aliceJs.alert(i18n.get("image.msg.failedRename"));
                            }
                        }
                    });
                }
            };
            inputObj.addEventListener('focusout', renameEventHandler, false);
            inputObj.addEventListener('keyup', e => {
                if (e.keyCode === 13) {
                    renameEventHandler(e);
                }
            }, false);
            inputObj.focus();
        }

        function selectImage(thumbnail) {
            const thumbnails = document.querySelectorAll('.thumbnail');
            for (let i = 0, len = thumbnails.length; i < len; i++) {
                thumbnails.item(i).classList.remove('selected');
            }
            thumbnail.classList.add('selected');
        }

        function uploadImage(fileObj) {
            let fileList = fileObj.files;
            if (fileList.length > 0) {
                const allowedExtensions = ['png', 'jpg', 'jpeg', 'gif'];
                let isExistNotAllowedExtension = false;
                for (let i = 0, len = fileList.length; i < len; i++) {
                    if (allowedExtensions.indexOf(fileList[i].name.split('.').pop().toLowerCase()) === -1) {
                        isExistNotAllowedExtension = true;
                    }
                }

                const uploadImage = function() {
                    let xhr = new XMLHttpRequest(),
                        formData = new FormData();
                    for (let i = 0, len = fileList.length; i < len; i++) {
                        formData.append('files', fileList[i]);
                    }
                    xhr.onreadystatechange = () => {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            let list = JSON.parse(xhr.responseText);
                            for (let i = 0, len = list.length; i < len; i++) {
                                addThumbnail(list[i]);
                            }
                        }
                    }
                    xhr.open('POST', '/rest/images', true);
                    xhr.send(formData);
                    document.getElementById('image-upload-file').value = '';
                }

                if (isExistNotAllowedExtension) {
                    aliceJs.confirm(
                        i18n.get('image.msg.existNotAllowedExtension'),
                        uploadImage, // OK 시 업로드
                        () => document.getElementById('image-upload-file').value = ''  // CANCEL 시 file object 값 비움 처리
                    );
                } else {
                    uploadImage();
                }

            }
        }
    </script>
</th:block>
</body>
</html>
