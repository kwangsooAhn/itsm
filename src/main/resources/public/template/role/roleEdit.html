<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/itsm/pageType/commonEditLayout}">
<head>
    <title th:text="#{role.label.role}"></title>
</head>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{role.label.role}"></h1>
    <h6 class="description ml-2 pl-2" th:text="#{role.msg.editDescription}"></h6>
</div>
<div layout:fragment="pageEdit">
    <div class="z-edit-form flex-fill">
        <div class="z-edit-row flex-column">
            <label th:text="#{role.label.id}" class="required"></label>
            <input type="text" class="z-input" id="txtRoleId" name="txtRoleId" maxlength="100"
                   th:value="${role?.roleId}"/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{role.label.name}" class="required"></label>
            <input type="text" class="z-input" id="txtRoleName" name="txtRoleName" maxlength="100"
                   th:value="${role?.roleName}"/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{role.label.desc}"></label>
            <textarea id="txtRoleDesc" name="txtRoleDesc" maxlength="200" rows="7"
                      class="z-textarea textarea-scroll-wrapper" th:text="${role?.roleDesc}"></textarea>
        </div>
        <div class="z-edit-row flex-column">
            <div class="flex-row">
                <div class="flex-row">
                    <label th:text="#{role.label.auth}" class="required"></label>
                </div>
                <div class="ml-auto">
                    <label class="z-checkbox z-checkbox-all p1-1">
                        <input type="checkbox" id="selectAll" name="selectAll" onclick="selectAll()"/>
                        <span></span>
                        <span class="z-label" th:text="#{role.btn.selectAll}"/>
                    </label>
                </div>
            </div>
            <div class="z-checkbox-list">
                <ul>
                    <li class="text-ellipsis" th:each="auth : ${authList}">
                        <label class="z-checkbox" th:for="${auth?.authId}" tabindex="0">
                            <input type="checkbox" name="roleAuth" th:id="${auth?.authId}" th:value="${auth?.authName}"
                                   th:checked="${auth?.authDesc == 'checked'}">
                            <span></span>
                            <span class="z-label" th:text="${auth?.authName}"></span>
                        </label>
                    </li>
                </ul>
            </div>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{common.label.createUser}"></label>
            <input type="text" class="z-input" id="spanCreateUserKey" name="spanCreateUserKey"
                   th:value="${role?.createUserName}" disabled/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{common.label.createDate}"></label>
            <input type="text" class="z-input" id="spanCreateDt" name="spanCreateDt" th:value="${role?.createDt}"
                   disabled/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{common.label.updateUser}"></label>
            <input type="text" class="z-input" id="spanUpdateUserKey" name="spanUpdateUserKey"
                   th:value="${role?.updateUserName}" disabled/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{common.label.updateDate}"></label>
            <input type="text" class="z-input" id="spanUpdateDt" name="spanUpdateDt" th:value="${role?.updateDt}"
                   disabled/>
        </div>
        <div class="z-edit-row flex-column">
            <label th:text="#{role.label.referenceCount}"></label>
            <input type="text" class="z-input" id="userRoleMapCount" name="userRoleMapCount"
                   th:value="${role?.userRoleMapCount}" disabled/>
        </div>
    </div>
    <div class="flex-row justify-content-between z-edit-row">
        <div class="z-button-list">
            <a class="z-button secondary" href="/roles/search" th:text="#{common.btn.list}"></a>
        </div>
        <div class="z-button-list">
            <button type="button" class="z-button primary" sec:authorize="hasAuthority('role.create')"
                    th:if="!${role?.roleId}" id="btnRegist"
                    name="btnRegist"
                    th:onclick="|javascript:onSave('post')|" th:text="#{common.btn.register}"></button>
            <button type="button" class="z-button primary" sec:authorize="hasAuthority('role.update')"
                    th:if="${role?.roleId}" id="btnUpdate"
                    name="btnUpdate"
                    th:onclick="|javascript:onSave('put')|" th:text="#{common.btn.modify}"></button>
            <button type="button" class="z-button secondary" sec:authorize="hasAuthority('role.delete')"
                    th:if="${role?.roleId}" id="btnDelete"
                    name="btnDelete"
                    th:onclick="|javascript:zAlert.confirm(i18n.msg('common.msg.confirmDelete'), onDelete)|"
                    th:text="#{common.btn.delete}"></button>
        </div>
    </div>
</div>
</body>
<script layout:fragment="pageScript" type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    window.onload = function () {
        OverlayScrollbars(document.querySelector('.z-page-content'), {className: 'scrollbar'});
        OverlayScrollbars(document.querySelector('.role-content-edit'), {className: 'scrollbar'});
        Array.prototype.forEach.call(document.querySelectorAll('.z-checkbox-list'), function (target) {
            OverlayScrollbars(target, {className: 'inner-scrollbar'});
        });

        if (document.getElementById('txtRoleId').value) {
            document.getElementById('txtRoleId').setAttribute('disabled', '');
            const opt = {
                method: 'get',
                url: '/rest/roles/' + document.getElementById('txtRoleId').value,
                showProgressbar: false,
                callbackFunc: function (response) {
                    let responseJson = JSON.parse(response.responseText);
                    let arrAuthList = responseJson.arrAuthList;
                    Array.prototype.forEach.call(document.querySelectorAll('input[name=roleAuth]'), function (roleAuth) {
                        roleAuth.checked = false;
                        for (let i = 0; i < arrAuthList.length; i++) {
                            if (roleAuth.id === arrAuthList[i].authId) {
                                roleAuth.checked = true;
                            }
                        }
                    });
                    disabledButton(responseJson.userRoleMapCount);
                    Array.prototype.forEach.call(document.querySelectorAll('.z-checkbox-list'), function (target) {
                        OverlayScrollbars(target, {
                            className: 'inner-scrollbar',
                            callbacks: {
                                onInitialized: function () {
                                    const verticalScrollTrack = document.querySelector('.z-checkbox-list> .os-scrollbar-vertical');
                                    verticalScrollTrack.classList.add('right', 'padding');
                                }
                            }
                        });
                    });
                    OverlayScrollbars(document.querySelector('#txtRoleDesc'), {
                        className: 'scrollbar',
                        resize: 'vertical',
                        sizeAutoCapable: true,
                        textarea: {
                            dynHeight: false,
                            dynWidth: false,
                            inheritedAttrs: "class"
                        }
                    });
                    document.getElementById('spanCreateDt').value = i18n.userDateTime(document.getElementById('spanCreateDt').value)
                    document.getElementById('spanUpdateDt').value = i18n.userDateTime(document.getElementById('spanUpdateDt').value)
                },
            };
            aliceJs.sendXhr(opt);
        }
    }

    /*등록, 수정 버튼*/
    function onSave(flag) {
        if (isEmpty('txtRoleId', 'role.msg.enterRoleId')) return;
        if (isEmpty('txtRoleName', 'role.msg.enterRoleName')) return;

        let roleIds = [];
        let roleNames = [];
        let validList = document.querySelectorAll('td[name=roleName]');
        for (let i = 0; i < validList.length; i++) {
            roleIds.push(validList[i].id);
            roleNames.push(validList[i].textContent);
        }

        if (flag === 'post') {
            for (let i = 0; i < roleIds.length; i++) {
                if (document.getElementById('txtRoleId').value === roleIds[i]) {
                    zAlert.warning([[#{role.msg.duplicateRoleId}]]);
                    return;
                }
            }
            for (let i = 0; i < roleNames.length; i++) {
                if (document.getElementById('txtRoleName').value === roleNames[i]) {
                    zAlert.warning([[#{role.msg.duplicateRoleName}]]);
                    return;
                }
            }
        }

        //저장 데이터 수집
        let obj = {};
        obj.roleId = document.getElementById('txtRoleId').value;    //역할 아이디
        obj.roleName = document.getElementById('txtRoleName').value;//역할 명
        obj.roleDesc = document.getElementById('txtRoleDesc').value; //역할 설명
        let arrAuthId = [];                                         //역할 권한
        Array.prototype.forEach.call(document.querySelectorAll('input[name=roleAuth]:checked'), function (item) {
            arrAuthId.push(item.id);
        });

        if (arrAuthId.length === 0) {
            zAlert.warning([[#{role.msg.selectAuth}]]);
            return;
        }

        obj.arrAuthId = arrAuthId;
        let strUrl = '/rest/roles';
        if (flag !== 'post') {
            strUrl += '/' + document.getElementById('txtRoleId').value;
        }
        const opt = {
            method: flag,
            url: strUrl,
            params: JSON.stringify(obj),
            contentType: 'application/json',
            callbackFunc: function () {
                zAlert.success([[#{common.msg.save}]], function () {
                    window.location.href = '/roles/search';
                });
            }
        };
        aliceJs.sendXhr(opt);
    }

    /** 삭제 버튼  */
    function onDelete() {
        const opt = {
            method: 'delete',
            url: '/rest/roles/' + encodeURIComponent(document.getElementById('txtRoleId').value),
            callbackFunc: function (response) {
                switch (response.responseText) {
                    case "true":
                        zAlert.success([[#{common.msg.delete}]], function () {
                            window.location.href = '/roles/search';
                        });
                        break;
                    case "false":
                        zAlert.danger(i18n.msg('common.label.delete') + i18n.msg('common.label.blank') + i18n.msg('common.msg.fail'));
                        break;
                    default :
                        zAlert.danger([[#{common.msg.fail}]]);
                        break;
                }
            }
        };
        aliceJs.sendXhr(opt);
    }

    /** 삭제 버튼 활성, 비활성화 */
    function disabledButton(count) {
        let btn = document.getElementById('btnDelete');
        if (count !== 0) {
            btn.disabled = 'disabled';
        } else {
            btn.disabled = false;
        }
    }

    function selectAll() {
        let checkFlag = document.getElementById('selectAll').checked;
        let roleAuths = document.getElementsByName('roleAuth');
        if (checkFlag === false) {
            for (let i = 0; i < roleAuths.length; i++) {
                roleAuths[i].checked = false;
            }
        } else {
            for (let i = 0; i < roleAuths.length; i++) {
                roleAuths[i].checked = true;
            }
        }
    }

    /*]]>*/
</script>
</html>
