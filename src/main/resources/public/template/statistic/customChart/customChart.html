<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/itsm/pageType/commonEditLayout}">
<head>
    <title th:text="${chart != null} ? #{chart.label.edit} : #{chart.label.register}"></title>
</head>
<th:block layout:fragment="pageHead">
    <script th:src="@{/assets/vendors/tagify/tagify.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/highcharts.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/highcharts-more.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/modules/no-data-to-display.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/modules/exporting.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/modules/solid-gauge.js}"></script>
    <script th:src="@{/assets/vendors/highCharts/plugin/pattern-fill-v2.js}"></script>
</th:block>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="${chart != null} ? #{chart.label.edit} : #{chart.label.register}"></h1>
    <h6 class="description ml-2 pl-4" th:text="#{chart.msg.searchDescription}"></h6>
</div>
<div layout:fragment="pageEdit">
    <div class="z-edit-form flex-fill">
        <div class="flex-column z-edit-row">
            <h4 class="sub-title under-bar bold" th:text="#{common.label.preview}"></h4>
        </div>
        <div class="flex-column z-edit-row">
            <div id="container" class="flex-row flex-wrap z-chart-content-view"></div>
        </div>
        <form id="frm" method="post">
            <div class="flex-column z-edit-row">
                <h4 class="sub-title under-bar bold" th:text="#{chart.label.chartSetting}"></h4>
            </div>
            <div class="flex-row">
                <div class="flex-column z-edit-row col-4">
                    <label class="field-label" th:text="#{chart.label.type}"></label>
                    <select id="typeSelectBox" name="typeSelectBox" onchange="changeChartType(this.value, false)" th:classappend="${view ? 'readonly' : ''}">
                        <option th:each="type:${code.type}" th:value="${type.codeValue}"
                                th:text="${type.codeName}" th:selected="${type.codeValue} == ${chart?.chartType}"></option>
                    </select>
                </div>
                <div class="flex-column z-edit-row col-6 pl-4">
                    <label class="field-label required" th:text="#{chart.label.name}"></label>
                    <input type="text" id="chartName" name="chartName" class="z-input" th:value="${chart?.chartName}"
                           maxlength="100" th:readonly="${view}" />
                </div>
            </div>
            <div class="flex-column z-edit-row col-10">
                <label class="field-label" th:text="#{chart.label.description}"></label>
                <textarea id="chartDesc" name="chartDesc" class="z-textarea textarea-scroll-wrapper"
                                                         rows="2" maxlength="128" th:text="${chart?.chartDesc}" th:readonly="${view}"></textarea>
            </div>
            <div class="flex-row">
                <div class="flex-column z-edit-row col-3" id="operation">
                    <!--/* 연산 */-->
                    <label class="field-label" th:text="#{chart.label.operation}"></label>
                    <select id="operationSelectBox" name="operationSelectBox" th:classappend="${view ? 'readonly' : ''}">
                        <option th:each="operation:${code.operation}"
                                th:if="${chart?.chartType} != 'chart.pie' or ( ${chart?.chartType} == 'chart.pie' and ${operation.codeValue} == 'count')"
                                th:value="${operation.codeValue}" th:text="${operation.codeName}"
                                th:selected="${operation.codeValue} == ${chart?.chartConfig?.operation}"></option>
                    </select>
                </div>
                <div class="flex-column z-edit-row col-3 pl-4" id="periodUnit">
                    <!--/* 간격 */-->
                    <label id="periodUnitLabel" class="field-label required" th:text="#{chart.label.periodUnit}"></label>
                    <select id="periodUnitSelectBox" name="periodUnitSelectBox" th:classappend="${view ? 'readonly' : ''}">
                        <option th:each="unit:${code.unit}" th:value="${unit.codeValue}"
                                th:text="${unit.codeName}"
                                th:selected="${unit.codeValue} == ${chart?.chartConfig?.periodUnit}"></option>
                    </select>
                </div>
            </div>
            <div class="flex-column z-edit-row col-3" id="targetStatus">
                <!--/* 대상 문서 상태 */-->
                <label id="targetStatusLabel" class="field-label required" th:text="#{chart.label.documentStatus}"></label>
                <select id="targetStatusSelectBox" name="targetStatusSelectBox" th:classappend="${view ? 'readonly' : ''}">
                    <option th:each="documentStatus:${code.documentStatus}" th:value="${documentStatus.codeValue}"
                            th:text="${documentStatus.codeName}"
                            th:selected="${documentStatus.codeValue} == ${chart?.chartConfig?.documentStatus}"></option>
                </select>
            </div>
            <div class="z-edit-row">
                <div class="flex-row">
                    <!--/* 기간 */-->
                    <div class="flex-column col-3">
                        <label class="field-label required" th:text="#{chart.label.duration}"></label>
                        <div>
                            <select id="rangeType" name="rangeType" onchange="changeRangeType(this.value, false)" th:classappend="${view ? 'readonly' : ''}">
                                <option th:each="unit:${code.range}" th:value="${unit.codeValue}"
                                        th:text="${unit.codeName}"
                                        th:selected="${unit.codeValue} == ${chart?.chartConfig?.range?.type}"></option>
                            </select>
                        </div>
                    </div>
                    <!--/* 기간 수동 설정 시 날짜 간격 입력 */-->
                    <div id="rangeDate" class="flex-row">
                        <div class="flex-column col-3 pl-4">
                            <label class="field-label required" th:text="#{common.label.startDate}"></label>
                            <div>
                                <input type="text" class="z-input i-date-picker search-date" id="rangeFromDt"
                                       name="rangeFromDt" th:value="${chart?.chartConfig?.range?.from}" th:readonly="${view}" />
                            </div>
                        </div>
                        <div class="flex-column col-3 pl-4">
                            <label class="field-label required" th:text="#{common.label.endDate}"></label>
                            <div>
                                <input type="text" class="z-input i-date-picker search-date" id="rangeToDt"
                                       name="rangeToDt" th:value="${chart?.chartConfig?.range?.to}" th:readonly="${view}" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex-column z-edit-row">
                <!--/* 차트 대상 태그 */-->
                <div class="flex-column col-6">
                    <label>
                        <span class="field-label required" th:text="#{chart.label.targetTags}"></span>
                        <div class="z-help-tooltip">
                            <span class="z-icon i-tooltip"></span>
                            <div class="z-tooltip-contents right">
                                <span th:utext="#{chart.tooltip.targetTags}"></span>
                            </div>
                        </div>
                    </label>
                    <input type="text" id="targetTags" name="targetTags" class="col-pct-12"
                           th:value="${chart?.tags}" th:readonly="${view}" th:classappend="${view}?'':'z-input'">
                </div>
                <!--/* 차트 조건식 */-->
                <div class="flex-column col-6">
                    <label>
                        <span class="field-label" th:text="#{chart.label.condition}"></span>
                        <div class="z-help-tooltip">
                            <span class="z-icon i-tooltip"></span>
                            <div class="z-tooltip-contents right">
                                <span th:utext="#{chart.tooltip.condition}"></span>
                            </div>
                        </div>
                    </label>
                    <input type="text" id="condition" name="condition" class="col-pct-12"
                           th:value="${chart?.chartConfig?.condition}"
                           th:readonly="${view}" th:classappend="${view}?'':'z-input'">
                </div>
            </div>
            <div class="flex-row justify-content-between z-edit-row">
                <div class="z-button-list">
                    <a class="z-button secondary" href="/statistics/customChart/search" th:text="#{common.btn.list}"></a>
                </div>
                <div class="z-button-list" th:if="!${view}" sec:authorize="hasAuthority('report.manage')">
                    <button type="button" th:if="!${chart?.chartId}" id="insert" class="z-button primary"
                            onclick="saveChart('POST')" th:text="#{common.btn.register}">
                    </button>
                    <button type="button" th:if="${chart?.chartId}" id="update" class="z-button primary"
                            onclick="saveChart('PUT')" th:text="#{common.btn.modify}">
                    </button>
                    <button type="button" id="preview" class="z-button secondary"
                            onclick="previewChart()" th:text="#{common.btn.preview}">
                    </button>
                    <button type="button" th:if="${chart?.chartId}" id="delete" class="z-button danger"
                            onclick="deleteChart()" th:text="#{common.btn.delete}">
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
<th:block layout:fragment="pageScript">
    <script th:inline="javascript" type="text/javascript">
        const chartId = [[${chart?.chartId}]];
        const STATUS_SUCCESS = '0';
        // 차트 종류
        const PIE_CHART = 'chart.pie';
        const STACKED_COLUMN_CHART = 'chart.stackedColumn';
        const STACKED_BAR_CHART = 'chart.stackedBar';
        const BASIC_LINE_CHART = 'chart.basicLine';
        // 차트 기간
        const RANGE_BETWEEN = 'chart.range.between';
        const RANGE_LAST_MONTH = 'chart.range.last.month';
        const RANGE_LAST_DAY = 'chart.range.last.day';
        const RANGE_ALL = 'chart.range.all';
        // 차트 간격
        const PERIOD_YEAR = 'Y';
        const PERIOD_MONTH = 'M';
        const PERIOD_DAY = 'D';
        const PERIOD_HOUR = 'H';
        const MAX_PERIOD_RANGE = 3; // 시간 단위일경우 최대 간격 (일단위)

        window.onload = function () {
            OverlayScrollbars(document.querySelector('.z-page-content'), { className: 'scrollbar' });

            // 기간 조회 날짜 데이터 조기화
            const fromDtElement = document.getElementById('rangeFromDt');
            fromDtElement.setAttribute('data-userDateTime', i18n.userDateTime(fromDtElement.value));
            fromDtElement.value = i18n.userDate(fromDtElement.value);

            const toDtElement = document.getElementById('rangeToDt');
            toDtElement.setAttribute('data-userDateTime', i18n.userDateTime(toDtElement.value));
            toDtElement.value = i18n.userDate(toDtElement.value);
            // 한달 전 ~ 현재 기간으로 설정
            if (!fromDtElement.value || !toDtElement.value) {
                fromDtElement.value = i18n.getDate({ months: -1 });
                fromDtElement.setAttribute('data-userDateTime', i18n.getStartOfDateTime({ months: -1 }, 'month'));
                toDtElement.value = i18n.getDate();
                toDtElement.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ days: 0 }, 'day'));
            }
            zDateTimePicker.initDatePicker(fromDtElement, changeDatePicker);
            zDateTimePicker.initDatePicker(toDtElement, changeDatePicker);

            // 기간 설정에 따른 화면 변경
            changeRangeType(document.getElementById('rangeType').value, true);

            // 태그 초기화
            new zTag(document.querySelector('input[name=targetTags]'), {
                suggestion: false,
                realtime: false,
                tagType: 'chart',
                targetId: chartId
            });

            // select box 디자인
            aliceJs.initDesignedSelectTag();

            // 차트 타입에 따른 화면 변경
            changeChartType(document.getElementById('typeSelectBox').value, true);

            // chart 초기화
            zChartManager.load(getChartData());
            if (chartId !== null) {
                // 데이터 업데이트
                zChartManager.update([[${chart?.chartData}]]);
            }
        };
        /**
         * DatePicker 변경시 호출
         */
        function changeDatePicker(element, picker) {
            if (typeof picker === 'undefined') { return false; }

            if (element.id === 'rangeFromDt') {
                const toDtValue = document.getElementById('rangeToDt').value;
                element.setAttribute('data-userDateTime', i18n.userDateTime(i18n.systemDate(element.value)));
                if (!i18n.compareSystemDate(element.value, toDtValue)) {
                    zAlert.warning(i18n.msg('common.msg.selectBeforeDate', toDtValue), function () {
                        element.value = i18n.getDate({ months: -1 });
                        element.setAttribute('data-userDateTime', i18n.getStartOfDateTime({ months: -1 }, 'month'));
                        picker.open();
                    });
                }
            } else {
                const fromDtValue = document.getElementById('rangeFromDt').value;
                element.setAttribute('data-userDateTime', i18n.userDateTime(i18n.systemDate(element.value, { hours: 23, minute: 59 })));
                if (!i18n.compareSystemDate(fromDtValue, element.value)) {
                    zAlert.warning(i18n.msg('common.msg.selectAfterDate', fromDtValue), function () {
                        element.value = i18n.getDate();
                        element.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ days: 0 }, 'day'));
                        picker.open();
                    });
                }
            }
        }

        /**
         * chart preview
         */
        function previewChart() {
            if (!isValidation()) { return false; }

            const previewData = getChartData();
            // 서버에 전달시 from , to 날짜 데이터 포맷 변경
            aliceJs.fetchJson('/rest/statistics/customChart/' + chartId + '/preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(previewData),
                showProgressbar: true
            }).then((data) => {
                if (typeof data.chartConfig === 'undefined') { return false; }
                // 기존 차트를 지우고 새로 그려준다.
                zChartManager.destroy();
                // 차트 초기화
                zChartManager.load(data);

                // 차트 데이터 업데이트
                if (typeof data.chartConfig === 'undefined') { return false; }
                zChartManager.update(data.chartData);
            });
        }

        /**
         * chart 저장 / 수정
         */
        function saveChart(method) {
            if (!isValidation()) { return false; }

            const saveData = getChartData();
            const url = '/rest/statistics/customChart' + (chartId !== null ? '/' + chartId : '');
            aliceJs.fetchText(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(saveData)
            }).then((rtn) => {
                switch (rtn) {
                    case STATUS_SUCCESS:
                        zAlert.success(i18n.msg('common.msg.save'), function () {
                            location.href = '/statistics/customChart/search';
                        });
                        break;
                    default:
                        zAlert.danger(i18n.msg('common.msg.fail'));
                        break;
                }
            });
        }

        /**
         * chart 삭제
         */
        function deleteChart() {
            zAlert.confirm(i18n.msg('common.msg.confirmDelete'),  () => {
                aliceJs.fetchText('/rest/statistics/customChart/' + chartId, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then((rtn) => {
                    switch (rtn) {
                        case STATUS_SUCCESS:
                            zAlert.success(/*[[#{common.msg.delete}]]*/'', function () {
                                window.location.href = '/statistics/customChart/search';
                            });
                            break;
                        default:
                            zAlert.danger(i18n.msg('common.msg.fail'));
                            break;
                    }
                });
            });
        }

        /**
         * 화면 필수값 검증
         */
        function isValidation() {
            if (isEmpty('chartName', 'chart.msg.enterChartName')) {
                return false;
            }
            if (isEmpty('targetTags', 'chart.msg.enterTargetTags')) {
                return false;
            }
            // 간격이 '시간' 단위일때, 시작일자와 종료일자의 차이가 3일 이상일 경우 경고창 표시
            if (document.getElementById('periodUnitSelectBox').value === PERIOD_HOUR) {
                const fromDtValue = document.getElementById('rangeFromDt').value;
                const validToDtValue =  i18n.userDate(i18n.systemDate(fromDtValue, { days : MAX_PERIOD_RANGE }));
                const toDtValue = document.getElementById('rangeToDt').value;
                if (!i18n.compareSystemDate(toDtValue, validToDtValue)) {
                    zAlert.warning(i18n.msg('chart.msg.maxPeriodUnitRange', MAX_PERIOD_RANGE));
                    return false;
                }
            }
            return true;
        }

        /**
         * 타입에 따른 연산 설정 변경
         * @param type 차트 타입
         * @param value 기존 선택된 값
         */
        function setOperationOption(type, value) {
            // 초기화
            let operationSelectBox = document.getElementById('operationSelectBox');
            operationSelectBox.options.length = 0;

            // 라인차트, stacked 컬럼 / 바 차트는 '카운트', '평균', '퍼센트' 사용
            // 파이차트는 '카운트' 만 사용
            let options = (type === PIE_CHART) ? ['count'] : ['count', 'average', 'percent'];
            for (let i = 0; i < options.length; i++) {
                const option = document.createElement('option');
                option.text = i18n.msg('chart.option.text.' + options[i]);
                option.value = i18n.msg('chart.option.value.' + options[i]);
                if (option.value === value) {
                    option.selected = true;
                }
                operationSelectBox.append(option);
            }
        }

        /**
         * 차트 타입 변경시 화면 변경
         * @param type 차트 타입
         * @param flag 초기화시 true, 사용자 변경시 false
         */
        function changeChartType(type, flag) {
            // 연산 설정 변경
            const operation = flag ? [[${chart?.chartConfig?.operation}]] : '';
            setOperationOption(type, operation);

            if (!flag) {
                // select box 디자인
                aliceJs.initDesignedSelectTag(document.getElementById('operation'));
            }
        }

        /**
         * 기간 변경시 화면 변경
         * @param type 차트 타입
         * @param flag 초기화시 true, 사용자 변경시 false
         */
        function changeRangeType(type, flag) {
            // 기간 지정시 범위 데이터 오픈
            const range = document.getElementById('rangeDate'); // 시작일자, 종료일자
            range.style.visibility = ( type === RANGE_BETWEEN ) ? 'visible' : 'hidden';

            if (!flag) {
                const fromDt = document.getElementById('rangeFromDt');
                const toDt = document.getElementById('rangeToDt');
                switch (type) {
                    case RANGE_BETWEEN: // 기간 지정
                        // 시작일자(from) = 오늘로부터 한달 전 데이터
                        // 종료일자(to) = 오늘
                        fromDt.value = i18n.getDate({ months: -1 });
                        fromDt.setAttribute('data-userDateTime', i18n.getStartOfDateTime({ months: -1 }, 'month'));
                        toDt.value = i18n.getDate();
                        toDt.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ days: 0 }, 'day'));
                        break;
                    case RANGE_LAST_MONTH: // 지난달
                        // 시작일자(from) = 지난달 01일 데이터
                        // 종료일자(to) = 지난달 마지막 날짜 데이터
                        fromDt.value = i18n.getStartOfDate({ months: -1 }, 'month');
                        fromDt.setAttribute('data-userDateTime', i18n.getStartOfDateTime({ months: -1 }, 'month'));
                        toDt.value = i18n.getEndOfDate({ months: -1 }, 'month');
                        toDt.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ months: -1 }, 'month'));
                        break;
                    case RANGE_ALL: // 전체
                        // 시작일자(from) = 2000년 01월 01일 00시 00분 00초 데이터
                        // 종료일자(to) = 현재 날짜 23시 59분 59초 데이터
                        // 기간에 따라 현재 날짜 전체 조정
                        fromDt.value = i18n.getCustomDate(2000, 1, 1);
                        fromDt.setAttribute('data-userDateTime', i18n.userDateTime(i18n.systemDate(fromDt.value)));
                        toDt.value = i18n.getDate();
                        toDt.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ days: 0 }, 'day'));
                        break;
                    case RANGE_LAST_DAY: // 어제
                        // 시작일자(from) = 어제 날짜 00시 00분 00초 데이터
                        // 종료일자(to) = 어제 날짜 23시 59분 59초 데이터
                        fromDt.value = i18n.getDate({ days: -1 });
                        fromDt.setAttribute('data-userDateTime', i18n.getStartOfDateTime({ days: -1 }, 'day'));
                        toDt.value = i18n.getDate({ days: -1 });
                        toDt.setAttribute('data-userDateTime', i18n.getEndOfDateTime({ days: -1 }, 'day'));
                        break;
                    default:
                        break;
                }
            }

            // TODO: #11574 [사용자 정의 차트] 기간 - 간격 설정
            /*if (type === BASIC_LINE_CHART || type === STACKED_COLUMN_CHART) {
                // 2021-10-06 By Jung Hee Chan
                // 기간 항목은 드롭박스에 디자인이 입혀지면서 div 가 새로 생김. 이것까지 숨기거나 보여주려면 처리를 아래와 같이 추가.
                document.getElementById('periodUnit').style.display = '';
                Array.from(document.getElementById('periodUnit').children).forEach((child) => {
                    child.style.display = '';
                });
            } else {
                document.getElementById('periodUnit').style.display = 'none';
                Array.from(document.getElementById('periodUnit').children).forEach((child) => {
                    child.style.display = 'none';
                });
            }*/

            // select box 디자인
            aliceJs.initDesignedSelectTag(range);
        }

        /**
         * 차트 데이터 조회
         * @returns json 데이터
         */
        function getChartData() {
            let tags = [];
            const targetTags = document.getElementById('targetTags').value;
            if (targetTags !== '') {
                JSON.parse(targetTags).forEach(tag => {
                    tags.push({value: tag.value})
                });
            }

            let fromDt = document.getElementById('rangeFromDt').getAttribute('data-userDateTime');
            let toDt = document.getElementById('rangeToDt').getAttribute('data-userDateTime');
            fromDt = i18n.systemDateTime(fromDt);
            toDt = i18n.systemDateTime(toDt);

            return {
                chartId: chartId || '',
                chartType: document.getElementById('typeSelectBox').value,
                chartName: document.getElementById('chartName').value,
                chartDesc: document.getElementById('chartDesc').value,
                chartConfig: {
                    operation: document.getElementById('operationSelectBox').value,
                    periodUnit: document.getElementById('periodUnitSelectBox').value,
                    range: {
                        type: document.getElementById('rangeType').value,
                        from: fromDt,
                        to: toDt
                    },
                    documentStatus: document.getElementById('targetStatusSelectBox').value,
                    condition: document.getElementById('condition').value
                },
                tags: tags
            };
        }
    </script>
    <script type="module">
        import ZChart from '../../../assets/js/chart/zChart.js';

        const zChartManager = {
            load: function(data) {
                // 차트 초기화
                this.zChart = new ZChart('container', data);
            },
            update: function (data) {
                // 데이터 업데이트
                this.zChart.update(data);
            },
            destroy: function () {
                if (this.zChart) {
                    this.zChart.destroy();
                    this.zChart = null;
                    delete this.zChart;
                }
            }
        }
        window.zChartManager = zChartManager;
    </script>
</th:block>
</html>
