<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/itsm/pageType/commonEditLayout}">
<head>
    <title th:text="#{user.label.editUserInfo}"></title>
</head>
<th:block layout:fragment="pageHead">
    <script th:src="@{/assets/vendors/rsa/jsbn.js}"></script>
    <script th:src="@{/assets/vendors/rsa/rsa.js}"></script>
    <script th:src="@{/assets/vendors/rsa/prng4.js}"></script>
    <script th:src="@{/assets/vendors/rsa/rng.js}"></script>
</th:block>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{user.label.editUserInfo}"></h1>
    <h6 class="description ml-2 pl-2" th:text="#{user.msg.editSelfDescription}"></h6>
</div>
<div layout:fragment="pageEdit">
    <div class="z-edit-form flex-fill">
        <input type="hidden" id="userKey" name="userKey" th:value="${users?.userKey}"/>
        <input type="hidden" id="avatarUUID" name="avatarUUID" value=""/>
        <div class="flex-column z-edit-row">
            <h3 class="sub-title under-bar bold" th:text="#{user.label.profile}"></h3>
        </div>
        <div class="flex-column z-edit-row">
            <div class="flex-row">
                <div class="z-edit-column col-6">
                    <div class="flex-column z-edit-row"
                         th:style="${users?.userKey != null && !users?.platform.equals('user.platform.alice')} ? 'display: none' : ''">
                        <label for="userId">
                            <span th:text="#{user.label.id}"></span>
                            <span class="required"></span>
                            <div class="z-help-tooltip">
                                <span class="z-icon i-tooltip"></span>
                                <div class="z-tooltip-contents">
                                    <span th:utext="#{user.tooltip.idRule}"></span>
                                </div>
                            </div>
                        </label>
                        <input type="text" class="z-input" id="userId" name="userId" th:value="${users?.userId}"
                               maxlength="100" required="required"/>
                    </div>
                    <div class="flex-column z-edit-row"
                         th:style="${users?.userKey != null && !users?.platform.equals('user.platform.alice')} ? 'display: none' : ''">
                        <label for="password">
                            <span th:text="#{user.label.password}"></span>
                            <span class="required"></span>
                            <div class="z-help-tooltip">
                                <span class="z-icon i-tooltip"></span>
                                <div class="z-tooltip-contents">
                                    <span th:utext="#{user.tooltip.pwRule}"></span>
                                </div>
                            </div>
                        </label>
                        <input type="password" class="z-input" id="password" name="password" maxlength="100"
                               autocomplete="new-password" required="required"/>
                    </div>
                    <div class="flex-column z-edit-row"
                         th:style="${users?.userKey != null && !users?.platform.equals('user.platform.alice')} ? 'display: none' : ''">
                        <label for="rePassword">
                            <span th:text="#{user.label.rePassword}"></span>
                            <span class="required"></span>
                        </label>
                        <input type="password" class="z-input" id="rePassword" name="rePassword" maxlength="100"
                               autocomplete="new-password" required="required"/>
                    </div>
                    <div class="flex-column z-edit-row">
                        <label for="userName">
                            <span th:text="#{user.label.name}"></span>
                            <span class="required"></span>
                        </label>
                        <input type="text" class="z-input" id="userName" name="userName" th:value="${users?.userName}"
                               maxlength="100" required="required"/>
                    </div>
                    <div class="flex-column z-edit-row"
                         th:style="${users?.userKey != null && !users?.platform.equals('user.platform.alice')} ? 'display: none' : ''">
                        <label for="email">
                            <span th:text="#{user.label.email}"></span>
                            <span class="required"></span>
                        </label>
                        <span th:text="#{user.msg.emailAlert}" hidden></span>
                        <input type="text" class="z-input" id="email" name="email" th:value="${users?.email}"
                               maxlength="100" required="required">
                    </div>
                    <div class="flex-column z-edit-row">
                        <label th:text="#{user.label.position}" for="position"></label>
                        <input type="text" class="z-input" id="position" name="position" th:value="${users?.position}"
                               maxlength="100">
                    </div>
                    <div class="flex-column z-edit-row">
                        <label th:text="#{user.label.department}"></label>
                        <div class="flex-row z-input-button">
                            <input type="hidden" id="departmentCode" name="departmentCode"
                                   th:value="${deptCodeDetail?.code}"/>
                            <input type="text" class="z-input col-5" id="department" name="department"
                                   th:value="${deptCodeDetail?.codeValue}" readonly>
                            <span class="z-icon i-clear" name="clearIcon" onclick="aliceJs.clearText(this);"
                                  tabindex="-1"></span>
                            <button type="button" class="z-button-search z-button form" onclick="deptPopUp();"
                                    th:text="#{common.btn.select}"></button>
                        </div>
                    </div>
                    <div class="flex-column z-edit-row">
                        <label th:text="#{user.label.officeNumber}" for="officeNumber"></label>
                        <input type="text" class="z-input" id="officeNumber" name="officeNumber"
                               th:value="${users?.officeNumber}"
                               onkeydown="return onlyNumber(event)" onkeyup="aliceJs.removeChar(event)" maxlength="100">
                    </div>
                    <div class="flex-column z-edit-row">
                        <label th:text="#{user.label.mobileNumber}" for="mobileNumber"></label>
                        <input type="text" class="z-input" id="mobileNumber" name="mobileNumber"
                               th:value="${users?.mobileNumber}"
                               onkeydown="return onlyNumber(event)" onkeyup="aliceJs.removeChar(event)" maxlength="100">
                    </div>
                </div>
                <div class="flex-column avatar-edit ml-4">
                    <label class="avatar-title" th:text="#{user.label.avatar}"></label>
                    <div id="avatarDropZone"></div>
                    <div class="avatar-description">
                        <span class="avatar-text" th:text="#{user.label.FileSizeLimit}"></span>
                        <span class="avatar-text" th:text="#{user.label.FileExtensionAllowed}"></span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-column z-edit-row">
            <h3 class="sub-title under-bar bold" th:text="#{user.label.customSetting}"></h3>
        </div>
        <div class="flex-column z-edit-row">
            <div class="flex-row">
                <div class="flex-column col-6 mr-4">
                    <label for="timezone">
                        <span th:text="#{user.label.timezone}"></span>
                        <span class="required"></span>
                    </label>
                    <select name="timezone" id="timezone">
                        <option th:each="timezone: ${timezoneList}" th:value="${timezone.timezoneValue}"
                                th:text="${timezone.timezoneId}"
                                th:selected="${timezone.timezoneValue} == ${users?.timezone}"></option>
                    </select>
                </div>
                <div class="flex-column col-6">
                    <label th:text="#{user.label.timeFormat}" for="date"></label>
                    <div class="flex-row">
                        <select class="select-date-time mr-1" name="date" id="date">
                            <option th:each="date: ${dateList}" th:value="${date.codeValue}"
                                    th:text="${date.codeValue}"
                                    th:selected="${date.codeValue} == ${usersDate}"></option>
                        </select>
                        <select class="hour-select" name="time" id="time">
                            <option th:each="time: ${timeList}" th:value="${time.codeValue}"
                                    th:text="${time.code}" th:selected="${time.codeValue} == ${usersTime}"></option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-column z-edit-row">
            <div class="flex-row">
                <div class="flex-column col-6 mr-4">
                    <label for="lang">
                        <span th:text="#{user.label.lang}"></span>
                        <span class="required"></span>
                    </label>
                    <select name="lang" id="lang">
                        <option th:each="lang: ${langList}" th:value="${lang.codeValue}"
                                th:text="${lang.codeValue}" th:selected="${lang.codeValue} == ${users?.lang}"></option>
                    </select>
                </div>
                <div class="flex-column col-6">
                    <label for="theme">
                        <span th:text="#{user.label.theme}"></span>
                        <span class="required"></span>
                    </label>
                    <select name="theme" id="theme">
                        <option th:each="theme: ${themeList}" th:value="${theme.codeValue}"
                                th:text="${theme.codeValue}" th:selected="${theme.codeValue} == ${users?.theme}"
                                th:unless="${theme.codeValue} == 'dark'"></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="flex-column z-edit-row">
            <h3 class="sub-title under-bar bold" th:text="#{user.label.userAbsence}"></h3>
            <label class="z-switch" for="userAbsence">
                <input type="checkbox" id="userAbsence" name="userAbsence" onchange="setDisplay('absenceData',this)"
                       th:checked="${users?.absenceYn == true}" th:disabled="${view}" />
                <span></span>
                <span class="z-label" th:text="#{user.msg.userAbsence}"></span>
            </label>
            <div id="absenceData" class="flex-column z-edit-row">
                <div class="flex-row">
                    <div class="flex-column col-3">
                        <label class="field-label required" th:text="#{common.label.startDate}"></label>
                        <div>
                            <input type="text" class="z-input i-date-picker search-date"
                                   id="absenceStartDt" name="absenceStartDt" th:readonly="${view}">
                        </div>
                    </div>
                    <div class="flex-column col-3">
                        <label class="field-label required" th:text="#{common.label.endDate}"></label>
                        <div>
                            <input type="text" class="z-input i-date-picker search-date"
                                   id="absenceEndDt" name="absenceEndDt" th:readonly="${view}">
                        </div>
                    </div>
                    <div class="flex-column col-6">
                        <label class="field-label required" th:text="#{user.label.substituteUser}"></label>
                        <div class="flex-row z-input-button">
                            <input type="hidden" id="substituteUserKey" name="substituteUserKey">
                            <input type="text" class="z-input col-5" id="substituteUser" name="substituteUser"
                                    readonly>
                            <span class="z-icon i-clear" name="clearIcon" onclick="aliceJs.clearText(this);"
                                  tabindex="-1"></span>
                            <button type="button" class="z-button-search z-button form" onclick="openUserListPopup();"
                                    th:text="#{common.btn.select}"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-row justify-content-end z-edit-row">
            <div class="z-button-list">
                <button class="z-button primary" type="button" th:text="#{common.btn.modify}"
                        th:onclick="restSubmit('put', [[@{/rest/users/{userKey}/info(userKey=${users.userKey})}]])"></button>
            </div>
        </div>
    </div>
</div>
<div id="password-guide" hidden>
        <pre>
            [ 아이디 생성 가이드 ]
            1. 영문, 숫자, 특수문자(@, ., -, _)만 허용한다.
            2. 허용된 특수문자는 맨 앞에 올수 없다.
            3. 공백을 허용하지 않는다.
            [ 비밀번호 수정 가이드 ]
            1. 2가지 이상의 문자 구성(대문자, 소문자, 특수문자, 숫자)인 경우, 8자 이상 20자 미만, 1가지 종류의 문자 구성인 경우 10자 이상 20자 미만의 비밀번호 입력 제한 범위를 가진다.
            2. 사용자의 ID를 포함하지 않는다.
               예) ID가 ITSM인 경우, ITS는 포함 가능, ITSM은 포함 불가.
            3. 사용자의 이메일 ID를 포함하지 않는다.
               예) 이메일 ID가 ITSM인 경우, ITS는 포함 가능, ITSM은 포함 불가
            4. 공백을 허용하지 않는다.
        </pre>
</div>
</body>
<script layout:fragment="pageScript" th:inline="javascript">
    /*<![CDATA[*/
    window.onload = function () {
        document.getElementById('userId').focus();
        setDisplay('absenceData',document.getElementById('userAbsence'));
        zFileUploader.avatar({
            dropZoneFilesId: 'avatarDropZone',
            type: 'avatar',
            dropZoneMaxFileSize: 0.2,
            dropZoneUrl: '/fileupload?target=avatar',
            dropZoneMaxFiles: 1,
            acceptedFiles: '.png,.jpeg,.jpg,.gif',
            avatar: {
                id: [[${users?.userKey}]],
                path: [[${users?.avatarPath}]],
                value: [[${users?.avatarValue}]],
                size: [[${users?.avatarSize}]]
            }
        });

        OverlayScrollbars(document.querySelectorAll('.edit'), {className: 'scrollbar'});
    };

    const STATUS_SUCCESS = '0';
    const STATUS_ERROR_USER_ID_DUPLICATION = '1';
    const STATUS_ERROR_EMAIL_DUPLICATION = '3';
    const STATUS_SUCCESS_EDIT_EMAIL = '4';
    const alicePlatform = 'user.platform.alice';

    function restSubmit(method, url) {
        if (!validation()) {
            return false;
        }

        const data = {
            userKey: document.getElementById('userKey').value,
            userId: document.getElementById('userId').value,
            userName: document.getElementById('userName').value,
            email: document.getElementById('email').value,
            position: document.getElementById('position').value,
            department: document.getElementById('departmentCode').value,
            officeNumber: document.getElementById('officeNumber').value,
            mobileNumber: document.getElementById('mobileNumber').value,
            timezone: document.getElementById('timezone').value,
            lang: document.getElementById('lang').value,
            theme: document.getElementById('theme').value,
            absenceYn: document.getElementById('userAbsence').checked,
            absenceStartDt: document.getElementById('absenceStartDt').value,
            absenceEndDt: document.getElementById('absenceEndDt').value,
            substituteUserKey: document.getElementById('substituteUserKey').value,
            timeFormat: document.getElementById('date').value + ' ' + document.getElementById('time').value,
            fileSeq: document.getElementsByName('fileSeq').value,
            avatarUUID: document.getElementById('avatarUUID').value
        };
        const password = document.getElementById('password').value;
        if (password !== '') {
            const rsa = new RSAKey();
            const keyModule = [[${#request.getAttribute('_publicKeyModulus')}]];
            const keyExponent = [[${#request.getAttribute('_publicKeyExponent')}]];
            rsa.setPublic(keyModule, keyExponent);
            data.password = rsa.encrypt(password);
        }

        aliceJs.sendXhr({
            method: method,
            url: url,
            params: JSON.stringify(data),
            contentType: 'application/json',
            callbackFunc: function (response) {
                switch (response.responseText) {
                    case STATUS_SUCCESS:
                        zAlert.success([[#{common.msg.modify}]], function () {
                            window.location.reload();
                        });
                        break;
                    case STATUS_SUCCESS_EDIT_EMAIL:
                        zAlert.success([[#{user.msg.emailWithUpdate}]], function () {
                            window.location.reload();
                        });
                        break;
                    case STATUS_ERROR_USER_ID_DUPLICATION:
                        zAlert.warning([[#{user.msg.sameUserId}]]);
                        break;
                    case STATUS_ERROR_EMAIL_DUPLICATION:
                        zAlert.warning([[#{user.msg.sameEmail}]]);
                        break;
                    default :
                        zAlert.danger(i18n.msg('common.label.modify') + i18n.msg('common.label.blank') + i18n.msg('common.msg.fail'));
                        break;
                }
            }
        });
    }

    function setDisplay(viewId, switchElement) {
        if (switchElement.checked) {
            const startDtVal = ''; // /*[[${users?.absenceStartDt}]]*/
            const endDtVal = ''; // /*[[${users?.absenceEndDt}]]*/
            const startDtElement = document.getElementById('absenceStartDt');
            const endDtElement = document.getElementById('absenceEndDt');
            startDtElement.value = startDtVal ? i18n.userDateTime(startDtVal) : i18n.getDateTime();
            endDtElement.value = endDtVal ? i18n.userDateTime(endDtVal) : i18n.getDateTime({'days':7});
            zDateTimePicker.initDateTimePicker(startDtElement);
            zDateTimePicker.initDateTimePicker(endDtElement);
            document.getElementById(viewId).style.display = 'block';
        } else {
            document.getElementById('absenceStartDt').value = '';
            document.getElementById('absenceEndDt').value = '';
            document.getElementById(viewId).style.display = 'none';
        }
    }

    function validation() {
        if (isEmpty('userId', 'user.msg.enterUserId')) return false;
        if (isAndOperator(isEmpty('password'), isNotEmpty('rePassword'), 'user.msg.enterUserPassword')) return false;
        if (isAndOperator(isNotEmpty('password'), isEmpty('rePassword'), 'user.msg.enterUserRePassword')) return false;
        if (isNotEquals('password', 'rePassword', 'user.msg.passwordNotEquals')) return false;
        if (isAndOperator(isNotEmpty('password'), isNotEmpty('rePassword'))) {
            if (!isValidPassword('password')) return false;
        }
        if (!isValidUserId("userId", true)) return false;
        if (isEmpty('userName', 'user.msg.enterUserName')) return false;
        if ([[${users.platform}]] === alicePlatform) {
            if (isEmpty('email', 'user.msg.enterUserEmail')) return false;
            if (!isValidEmail('email', true)) return false;
        }
        if (document.getElementById('userAbsence').checked) {
            if (isEmpty('absenceStartDt', 'user.msg.enterAbsenceStartDt')) return false;
            if (isEmpty('absenceEndDt', 'user.msg.enterAbsenceEndDt')) return false;
            if (isOrOperator((i18n.systemDateTime(document.getElementById('absenceStartDt').value) > i18n.systemDateTime(document.getElementById('absenceEndDt').value))
                , (i18n.systemDateTime(document.getElementById('absenceStartDt').value) === i18n.systemDateTime(document.getElementById('absenceEndDt').value))
                , 'user.msg.compareWithAbsenceDtValue')) return false;
            if (isEmpty('substituteUserKey', 'user.msg.enterSubstituteUser')) return false;
        }

        return true;
    }

    function setDepartment(node) {
        document.getElementById('department').value = node.textContent;
        document.getElementById('departmentCode').value = node.id;
    }

    function deptPopUp() {
        const rootCode = 'department';
        tree.load({
            view: 'modal',
            title: i18n.msg('department.label.deptList'),
            dataUrl: '/rest/codes?pCode=' + rootCode,
            root: rootCode,
            rootLevel: 3,
            target: 'treeList',
            text: 'codeName',
            nodeNameLabel: i18n.msg('common.msg.dataSelect', i18n.msg('department.label.deptName')),
            defaultIcon: '/assets/media/icons/tree/icon_tree_users.svg',
            leafIcon: '/assets/media/icons/tree/icon_tree_user.svg',
            selectedValue: document.getElementById('departmentCode').value,
            callbackFunc: function (response) {
                setDepartment(response);
            }
        });
    }

    function openUserListPopup() {
        const subUserModal = new modal({
            title: i18n.msg('user.label.substituteUser'),
            body: createModalContent(),
            classes: 'sub-user-modal',
            buttons: [{
                content: i18n.msg('common.btn.select'),
                classes: 'z-button primary',
                bindKey: false,
                callback: (modal) => {
                    const selectedSubUser = document.querySelector('input[type=radio]:checked');
                    if (selectedSubUser === null) {
                        zAlert.warning(i18n.msg('user.msg.enterSubstituteUser'));
                        return false;
                    } else {
                        document.getElementById('substituteUserKey').value = selectedSubUser.value;
                        document.getElementById('substituteUser').value = selectedSubUser.name;
                    }
                    modal.hide();
                }
            }, {
                content: i18n.msg('common.btn.cancel'),
                classes: 'z-button secondary',
                bindKey: false,
                callback: (modal) => {
                    modal.hide();
                }
            }],
            close: {
                closable: false,
            },
            onCreate: () => {
                document.getElementById('search').addEventListener('keyup', (e) => {
                    this.getSubUserList(e.target.value, false);
                });
                this.getSubUserList(document.getElementById('search').value, true);
            }
        });
        subUserModal.show();
    }

    function createModalContent() {
        return `<div class="sub-user-list">` +
            `<input class="z-input i-search col-5 mr-2" type="text" name="search" id="search" maxlength="100" placeholder="${i18n.msg('user.label.searchPlaceholder')}">` +
            `<span id="spanTotalCount" class="search-count"></span>` +
            `<div class="table-set" id="subUserList"></div>` +
            `</div>`;
    }
    
    function getSubUserList(search, showProgressbar) {
        let strUrl = '/users/view-pop/users?search=' + encodeURIComponent(search.trim())
        const opt = {
            method: 'get',
            url: strUrl,
            contentType: 'application/json',
            showProgressbar: showProgressbar,
            callbackFunc: function (response) {
                document.getElementById('subUserList').innerHTML = response.responseText;
                OverlayScrollbars(document.querySelector('.z-table-body'), {className: 'scrollbar'});
                aliceJs.showTotalCount(document.querySelectorAll('.sub-user-list').length);
                document.querySelectorAll('input[type=radio]').forEach(function (radio) {
                    // 업무 대리인으로 자기 자신은 선택할 수 없다.
                    if (radio.value === document.getElementById('userKey').value) {
                        radio.disabled = true;
                    }
                });
            }
        };
        aliceJs.sendXhr(opt);
    }
    /*]]>*/
</script>
</html>
