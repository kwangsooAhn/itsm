<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
  layout:decorator="layout/defaultLayout">
<head>
    <meta charset="UTF-8">
    <style>
        .dropzone {
            height: 180px;
            width: 180px;
            overflow-y: hidden;
            overflow-x: hidden;
        }
        .dropzone img {
            width: 100%;
            height: 100%;
        }
        .btn-check-wrapper {
            display: inline-block;
            float: right;
        }
        .btn-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
        }
        .fileEditorable {
            height: 180px;
            width: 180px;
        }
    </style>
</head>
<body>
<th:block layout:fragment="content">
    <div id="container" align="center">
    <input type="hidden" id="userKey" name="userKey" th:value="${users.userKey}"/>
    <input type="hidden" id="oldPassword" name="oldPassword" th:value="${users.password}"/>
    <input type="hidden" id="avatarUUID" name="avatarUUID" value=""/>
        <form id="userEditSelfForm" method="post" onsubmit ="return false">
            <table style="text-align: left;">
                <tbody id="tbody">
                    <tr>
                        <th th:text="#{user.id}+'*'"/>
                        <td><input type="text" id="userId" name="userId" th:value="${users.userId}" maxlength="100" required="required"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.password}+'*'"/>
                        <td><input type="password" id="password" name="password" maxlength="100" required="required"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.rePassword}+'*'"/>
                        <td><input type="password" id="rePassword" name="rePassword" maxlength="100" required="required"/>
                    </tr>
                </tbody>
                <tbody>
                    <tr>
                        <th th:text="#{user.name}+'*'"/>
                        <td><input type="text" id="userName" name="userName" th:value="${users.userName}" maxlength="100" required="required"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.email}+'*'"/>
                        <td><input type="text" id="email" name="email" th:value="${users.email}" maxlength="100" required="required"/>
                    </tr>
                    <tr>
                        <th/>
                        <td th:text="#{user.message}"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.position}"/>
                        <td><input type="text" id="position" name="position" th:value="${users.position}" maxlength="100"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.department}"/>
                        <td><input type="text" id="department" name="department" th:value="${users.department}" maxlength="100"/>
                    </tr>
                    <tr>
                        <th th:text="#{user.officeNumber}"/>
                        <td><input type="text" id="officeNumber" name="officeNumber" th:value="${users.officeNumber}" onkeydown="return onlyNumber(event)" onkeyup="removeChar(event)" maxlength="100" />
                    </tr>
                    <tr>
                        <th th:text="#{user.mobileNumber}"/>
                        <td><input type="text" id="mobileNumber" name="mobileNumber" th:value="${users.mobileNumber}" onkeydown="return onlyNumber(event)" onkeyup="removeChar(event)" maxlength="100" />
                    </tr>
                    <tr>
                        <th th:text="#{user.timezone}+'*'"/>
                        <td><select name="timezone" id="timezone"><option th:each="tzData: ${timezoneList}" th:value="${tzData.timezoneValue}"
                        th:text="${tzData.timezoneId}"></option></select></td>
                    </tr>
                    <tr>
                        <th th:text="#{user.timeFormat}+'*'"/></th>
                        <td>
                            <span th:text="#{user.date}"></span>
                            <select name="date" id="date"><option th:each="dateData: ${dateList}" th:value="${dateData.codeValue}"
                                                                  th:text="${dateData.codeValue}"></option></select>
                            <span th:text="#{user.time}"></span>
                            <select name="time" id="time"><option th:each="timeData: ${timeList}" th:value="${timeData.codeValue}"
                                                                  th:text="${timeData.code}"></option></select>
                        </td>
                    </tr>
                    <tr>
                        <th th:text="#{user.lang}+'*'"/>
                        <td><select name="lang" id="lang"><option th:each="itemData: ${langList}" th:value="${itemData.codeValue}"
                                                                  th:text="${itemData.codeValue}"></option></select></td>
                    </tr>
                    <tr>
                        <th th:text="#{user.theme}+'*'"/>
                        <td><select name="theme" id="theme"><option th:each="themeData: ${themeList}" th:value="${themeData.codeValue}"
                                                                  th:text="${themeData.codeValue}"></option></select></td>
                    </tr>
                    <tr>
                        <th th:text="#{user.avatar}"/>
                        <td>
                            <!--<img th:src="${attachImage}" th:border="1" th:width="200" th:height="200"/>-->
                            <div id="dropZoneFiles"></div>
                            <div id="dropZoneUploadedFiles"></div>
                            <br/>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
        <button style="margin-top: 25px;" th:onclick="restSubmit('put', [[@{/rest/users/{userKey}/info(userKey=${users.userKey})}]])"
                                          th:text="#{user.editUserInfo}"></button>
    </div>
    <br>
    <br>
    <div id="container" align="left">
        <pre>
            [ 비밀번호 수정 가이드 ]

            1. 2가지 이상의 문자 구성(대문자, 소문자, 특수문자, 숫자)인 경우, 8자 이상 20자 미만, 1가지 종류의 문자 구성인 경우 10자 이상 20자 미만의 비밀번호 입력 제한 범위를 가진다.

            2. 사용자의 ID를 포함하지 않는다.
               예) ID가 ITSM인 경우, ITS는 포함 가능, ITSM은 포함 불가.

            3. 사용자의 이메일 ID를 포함하지 않는다.
               예) 이메일 ID가 ITSM인 경우, ITS는 포함 가능, ITSM은 포함 불가

            4. 공백을 허용하지 않는다.
        </pre>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script th:src="@{/assets/vendors/rsa/jsbn.js}"></script>
    <script th:src="@{/assets/vendors/rsa/rsa.js}"></script>
    <script th:src="@{/assets/vendors/rsa/prng4.js}"></script>
    <script th:src="@{/assets/vendors/rsa/rng.js}"></script>
    <script th:src="@{/assets/js/util/validation-alice.js}"></script>
    <script type="text/javascript" th:inline="javascript">
     /*<![CDATA[*/
        window.onload = function() {
            if (/*[[${!users.platform.equals('user.platform.alice')}]]*/) {
                document.getElementById('tbody').style.display = 'none';
            }

            if (/*[[${users.theme != null}]]*/) {
                var selectLength = document.getElementById('theme').length;
                for (var i = 0; i < selectLength; i++) {
                   if (document.getElementById('theme').options[i].value === /*[[${users.theme}]]*/) {
                       document.getElementById('theme').options[i].selected = true;
                   }
                }
            }

            if (/*[[${users.lang != null}]]*/) {
                var selectLength = document.getElementById('lang').length;
                for (var i = 0; i < selectLength; i++) {
                   if (document.getElementById('lang').options[i].value === /*[[${users.lang}]]*/) {
                       document.getElementById('lang').options[i].selected = true;
                   }
                }
            }

            if (/*[[${users.timezone != null}]]*/) {
                var selectLength = document.getElementById('timezone').length;
                for (var i = 0; i < selectLength; i++) {
                    if (document.getElementById('timezone').options[i].value === /*[[${users.timezone}]]*/) {
                        document.getElementById('timezone').options[i].selected = true;
                    }
                }
            }

            if (/*[[${users.timeFormat != null}]]*/) {
                var selectLength = document.getElementById('date').length;
                for (var i = 0; i < selectLength; i++) {
                    if (document.getElementById('date').options[i].value === /*[[${usersDate}]]*/) {
                        document.getElementById('date').options[i].selected = true;
                    }
                }

                selectLength = document.getElementById('time').length;
                for (var i = 0; i < selectLength; i++) {
                    if (document.getElementById('time').options[i].value === /*[[${usersTime}]]*/) {
                        document.getElementById('time').options[i].selected = true;
                    }
                }
            }

            document.getElementById('avatarUUID').value = uuid();
            var avatarUUID = document.getElementById('avatarUUID').value;
            fileUploader.init({extra: {
                formId: 'userEditSelfForm',
                dropZoneMaxFileSize: 0.1,
                dropZoneUrl: '/fileupload?target=avatar&fileName='+ avatarUUID,
                dropZoneMaxFiles: 1,
                clickable: '.add-img-button'
            }});
        };

        function onlyNumber(event) {
            event = event || window.event;
            var keyID = (event.which) ? event.which : event.keyCode;
            if ((keyID >= 48 && keyID <= 57) || (keyID >= 96 && keyID <= 105)
            || keyID == 8 || keyID == 46 || keyID == 37 || keyID == 39) {
                return;
            } else {
                return false;
            }
        }

        function removeChar(event) {
            event = event || window.event;
            var keyID = (event.which) ? event.which : event.keyCode;
            if (keyID == 8 || keyID == 46 || keyID == 37 || keyID == 39) {
                return;
            } else {
                event.target.value = event.target.value.replace(/[^0-9]/g, "");
            }
        }

        const STATUS_SUCCESS = '0';
        const STATUS_ERROR_USER_ID_DUPLICATION = '1';
        const STATUS_ERROR_EMAIL_DUPLICATION = '3';
        const STATUS_SUCCESS_EDIT_EMAIL = '4';

        function restSubmit(method, url) {
            const oldPassword = document.getElementById('oldPassword').value;
            var password = document.getElementById('password').value;
            var keyModule;
            var keyExponent;
            var rsa;

            if (!validation()) {
                return false;
            }

            keyModule = [[${#request.getAttribute('_publicKeyModulus')}]];
            keyExponent = [[${#request.getAttribute('_publicKeyExponent')}]];
            rsa = new RSAKey();
            rsa.setPublic(keyModule, keyExponent);

            if (password === '') {
                password = oldPassword;
            } else {
                password = rsa.encrypt(password);
            }

            const data = {
                userKey: document.getElementById('userKey').value,
                userId: document.getElementById('userId').value,
                password: password,
                userName: document.getElementById('userName').value,
                email: document.getElementById('email').value,
                position: document.getElementById('position').value,
                department: document.getElementById('department').value,
                officeNumber: document.getElementById('officeNumber').value,
                mobileNumber: document.getElementById('mobileNumber').value,
                timezone: document.getElementById('timezone').value,
                lang: document.getElementById('lang').value,
                theme: document.getElementById('theme').value,
                timeFormat: document.getElementById('date').value +' '+ document.getElementById('time').value,
                fileSeq: document.getElementsByName('fileSeq').value,
                avatarUUID: document.getElementById('avatarUUID').value
            };

            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(data),
                contentType: 'application/json',
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            aliceJs.alert([[#{common.msg.update}]], function() {
                                window.location.reload();
                            });
                            break;
                        case STATUS_SUCCESS_EDIT_EMAIL:
                            aliceJs.alert([[#{user.msg.emailWithUpdate}]], function() {
                                window.location.reload();
                            });
                            break;
                        case STATUS_ERROR_USER_ID_DUPLICATION:
                            aliceJs.alert([[#{user.msg.sameUserId}]]);
                            break;
                        case STATUS_ERROR_EMAIL_DUPLICATION:
                            aliceJs.alert([[#{user.msg.sameEmail}]]);
                            break;
                        default :
                            aliceJs.alert([[#{common.msg.update.fail}]]);
                            break;
                    }
                }
            };
            aliceJs.sendXhr(opt);
        }

        function validation() {
            if (isEmpty('userId', 'user.msg.idNotExist')) return false;
            if (isAndOperator(isEmpty('password'), isNotEmpty('rePassword'), 'user.msg.passwordNotExist')) return false;
            if (isAndOperator(isNotEmpty('password'), isEmpty('rePassword'), 'user.msg.rePasswordNotExist')) return false;
            if (isNotEquals('password', 'rePassword', 'user.msg.passwordNotEquals')) return false;
            if (isAndOperator(isNotEmpty('password'), isNotEmpty('rePassword'))) {
                if (!isValidPassword('password')) return false;
            }
            if (isEmpty('userName', 'user.msg.nameNotExist')) return false;
            if (isEmpty('email', 'user.msg.emailNotExist')) return false;
            if (!isValidEmail('email')) return false;
            return true;
        }

        function uuid() {
            function s4() {
                return ((1 + Math.random()) * 0x10000 | 0).toString(16).substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        }
        /*]]>*/
    </script>
</th:block>
</html>
