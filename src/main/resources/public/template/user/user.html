<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>사용자목록</title>
</head>
<body>
<div sec:authorize="hasAuthority('user.read')">
    <div style="border: 1px solid red">
        <div>- 검색영역 -</div>
        <form id="search" onsubmit="return false">
            <select id="searchKey" name="searchKey">
                <option value="">--</option>
                <option th:each="userSearch : ${userSearchCode}"
                        th:value="${userSearch.code}"
                        th:text="#{${userSearch.code}}">
                </option>
            </select>
            <input type="text" id="searchValue" name="searchValue" th:placeholder="#{searchWord}"/>
        </form>
    </div>
    <div style="border: 1px solid red">
        <div>- 버튼 영역, user.create 권한이 있어야 보임 -</div>
        <div sec:authorize="hasAuthority('user.create')">
            <button type="button" id="userReg" class="btn btn-default" th:text="#{user.reg}">사용자 등록</button>
        </div>
    </div>
    <div style="border: 1px solid red">
        <div>- 사용자 목록 영역-</div>
        <div id="userList"></div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="userDetailModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-body" id="userDetail"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" th:text="#{btn.close}">닫기</button>
            </div>
        </div>

    </div>
</div>
<script type="text/javascript" th:inline="javascript">
    $(document).ready(function () {
        /*<![CDATA[*/
        /***************************************************************************************************************
         *  검색란 엔터키 이벤트
         */
        $('#searchValue').on('keypress', function (e) {
            if (e.keyCode === 13) {
                searchUser()
            }
        });

        /***************************************************************************************************************
         *  사용자 등록 버튼 클릭시 등록 화면을 연다.
         */
        $('#userReg').on('click', function () {
            alert('사용자 등록 화면 만들기')
        });

        /***************************************************************************************************************
         *  사용자를 검색한다.
         */
        function searchUser() {
            $.ajax({
                type: "get",
                url: '/users',
                data: $('#search').serializeObject(),
                success: function (users) {
                    $.ajax({
                        type: 'get', url: '/users/search', data: {users: JSON.stringify(users)}
                    }).done(function (data) {
                        $('#userList').html(data)
                    });
                },
                error: function (request, status, error) {
                    alert("Call failed. code : " + request.status + ", message : " + request.errorMsg);
                }
            });
        }

        /***************************************************************************************************************
         * 모달 닫기
         */
        $('#userDetailModal').on('hidden.bs.modal', function (e) {
            $('#userDetail').empty();
        });

        /***************************************************************************************************************
         * 모달 열기
         */
        $('#userDetailModal').on('show.bs.modal', function (e) {
            $.ajax({
                type: "get",
                url: '/users/' + $(e.relatedTarget).data('id'),
                success: function (user) {
                    $.ajax({
                        type: 'get', url: '/users/detail', data: {user: JSON.stringify(user)}
                    }).done(function (data) {
                        $('#userDetail').html(data);

                        $('#userDetail input[type=text].form-control:not(input[name=userId])').on('dblclick', function () {
                            $('#userDetail input[type=text].form-control').prop('readonly', true);
                            $(this).prop('readonly', function (i, v) {
                                return !v
                            });
                        });

                        $('#userDetail input[type=text].form-control').on('keypress', function (e) {
                            if (e.keyCode === 13) {
                                userDetailSave()
                            }
                        });

                        $('#userDetail input[type=checkbox].custom-control-input').on('change', function (e) {
                            userDetailSave()
                        });

                    });
                },
                error: function (request, status, error) {
                    alert("Call failed. code : " + request.status + ", message : " + request.errorMsg);
                }
            });
        });

        /***************************************************************************************************************
         * 저장하기
         */
        function userDetailSave() {
            $.ajax({
                type: "put",
                url: '/users/' + $('#userDetailEditModal #userId').val(),
                data: $('#userDetailEditModal').serializeObject(),
                traditional: true,
                success: function (response) {
                    //$('#userDetailModal').modal('hide');
                    $('#saveResult').html(response);
                    $('#userDetail input[type=text].form-control').prop('readonly', true);
                    searchUser();
                },
                error: function (request, status, error) {
                    alert("Call failed. code : " + request.status + ", message : " + request.errorMsg);
                }
            });
        }

        /** 최초 검색 실행하기 */
        searchUser();
        /*]]>*/
    });
</script>
</body>
</html>