<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>사용자목록</title>
</head>
<body>
<div sec:authorize="hasAuthority('user.read')">
    <div style="border: 1px solid red">
        <div>- 검색영역 -</div>
        <form id="searchForm" onsubmit="return false">
            <div th:each="userSearch : ${userSearchCode}">
                <input type="checkbox" th:id="|searchKey${userSearchStat.index}|" name="searchKey"
                       th:value="${userSearch.code}" th:checked="${userSearchStat.index} == 0">
                <label th:for="|searchKey${userSearchStat.index}|" th:text="#{${userSearch.code}}"></label>
            </div>
            <input type="text" id="searchValue" name="searchValue" th:placeholder="#{common.searchWord}"/>
        </form>
    </div>
    <div style="border: 1px solid red">
        <div>- 버튼 영역, user.create 권한이 있어야 보임 -</div>
        <div sec:authorize="hasAuthority('user.create')">
            <button type="button" id="userReg" class="btn btn-default" th:text="#{user.reg}">사용자 등록</button>
        </div>
    </div>
    <div style="border: 1px solid red">
        <div>- 사용자 목록 영역-</div>
        <div id="userList"></div>
    </div>
</div>

<!-- Modal -->
<div style="border: 1px solid red">
    <div>- 사용자 편집 모달 영역 -</div>
    <div id="userDetailModal" style="display: none"></div>
</div>


<div style="border: 1px solid red">
    <div>- 에러 출력 영역 -</div>
    <div id="searchError"></div>
</div>

<script>

    /**
     * 검색창 엔터 입력시 동작
     */
    document.getElementById('searchValue').addEventListener('keypress', function (e) {
        if (e.key !== undefined && e.key === 'Enter') {
            searchUser();
        }
    });

    /**
     * 사용자를 검색한다.
     */
    function searchUser() {
        aliceJs.sendXhr('get', '/users/list?' + aliceJs.serialize(document.getElementById('searchForm')), setUserClickEvent);
    }

    /**
     * 사용자 데이터 조회 후 각 row 마다 클릭 이벤트를 생성한다.
     * @param response
     */
    function setUserClickEvent(response) {
        document.getElementById('userList').innerHTML = response.responseText;

        Array.prototype.forEach.call(document.getElementsByClassName('userRows'), function (user) {
            user.addEventListener('click', function (e) {
                document.getElementById('userDetailModal').style.display = '';
                let url = '/users/' + this.querySelector('input[type=hidden][name=userId]').value + '/edit';
                aliceJs.sendXhr('get', url, openUserEditor);
            })
        });
    }

    /**
     * 사용자 상세조회 화면을 연다.
     * @param response
     */
    function openUserEditor(response) {
        document.getElementById('userDetailModal').innerHTML = response.responseText;



    }

    searchUser()
</script>
</body>
</html>