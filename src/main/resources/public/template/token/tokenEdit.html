<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="formDesigner/formCore">
<head>
    <title th:text="#{token.label.write}"></title>
</head>
<th:block layout:fragment="css">
    <link th:href="@{/assets/css/document.css}" rel="stylesheet"/>
    <link th:href="@{/assets/theme/{theme}/css/itsm.css(theme=${#authentication.details.theme})}"
          rel="stylesheet"/>
</th:block>
<body>
<th:block layout:fragment="content">
    <div class="document-container">
        <form id="frm" name="frm">
            <div class="document-main flex-column align-items-center">
                <div class="document-main-header flex-row justify-content-between align-items-center">
                    <span class="document-numbering" th:text="|#{document.label.docNo} : ${documentNo}|"></span>
                    <div id="btn-area"></div>
                </div>
                <div class="drawing-board" id="document-panel" data-display="token"></div>
            </div>
        </form>
        <div class="token-properties"></div>
    </div>
</th:block>
</body>
<th:block layout:fragment="script">
    <script th:src="@{/assets/vendors/tagify/tagify.custom.js}"></script>
    <script type="module">
        /*<![CDATA[*/

        import { zFormToken } from "../../assets/js/document/zFormToken.js";
        import { zFormButton } from "../../assets/js/document/zFormButton.js";
        import { SESSION } from '../../assets/js/lib/zConstants.js';
        const userSession = {
            userKey : '[[${#authentication.details.userKey}]]',
            userId : '[[${#authentication.details.userId}]]',
            userName: '[[${#authentication.details.userName}]]',
            email: '[[${#authentication.details.email}]]',
            position: '[[${#authentication.details.position}]]',
            department: '[[${#authentication.details.department}]]',
            officeNumber: '[[${#authentication.details.officeNumber}]]',
            mobileNumber: '[[${#authentication.details.mobileNumber}]]'
        };
        Object.assign(SESSION, userSession);
        let tokenListModal;
        window.onload = function () {
            // 아래 URL 은 추후에 '/rest/tokens/' + '[[${tokenId}]]' + '/data' 로 수정해야 함.
            aliceJs.fetchJson('/assets/js/document/token_test.json', {
                method: 'GET'
            }).then((formData) => {
                zFormToken.init(document.getElementById('document-panel'), formData);
                zFormButton.init(document.getElementById('btn-area'), formData, zFormToken);
                this.instanceId = zForm
            });

            OverlayScrollbars(document.querySelectorAll('.list-wrap'), {className: 'scrollbar'});

            let instanceId = document.getElementById('instanceId').getAttribute('data-id');
            let tokenId = document.getElementById('tokenId').getAttribute('data-id');
            // 프린트 페이지일 경우,
            if (document.querySelector('.token-properties') === null) { return false; }

            // 탭 정보들 조회하여 셋팅.
            aliceJs.sendXhr({
                method: 'GET',
                url: '/tokens/' + '[[${tokenId}]]' + '/edit-tab',
                async: false,
                showProgressbar: true,
                callbackFunc: function (response) {
                    if (document.querySelector('.token-properties').children) {
                        document.querySelector('.token-properties').remove();
                        let tokenInfo = document.createElement('div');
                        tokenInfo.className = 'token-properties';
                        document.querySelector('.document-container').append(tokenInfo);
                    }
                    document.querySelector('.token-properties').innerHTML = response.responseText;

                    // 탭 정보에 이벤트를 등록
                    document.querySelectorAll('.token-info-tab > h4').forEach((ele) => {
                        ele.addEventListener('click', (e) => {
                            // 탭 동작
                            Array.prototype.filter.call(e.target.parentNode.children, function (child) {
                                return child !== e.target;
                            }).forEach((sblingEle) => {
                                sblingEle.classList.remove('active');
                            });
                            e.target.classList.add('active');
                            // 컨텐츠 내용 동작
                            let targetElement = document.querySelector('.' + e.target.dataset.targetContents);
                            if (targetElement != null) {
                                Array.prototype.filter.call(targetElement.parentNode.children, function (child) {
                                    return child !== targetElement;
                                }).forEach((sblingEle) => {
                                    sblingEle.style.display = 'none';
                                });
                                targetElement.style.display = 'block';
                            }
                            // 선택된 탭을 저장 > 새로고침시 초기화를 막기 위함
                            sessionStorage.setItem('token-info-tab', e.target.dataset.targetContents);

                            if (e.target.dataset.targetContents === 'token-tag') {
                                document.querySelector('span[contenteditable]').focus();
                            }
                        });
                    });

                    // userDate 변환
                    document.querySelectorAll('.dateFormatFromNow').forEach((element) => {
                        element.textContent = dateFormatFromNow(element.textContent);
                    });
                    document.querySelectorAll('.user-date-time').forEach((element) => {
                        element.textContent = i18n.userDateTime(element.textContent);
                    });

                    addCommentBox(instanceId);

                    new zTag(document.querySelector('input[name=tags]'),{
                        suggestion: true,
                        realtime: true,
                        tagType: 'instance',
                        targetId: document.getElementById('instanceId').getAttribute('data-id')
                    })
                    const selectedTab = sessionStorage.getItem('token-info-tab') ? sessionStorage.getItem('token-info-tab') : 'token-history';
                    document.querySelector('h4[data-target-contents="' + selectedTab + '"]').click();
                    OverlayScrollbars(document.querySelectorAll('.token-info-contents'), {className: 'scrollbar'});
                    const tokenActionEle = document.querySelectorAll('td[name=tokenAction]');
                    for (let i = 0; i < tokenActionEle.length; i++) {
                        tokenActionEle[i].textContent = i18n.msg(tokenActionEle[i].textContent);
                    }
                }
            });
        };

        function getInstanceList(search, showProgressbar) {
            restSubmit('get', '/tokens/view-pop/documents?searchValue=' + search.trim() + '&tokenId=' + '[[${tokenId}]]', function(result) {
                document.getElementById('instanceList').innerHTML = result;
                aliceJs.showTotalCount(document.querySelectorAll('.instance-list').length);
                let instanceDtEle = document.querySelectorAll('td[name=instanceDt]');
                for (let i = 0; i < instanceDtEle.length; i++) {
                    if (instanceDtEle[i].textContent !== '') {
                        instanceDtEle[i].textContent = i18n.userDateTime(instanceDtEle[i].textContent);
                    }
                }
                // 스크롤바
                OverlayScrollbars(document.querySelector('.list-body'), { className: 'scrollbar' });
            }, null, showProgressbar);
        }

        // 관련문서 추가
        function saveTokenList() {
            let checked = document.querySelectorAll('input[name=chk]:checked');
            if (checked.length === 0) {
                aliceAlert.alertWarning(i18n.msg('token.msg.selectToken'));
                return;
            } else {
                let jsonArray = new Array();
                for (let i = 0; i < checked.length; i++) {
                    let jsonObject = new Object();
                    jsonObject.folderId = '[[${folderId}]]';
                    jsonObject.instanceId = checked[i].value;
                    jsonArray.push(jsonObject);
                }
                restSubmit('POST', '/rest/folders', function() {
                    aliceDocument.createTokenInfoTab();
                    tokenListModal.hide();
                }, jsonArray, true);
            }
        }

        // 관련 문서 모달 내부 Template
        function createModalContent(data) {
            return `<div class="related-instance-list">` +
                       `<input class="search col-5 mr-2" type="text" name="search" id="search" maxlength="100" placeholder="${i18n.msg('token.label.relatedInstancePlaceholder')}"/><span id="spanTotalCount" class="search-count"></span>` +
                       `<div class="table-set" id="instanceList"></div>` +
                    `</div>`;
        }

        // 관련문서 모달
        function openRelatedToken(tokenId, search) {
            tokenListModal = new modal({
                title: i18n.msg('token.label.relatedInstance'),
                body: createModalContent(),
                classes: 'token-list',
                buttons: [{
                    content: i18n.msg('common.btn.select'),
                    classes: "point-fill",
                    bindKey: false,
                    callback: function(modal) {
                        saveTokenList();
                    }
                },{
                    content: i18n.msg('common.btn.cancel'),
                    classes: "default-line",
                    bindKey: false,
                    callback: function(modal) {
                        modal.hide();
                    }
                }],
                close: {
                    closable: false,
                },
                onCreate: function(modal) {
                    document.getElementById('search').addEventListener('keyup', function() {
                        getInstanceList(this.value, false);
                    });
                    getInstanceList(document.getElementById('search').value, true);
                }
            });
            tokenListModal.show();
        }

        function openProcessStatusPopUp() {
            window.open('/process/[[${instanceId}]]/status', 'process_status_[[${instanceId}]]', 'width=1300, height=500');
        }

        function openTokenEdit(tokenId) {
            const _width = 1500, _height = 920;
            const _left = Math.ceil((window.screen.width - _width) / 2);
            const _top = Math.ceil((window.screen.height - _height) / 4);
            window.open('/tokens/' + tokenId + '/view', 'token_' + tokenId, 'width=' + (screen.width - 50) + ', height=' + (screen.height - 150) + ', left=' + _left + ', top=' + _top);
        }

        function restSubmit(method, url, result, data, showProgressbar) {
            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(data),
                contentType: 'application/json',
                showProgressbar: showProgressbar,
                callbackFunc: function (response) {
                    result(response.responseText);
                }
            };
            aliceJs.sendXhr(opt);
        }

        /*]]>*/
    </script>
</th:block>
</html>
