<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/itsm/pageType/pagingListLayout">
<head>
    <title th:text="#{sla.metricYear.label.metricYearStatus}"></title>
</head>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{sla.metricYear.label.metricYearStatus}"></h1>
</div>
<div layout:fragment="pageSearching">
    <form id="searchFrm">
        <input type="text" class="z-input i-date-picker search-date col-3 mr-2" id="year" name="year"/>
        <th:block th:replace="layout/itsm/fragment/totalCountFragment :: totalCountFragment"></th:block>
        <div class="mt-5">
            <p class="font-2" th:text="#{sla.metricYear.label.resultScore}"></p>
            <p id="resultScore" class="font-bold font-4 mt-1">
                <span></span>
                <span th:text="#{sla.metricYear.label.option.score}" th:title="#{sla.metricYear.label.option.score}"></span>
            </p>
        </div>
    </form>
    <div class="ml-auto">
        <button type="button" class="z-button-icon secondary" id="btnExcelDownload" name="btnExcelDownload"
                th:onclick="|javascript:onExcelDownload()|" th:title="#{common.btn.export}">
            <img class="load-svg" th:src="@{/assets/media/icons/icon_download_xls.svg}" />
        </button>
    </div>
</div>
<div layout:fragment="pageList">
    <div class="z-list-content flex-row" id="metricYearStatusList"></div>
</div>
</body>
<script layout:fragment="pageScript" th:inline="javascript">
    /*<![CDATA[*/
    let yearDt = i18n.getYear();

    window.onload = function () {
        const yearDtElement = document.getElementById('year');
        yearDtElement.value = yearDt;
        zDateTimePicker.initYearPicker(yearDtElement, setDatePicker);

        getList();
    };

    function setDatePicker(element, picker) {
        if (typeof picker === 'undefined') return false;
        if (document.getElementById('year').value !== '' && element.value !== '') getList();
    }

    /**
     * 연도별 SLA 지표관리 검색
     */
    function getList(pageNum = 1) {
        const urlParam = '/sla/metrics/annual?year='
                        + document.getElementById('year').value.toString().substring(0, 4)
                        + '&pageNum=' + pageNum;
        aliceJs.fetchText(urlParam, {
            method: 'GET'
        }).then((htmlData) => {
            const listBody = document.getElementById('metricYearStatusList')
            listBody.innerHTML = htmlData;
            setMetricValueFormat(listBody);

            let totalWeight = 0;
            const resultScore = document.querySelector('#resultScore span:first-child');
            document.querySelectorAll('.result-value').forEach(elem => {
                const numWeightValue =  Number(elem.textContent);
                totalWeight += numWeightValue;
                resultScore.textContent = totalWeight;
            });
        });
    }

    /**
     * 서버에서 전달받은 지표값 포맷을 변경한다.
     */
    function setMetricValueFormat(elem) {
        elem.querySelectorAll('.metric-value').forEach(value => {
            const userMetricValue = value.textContent.replace(/.?0+$/, ''); // '.' 뒤에 '0'만 오는 경우 제거
            value.textContent = userMetricValue;
            value.setAttribute('title', userMetricValue);
        });
    }

    /**
     * Chart view 화면 호출 (Modal)
     */
    function openChartViewModal(chartName, htmlData) {
        let modalOptions = {
            title: chartName,
            body: htmlData,
            classes: 'chart-view-modal',
            buttons: [{
                content: i18n.msg('common.btn.close'),
                classes: 'z-button secondary',
                bindKey: false,
                callback: function (modal) {
                    zChartManager.destroy();
                    modal.hide();
                }
            }],
            close: {
                closable: false,
            },
            onCreate: function () {
                getChart(chartId);
            }
        };

        const chartViewModal = new modal(modalOptions);
        chartViewModal.show();
    }

    function getChart() {
        const url = '/rest/sla/metrics/annual/'
                    + document.getElementById('metricChartName').value.toString().substring(0, 4)
                    + document.getElementById('metricChartYear').value
                    + 'priview';
        aliceJs.fetchJson(url, {
            method: 'GET',
            showProgressbar: true
        }).then((response) => {
            if (response.status !== aliceJs.response.success) { return false; }
            // 차트 초기화
            zChartManager.load(response.data);
        });
    }

    function onExcelDownload() {
        const search = aliceJs.serialize(document.getElementById('searchFrm'));
        console.log(search);
        aliceJs.fetchDownload({
            url: '/rest/sla/metrics/annual/excel?' + search,
            fileName: i18n.msg('sla.metricYear.label.metricYearStatus') + '_' + new Date().toISOString().substring(0, 10).replace(/-/g, '')
        });
    }
    /*]]>*/
</script>
</html>
