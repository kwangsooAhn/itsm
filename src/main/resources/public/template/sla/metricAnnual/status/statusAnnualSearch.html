<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/itsm/pageType/pagingListLayout">
<head>
    <title th:text="#{sla.metricYear.label.metricYearStatus}"></title>
</head>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{sla.metricYear.label.metricYearStatus}"></h1>
</div>
<div layout:fragment="pageSearching">
    <form id="searchFrm">
        <input type="text" class="z-input i-date-picker search-date col-3 mr-2" id="year" name="year"/>
        <th:block th:replace="layout/itsm/fragment/totalCountFragment :: totalCountFragment"></th:block>
    </form>
    <div class="ml-auto">
        <button type="button" class="z-button-icon secondary" id="btnExcelDownload" name="btnExcelDownload"
                th:onclick="|javascript:onExcelDownload()|" th:title="#{common.btn.export}">
            <img class="load-svg" th:src="@{/assets/media/icons/icon_download_xls.svg}" />
        </button>
    </div>
</div>
<div layout:fragment="pageList">
    <div class="z-list-content flex-row" id="metricYearStatusList"></div>
</div>
</body>
<script layout:fragment="pageScript" th:inline="javascript">
    /*<![CDATA[*/
    let yearDt = i18n.getYear();

    window.onload = function () {
        const yearDtElement = document.getElementById('year');
        yearDtElement.value = yearDt;
        zDateTimePicker.initYearPicker(yearDtElement, setDatePicker);

        getList();
    };

    function setDatePicker(element, picker) {
        if (typeof picker === 'undefined') return false;
        if (document.getElementById('year').value !== '' && element.value !== '') getList();
    }

    /**
     * 연도별 SLA 지표관리 검색
     */
    function getList(pageNum = 1) {
        const urlParam = '/sla/metrics?year=' + document.getElementById('year').value.toString().substring(0, 4) + '&pageNum=' + pageNum;
        aliceJs.fetchText(urlParam, {
            method: 'GET'
        }).then((htmlData) => {
            const listBody = document.getElementById('metricYearStatusList')
            listBody.innerHTML = htmlData;
            setMetricValueFormat(listBody);

            let totalWeight = 0;
            const resultScore = document.getElementById('resultScore');
            document.querySelectorAll('.result-value').forEach(elem => {
                const numWeightValue =  Number(elem.textContent);
                totalWeight += numWeightValue;
            });
        });
    }

    /**
     * 서버에서 전달받은 지표값 포맷을 변경한다.
     */
    function setMetricValueFormat(elem) {
        elem.querySelectorAll('.metric-value').forEach(value => {
            const userMetricValue = value.textContent.replace(/.?0+$/, ''); // '.' 뒤에 '0'만 오는 경우 제거
            value.textContent = userMetricValue;
            value.setAttribute('title', userMetricValue);
        });
    }

    function onExcelDownload() {
        document.getElementById('searchToDt').value = i18n.makeUserDate(document.getElementById('toDt').value, {'days': 1});
        const search = aliceJs.serialize(document.getElementById('frmSearch'));
        aliceJs.fetchDownload({
            url: '/rest/sla/metrics/annual/excel?' + search,
            fileName: i18n.msg('token.label.list') + '_' + new Date().toISOString().substring(0, 10).replace(/-/g, '')
        });
    }
    /*]]>*/
</script>
</html>
