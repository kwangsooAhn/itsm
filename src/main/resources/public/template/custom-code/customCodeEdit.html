<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/defaultLayout">
<head>
    <title th:text="${customCode != null} ? #{customCode.label.edit} : #{customCode.label.register}"></title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="flex-column edit">
        <div class="custom-code-header">
            <div class="header-title flex-row align-items-baseline">
                <h1 th:text="#{customCode.label.customCode}"></h1>
                <h6 class="description" th:text="#{customCode.msg.editDescription}"></h6>
            </div>
        </div>
        <div class="custom-code-content-edit">
            <div class="flex-column edit-row">
                <label for="customCodeName">
                    <span th:text="#{customCode.label.name}"></span>
                    <span class="required"></span>
                </label>
                <input type="text" id="customCodeName" required="required" maxlength="110"
                       th:value="${customCode?.customCodeName}">
            </div>
            <div class="flex-column edit-row">
                <label>
                    <span th:text="#{customCode.label.type}"></span>
                    <span class="required"></span>
                </label>
                <div class="flex-row mr-auto">
                    <label class="radio mr-4" for="table" tabindex="0">
                        <input id="table" name="type" type="radio"
                               th:checked="${customCode?.type == null || customCode?.type == 'table'}"
                               onclick="changeContainer('table')">
                        <span></span>
                        <span class="label" th:text="#{customCode.label.table}"></span>
                    </label>
                    <label class="radio" for="code" tabindex="0">
                        <input id="code" name="type" type="radio"
                               th:checked="${customCode?.type == 'code'}"
                               onclick="changeContainer('code')">
                        <span></span>
                        <span class="label" th:text="#{customCode.label.code}"></span>
                    </label>
                </div>
            </div>
            <!-- 타입: table-->
            <div id="type-table-container"
                 th:style="${customCode?.type == null || customCode?.type == 'table' ? '' : 'display: none'}">
                <div class="flex-column edit-row">
                    <label>
                        <span th:text="#{customCode.label.targetTable}"></span>
                        <span class="required"></span>
                    </label>
                    <select id="targetTable">
                        <option th:each="customCodeTable: ${customCodeTableList}"
                                th:value="${customCodeTable.customCodeTable}"
                                th:text="|${customCodeTable.customCodeTableName}(${customCodeTable.customCodeTable})|"
                                th:selected="${customCodeTable.customCodeTable} == ${customCode?.targetTable}">
                        </option>
                    </select>
                </div>
                <div class="flex-column edit-row">
                    <label for="searchColumn">
                        <span th:text="#{customCode.label.searchColumn}"></span>
                        <span class="required"></span>
                    </label>
                    <select id="searchColumn"></select>
                </div>
                <div class="flex-column edit-row">
                    <label for="valueColumn">
                        <span th:text="#{customCode.label.valueColumn}"></span>
                        <span class="required"></span>
                    </label>
                    <select id="valueColumn"></select>
                </div>
                <div class="flex-column edit-row">
                    <div class="under-bar">
                        <label id="conditionLabel">
                            <span th:text="#{customCode.label.condition}"></span>
                        </label>
                        <button type="button" class="default-line plus float-right" onclick="addCondition()">
                            <span class="icon-plus"></span>
                        </button>
                    </div>
                    <div id="condition"></div>
                </div>
            </div>
            <!-- 타입: 코드 -->
            <div id="type-code-container" th:style="${customCode?.type == 'code' ? '' : 'display: none'}">
                <div class="flex-column edit-row">
                    <label>
                        <span th:text="#{customCode.label.pCode}"></span>
                        <span class="required"></span>
                    </label>
                    <input type="text" id="pCode" maxlength="100" th:value="${customCode?.pCode}">
                </div>
            </div>
            <div class="flex-row justify-content-end edit-row">
                <div class="btn-list">
                    <button class="point-fill" th:if="${customCode == null}" sec:authorize="hasAuthority('custom.code.create')"
                            onclick="actionCustomCode('post')" th:text="#{common.btn.register}"></button>
                    <button class="point-fill" th:if="${customCode?.customCodeId}" sec:authorize="hasAuthority('custom.code.update')"
                            th:disabled="${!customCode.enabled}" onclick="actionCustomCode('put')" th:text="#{common.btn.modify}">
                    </button>
                    <button class="default-fill" th:if="${customCode?.customCodeId}" sec:authorize="hasAuthority('custom.code.delete')"
                            th:disabled="${!customCode.enabled}" onclick="actionCustomCode('delete')" th:text="#{common.btn.delete}">
                    </button>
                    <a class="btn default-line" href="/custom-codes/search" th:text="#{common.btn.list}"></a>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script th:inline="javascript" type="text/javascript">
        /*<![CDATA[*/
        //상태값
        const STATUS_SUCCESS = '0';
        const STATUS_ERROR_CUSTOM_CODE_USED = '1';
        const STATUS_ERROR_CUSTOM_CODE_NAME_DUPLICATION = '2';
        const STATUS_ERROR_CUSTOM_CODE_P_CODE_NOT_EXIST = '3';

        window.onload = function() {
            document.getElementById('customCodeName').focus();
            const targetTable = document.getElementById('targetTable');
            const condition = document.getElementById('condition');
            targetTable.addEventListener('change', function () {
                initColumnSelectBox(this.value);
                while (condition.hasChildNodes()) { condition.removeChild(condition.firstChild); }
            });
            initColumnSelectBox(targetTable.value);
            initCondition();
            const conditionElem = document.querySelector('input[name=conditionValue]');
            if (conditionElem !== null) {
                document.getElementById('conditionLabel').insertAdjacentHTML('beforeend', `<span class="required"></span>`);
            }
            // 스크롤바 추가
            OverlayScrollbars(document.querySelector('.edit'), {className: 'scrollbar'});
        };

        //column select box 초기화
        function initColumnSelectBox(value) {
            const searchColumn = document.getElementById('searchColumn');
            const valueColumn = document.getElementById('valueColumn');

            //remove Child
            while (searchColumn.hasChildNodes()) { searchColumn.removeChild(searchColumn.firstChild); }
            while (valueColumn.hasChildNodes()) { valueColumn.removeChild(valueColumn.firstChild); }

            const customCodeColumnList = /*[[${customCodeColumnList}]]*/'';
            const searchColumnValue = /*[[${customCode?.searchColumn}]]*/'';
            const valueColumnValue = /*[[${customCode?.valueColumn}]]*/'';

            for (let i = 0; i < customCodeColumnList.length; i++) {
                const customCodeColumn = customCodeColumnList[i];
                if (customCodeColumn.customCodeTable === value) {
                    let option = document.createElement('option');
                    option.value = customCodeColumn.customCodeColumn;
                    option.text = customCodeColumn.customCodeColumnName + '(' + customCodeColumn.customCodeColumn + ')';
                    switch (customCodeColumn.customCodeType) {
                        case 'search':
                            option.selected = (searchColumnValue === customCodeColumn.customCodeColumn);
                            searchColumn.append(option);
                            break;
                        case 'value':
                            option.selected = (valueColumnValue === customCodeColumn.customCodeColumn);
                            valueColumn.append(option);
                            break;
                    }
                }
            }
            // for designed select
            // 동적으로 표시되는 select 에 대한 designed select 초기화.
            aliceJs.initDesignedSelectTag();
        }

        //condition 초기화
        function initCondition() {
            const condition = JSON.parse(/*[[${customCode?.condition}]]*/'');
            if (condition !== null) {
                Object.keys(condition).forEach(function (data) {
                    drawCondition({key: data, value: condition[data]});
                })
            }
        }

        //Add Condition
        function addCondition() {
            const searchColumnLength = document.getElementById('searchColumn').childNodes.length;
            const conditionLen = document.getElementById('condition').childNodes.length;
            if (conditionLen < searchColumnLength) {
                if (conditionLen === 0) {
                    document.getElementById('conditionLabel').insertAdjacentHTML('beforeend', `<span class="required"></span>`);
                }
                drawCondition();
            } else {
                aliceJs.alertWarning(i18n.msg('customCode.msg.addCondition', searchColumnLength));
            }
        }

        function drawCondition(param) {
            const divRow = document.createElement('div');
            divRow.classList.add('flex-row', 'edit-row');

            const keySelect = document.createElement('select');
            keySelect.classList.add('condition');
            const searchColumn = document.getElementById('searchColumn');
            for (let i = 0; i < searchColumn.length; i++) {
                let option = searchColumn[i].cloneNode(true);
                option.selected = (typeof param !== 'undefined') ? (param.key === option.value) : '';
                keySelect.appendChild(option);
            }
            const equalSpan = document.createElement('span');
            equalSpan.textContent = '=';
            equalSpan.classList.add('equal', 'ml-1', 'mr-1');

            const valueInput = document.createElement('input');
            valueInput.classList.add('condition');
            valueInput.type = 'text';
            valueInput.name = 'conditionValue';
            valueInput.maxLength = 100;
            valueInput.value = (typeof param !== 'undefined') ? param.value : '';

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('btn-minus');
            const deleteIcon = document.createElement('span');
            deleteIcon.classList.add('icon-delete-gray', 'ml-1');
            deleteBtn.appendChild(deleteIcon);
            deleteBtn.addEventListener('click', function () {
                aliceJs.confirmIcon(i18n.msg('customCode.msg.confirmDeleteCondition'), function () {
                    const row = deleteBtn.parentNode;
                    const conditionElems = document.querySelectorAll('input[name=conditionValue]');
                    if (conditionElems.length === 0) {
                        const conditionLabel = document.getElementById('conditionLabel');
                        conditionLabel.removeChild(conditionLabel.children[1]);
                    }
                    row.remove();

                }, null);
            });

            divRow.appendChild(keySelect);
            divRow.appendChild(equalSpan);
            divRow.appendChild(valueInput);
            divRow.appendChild(deleteBtn);
            document.getElementById('condition').appendChild(divRow);
        }

        //Change Container
        function changeContainer(type) {
            if (type === 'table') {
                document.getElementById('type-table-container').style.display = '';
                document.getElementById('type-code-container').style.display = 'none';
            } else if (type === 'code') {
                document.getElementById('type-table-container').style.display = 'none';
                document.getElementById('type-code-container').style.display = '';
            }
        }

        //Get Type Id
        function getTypeId() {
            let type = document.getElementsByName('type');
            for (let i = 0; i < type.length; i++) {
                if (type[i].checked) {
                    return type[i].id;
                }
            }
        }

        //empty Check
        function emptyCheck(type) {
            const conditionElems = document.querySelectorAll('input[name=conditionValue]');
            if (type === 'table') {
                if (isEmpty('customCodeName', 'customCode.msg.enterCustomCode')) { return false; }
                if (isEmpty('targetTable', 'customCode.msg.enterTableTarget')) { return false; }
                if (isEmpty('searchColumn', 'customCode.msg.enterSearchColumn')) { return false; }
                for (let i = 0; i < conditionElems.length; i++) {
                    if (conditionElems[i].value.trim() === '') {
                        aliceJs.alertWarning(i18n.msg('customCode.msg.enterCondition'));
                        conditionElems[i].focus();
                        return false;
                    }
                }
                return !isEmpty('valueColumn', 'customCode.msg.enterValueColumn');
            } else {
                if (isEmpty('customCodeName', 'customCode.msg.enterCustomCode')) { return false; }
                return !isEmpty('pCode', 'customCode.msg.enterPCode');
            }
        }

        //insert/update/delete Custom Code
        function actionCustomCode(method) {
            if (method === 'post' || method === 'put') {
                const type = getTypeId();
                if (emptyCheck(type)) {
                    let data = {
                        customCodeName: document.getElementById('customCodeName').value,
                        type: type,
                    };
                    if (type === 'table') {
                        data.targetTable = document.getElementById('targetTable').value;
                        data.searchColumn = document.getElementById('searchColumn').value;
                        data.valueColumn = document.getElementById('valueColumn').value;

                        let conditionData = {};
                        let div = document.getElementById('condition').childNodes;
                        for (let i = 0; i < div.length; i++) {
                            let selectValue = div[i].getElementsByTagName('select')[0].value;
                            if (typeof conditionData[selectValue] === 'undefined') {
                                conditionData[selectValue] = div[i].getElementsByTagName('input')[0].value;
                            } else {
                                aliceJs.alertWarning(i18n.msg('customCode.msg.selectNotDuplicateSearchColumn'));
                                return false;
                            }
                        }
                        data.condition = JSON.stringify(conditionData);
                    } else {
                        data.pCode = document.getElementById('pCode').value;
                    }
                    if (method === 'put') {
                        data.customCodeId = /*[[${customCode?.customCodeId}]]*/'';
                    }
                    restSubmit(method, '/rest/custom-codes', data);
                }
            } else if (method === 'delete') {
                aliceJs.confirmIcon(i18n.msg('common.msg.confirmDelete'), restSubmit, null, 'delete', '/rest/custom-codes/' + /*[[${customCode?.customCodeId}]]*/'');
            }
        }

        //REST API
        function restSubmit(method, url, data) {
            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(data),
                contentType: 'application/json',
                callbackFunc: function(response) {
                    if (method === 'post' || method === 'put') {
                        switch (response.responseText) {
                            case STATUS_SUCCESS:
                                aliceJs.alertSuccess(i18n.msg('common.msg.save'), function () {
                                    location.href = '/custom-codes/search';
                                });
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_USED:
                                aliceJs.alertSuccess(i18n.msg('customCode.msg.customCodeUsed'));
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_NAME_DUPLICATION:
                                aliceJs.alertWarning(i18n.msg('customCode.msg.duplicateCustomCodeName'));
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_P_CODE_NOT_EXIST:
                                aliceJs.alertWarning(i18n.msg('customCode.msg.pCodeNotExist'));
                                break;
                            default :
                                aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                                break;
                        }
                    } else if (method === 'delete'){
                        switch (response.responseText) {
                            case STATUS_SUCCESS:
                                aliceJs.alertSuccess(i18n.msg('common.msg.delete'), function () {
                                    location.href = '/custom-codes/search';
                                });
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_USED:
                                aliceJs.alertWarning(i18n.msg('customCode.msg.customCodeUsed'));
                                break;
                            default:
                                aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                                break;
                        }
                    }
                }
            };
            aliceJs.sendXhr(opt);
        }
        /*]]>*/
    </script>
</html>
