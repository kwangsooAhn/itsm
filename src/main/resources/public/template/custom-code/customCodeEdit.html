<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
    layout:decorator="layout/defaultLayout">
<head>
    <title th:text="#{customCode.label.customCode}"></title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="contents-edit scroll-wrap">
        <div class="header">
            <div class="page-title">
                <h1 th:text="#{customCode.label.customCode}"></h1>
                <h6 class="title-description" th:text="#{customCode.label.customCode}"></h6>
            </div>
        </div>
        <div class="edit">
            <div class="form-set">
                <label class="required" th:text="#{customCode.label.name}" for="customCodeName"></label>
                <input type="text" id="customCodeName" required="required" maxlength="100"
                       th:value="${customCode?.customCodeName}">
            </div>
            <div class="form-set">
                <label class="required" th:text="#{customCode.label.type}"></label>
                <div class="radio-row">
                    <label>
                        <input id="table" name="type" type="radio"
                               th:checked="${customCode?.type == null || customCode?.type == 'table'}"
                               th:text="#{customCode.label.table}" onclick="changeContainer('table')">
                    </label>
                    <label>
                        <input id="code" name="type" type="radio"
                               th:checked="${customCode?.type == 'code'}"
                               th:text="#{customCode.label.code}" onclick="changeContainer('code')">
                    </label>
                </div>
            </div>
            <!-- 타입: table-->
            <div id="type-table-container"
                 th:style="${customCode?.type == null || customCode?.type == 'table' ? '' : 'display: none'}">
                <div class="form-set">
                    <label class="required" th:text="#{customCode.label.targetTable}"></label>
                    <select id="targetTable">
                        <option th:each="customCodeTable: ${customCodeTableList}"
                                th:value="${customCodeTable.customCodeTable}"
                                th:text="|${customCodeTable.customCodeTableName}(${customCodeTable.customCodeTable})|"
                                th:selected="${customCodeTable.customCodeTable} == ${customCode?.targetTable}">
                        </option>
                    </select>
                </div>
                <div class="form-set">
                    <label class="required" th:text="#{customCode.label.searchColumn}"></label>
                    <select id="searchColumn"></select>
                </div>
                <div class="form-set">
                    <label class="required" th:text="#{customCode.label.valueColumn}"></label>
                    <select id="valueColumn"></select>
                </div>
                <div class="form-set">
                    <div class="row">
                        <label th:text="#{customCode.label.condition}"></label>
                        <button class="plus" onclick="addCondition()"></button>
                    </div>
                    <div id="condition"></div>
                </div>
            </div>

            <!-- 타입: 코드 -->
            <div id="type-code-container" th:style="${customCode?.type == 'code' ? '' : 'display: none'}">
                <div class="form-set">
                    <label class="required" th:text="#{customCode.label.pCode}"></label>
                    <input type="text" id="pCode" maxlength="100" th:value="${customCode?.pCode}">
                </div>
            </div>
            <div class="btn-bar">
                <button class="default-line" onclick="location.href='/custom-codes/search'"
                        th:text="#{common.btn.list}"></button>
                <button class="point-fill" th:if="${customCode == null}" sec:authorize="hasAuthority('custom.code.create')"
                        onclick="actionCustomCode('post')" th:text="#{common.btn.save}"></button>
                <button class="point-fill" th:if="${customCode?.customCodeId}" sec:authorize="hasAuthority('custom.code.update')"
                        th:disabled="${!customCode.enabled}" onclick="actionCustomCode('put')" th:text="#{common.btn.modify}">
                </button>
                <button class="default-fill" th:if="${customCode?.customCodeId}" sec:authorize="hasAuthority('custom.code.delete')"
                        th:disabled="${!customCode.enabled}" onclick="actionCustomCode('delete')" th:text="#{common.btn.delete}">
                </button>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script th:inline="javascript" type="text/javascript">
        /*<![CDATA[*/
        //상태값
        const STATUS_SUCCESS = '0';
        const STATUS_ERROR_CUSTOM_CODE_USED = '1';
        const STATUS_ERROR_CUSTOM_CODE_NAME_DUPLICATION = '2';
        const STATUS_ERROR_CUSTOM_CODE_P_CODE_NOT_EXIST = '3';

        window.onload = function() {
            const targetTable = document.getElementById('targetTable');
            const condition = document.getElementById('condition');
            targetTable.addEventListener('change', function () {
                initColumnSelectBox(this.value);
                while (condition.hasChildNodes()) { condition.removeChild(condition.firstChild); }
            });
            initColumnSelectBox(targetTable.value);
            initCondition();
        };

        //column select box 초기화
        function initColumnSelectBox(value) {
            const searchColumn = document.getElementById('searchColumn');
            const valueColumn = document.getElementById('valueColumn');

            //remove Child
            while (searchColumn.hasChildNodes()) { searchColumn.removeChild(searchColumn.firstChild); }
            while (valueColumn.hasChildNodes()) { valueColumn.removeChild(valueColumn.firstChild); }

            const customCodeColumnList = /*[[${customCodeColumnList}]]*/'';
            const searchColumnValue = /*[[${customCode?.searchColumn}]]*/'';
            const valueColumnValue = /*[[${customCode?.valueColumn}]]*/'';

            for (let i = 0; i < customCodeColumnList.length; i++) {
                const customCodeColumn = customCodeColumnList[i];
                if (customCodeColumn.customCodeTable === value) {
                    let option = document.createElement('option');
                    option.value = customCodeColumn.customCodeColumn;
                    option.text = customCodeColumn.customCodeColumnName + '(' + customCodeColumn.customCodeColumn + ')';
                    switch (customCodeColumn.customCodeType) {
                        case 'search':
                            option.selected = (searchColumnValue === customCodeColumn.customCodeColumn);
                            searchColumn.append(option);
                            break;
                        case 'value':
                            option.selected = (valueColumnValue === customCodeColumn.customCodeColumn);
                            valueColumn.append(option);
                            break;
                    }
                }
            }
        }

        //condition 초기화
        function initCondition() {
            const condition = JSON.parse(/*[[${customCode?.condition}]]*/'');
            if (condition !== null) {
                Object.keys(condition).forEach(function (data) {
                    drawCondition({key: data, value: condition[data]});
                })
            }
        }

        //Add Condition
        function addCondition() {
            const searchColumnLength = document.getElementById('searchColumn').childNodes.length;
            if (document.getElementById('condition').childNodes.length < searchColumnLength) {
                drawCondition();
            } else {
                aliceJs.alertWarning(i18n.get('customCode.msg.addCondition', searchColumnLength));
            }
        }

        function drawCondition(param) {
            const divFormSet = document.createElement('div');
            divFormSet.classList.add('form-set');
            const divRow = document.createElement('div');
            divRow.classList.add('row');
            const keySelect = document.createElement('select');
            keySelect.classList.add('column-4');
            const searchColumn = document.getElementById('searchColumn');
            for (let i = 0; i < searchColumn.length; i++) {
                let option = searchColumn[i].cloneNode(true);
                option.selected = (typeof param !== 'undefined') ? (param.key === option.value) : '';
                keySelect.appendChild(option);
            }
            const equalSpan = document.createElement('span');
            equalSpan.textContent = '=';
            const valueInput = document.createElement('input');
            valueInput.classList.add('column-7');
            valueInput.type = 'text';
            valueInput.maxLength = 100;
            valueInput.value = (typeof param !== 'undefined') ? param.value : '';
            const minusBtn = document.createElement('button');
            minusBtn.classList.add('minus');
            minusBtn.addEventListener('click', function () {
                minusBtn.parentNode.parentNode.remove();
            });

            divRow.appendChild(keySelect);
            divRow.appendChild(equalSpan);
            divRow.appendChild(valueInput);
            divRow.appendChild(minusBtn);
            divFormSet.appendChild(divRow);
            document.getElementById('condition').appendChild(divFormSet);
        }

        //Change Container
        function changeContainer(type) {
            if (type === 'table') {
                document.getElementById('type-table-container').style.display = '';
                document.getElementById('type-code-container').style.display = 'none';
            } else if (type === 'code') {
                document.getElementById('type-table-container').style.display = 'none';
                document.getElementById('type-code-container').style.display = '';
            }
        }

        //Get Type Id
        function getTypeId() {
            let type = document.getElementsByName('type');
            for (let i = 0; i < type.length; i++) {
                if (type[i].checked) {
                    return type[i].id;
                }
            }
        }

        //empty Check
        function emptyCheck(type) {
            if (type === 'table') {
                if (isEmpty('customCodeName', 'customCode.msg.enterCustomCode')) { return false; }
                if (isEmpty('targetTable', 'customCode.msg.enterTableTarget')) { return false; }
                if (isEmpty('searchColumn', 'customCode.msg.enterSearchColumn')) { return false; }
                return !isEmpty('valueColumn', 'customCode.msg.enterValueColumn');
            } else {
                if (isEmpty('customCodeName', 'customCode.msg.enterCustomCode')) { return false; }
                return !isEmpty('pCode', 'customCode.msg.enterPCode');
            }
        }

        //insert/update/delete Custom Code
        function actionCustomCode(method) {
            if (method === 'post' || method === 'put') {
                const type = getTypeId();
                if (emptyCheck(type)) {
                    let data = {
                        customCodeName: document.getElementById('customCodeName').value,
                        type: type,
                    };
                    if (type === 'table') {
                        data.targetTable = document.getElementById('targetTable').value;
                        data.searchColumn = document.getElementById('searchColumn').value;
                        data.valueColumn = document.getElementById('valueColumn').value;

                        let conditionData = {};
                        let div = document.getElementById('condition').childNodes;
                        for (let i = 0; i < div.length; i++) {
                            let selectValue = div[i].getElementsByTagName('select')[0].value;
                            if (typeof conditionData[selectValue] === 'undefined') {
                                conditionData[selectValue] = div[i].getElementsByTagName('input')[0].value;
                            } else {
                                aliceJs.alertWarning(i18n.get('customCode.msg.selectNotDuplicateSearchColumn'));
                                return false;
                            }
                        }
                        data.condition = JSON.stringify(conditionData);
                    } else {
                        data.pCode = document.getElementById('pCode').value;
                    }
                    if (method === 'put') {
                        data.customCodeId = /*[[${customCode?.customCodeId}]]*/'';
                    }
                    restSubmit(method, '/rest/custom-codes', data);
                }
            } else if (method === 'delete') {
                aliceJs.deleteConfirm(restSubmit, '/rest/custom-codes/' + /*[[${customCode?.customCodeId}]]*/'');
            }
        }

        //REST API
        function restSubmit(method, url, data) {
            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(data),
                contentType: 'application/json',
                callbackFunc: function(response) {
                    if (method === 'post' || method === 'put') {
                        switch (response.responseText) {
                            case STATUS_SUCCESS:
                                aliceJs.alertSuccess(i18n.get('common.msg.save'), function () {
                                    location.href = '/custom-codes/search';
                                });
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_USED:
                                aliceJs.alertSuccess(i18n.get('customCode.msg.customCodeUsed'));
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_NAME_DUPLICATION:
                                aliceJs.alertWarning(i18n.get('customCode.msg.customCodeNameDuplication'));
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_P_CODE_NOT_EXIST:
                                aliceJs.alertWarning(i18n.get('customCode.msg.pCodeNotExist'));
                                break;
                            default :
                                aliceJs.alertDanger(i18n.get('common.msg.fail'));
                                break;
                        }
                    } else if (method === 'delete'){
                        switch (response.responseText) {
                            case STATUS_SUCCESS:
                                aliceJs.alertSuccess(i18n.get('common.msg.delete'), function () {
                                    location.href = '/custom-codes/search';
                                });
                                break;
                            case STATUS_ERROR_CUSTOM_CODE_USED:
                                aliceJs.alertWarning(i18n.get('customCode.msg.customCodeUsed'));
                                break;
                            default:
                                aliceJs.alertDanger(i18n.get('common.msg.fail'));
                                break;
                        }
                    }
                }
            };
            aliceJs.sendXhr(opt);
        }
        /*]]>*/
    </script>
</th:block>
</html>
