<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<body>
<div class="logo">
    <img class="navigation-logo" th:src="@{/assets/theme/{theme}/media/icons/(theme=${#authentication.details.theme})} + 'icon_logo.svg'" width="174.72" height="25" alt="Zenius ITSM">
</div>
<div class="navigation">
    <div class="breadcrumb">
    </div>
    <div class="navigation-config">
        <div class="notification-menu">
            <div class="notification-icon" onclick="toggleNotificationContainer();">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="27" viewBox="0 0 25 27">
                    <g transform="translate(-20 -858.5)">
                        <g>
                            <path class="notification-bell" d="M44.9,872.383a2.885,2.885,0,0,0-1.224-1.512,8.348,8.348,0,0,1-4.235,1.135,8.225,8.225,0,0,1-8.33-8.1,7.654,7.654,0,0,1,.528-2.833,8.006,8.006,0,0,0-4.9-.675,2.545,2.545,0,0,0-.222-.488,2.936,2.936,0,0,0-3.928-1.039,2.746,2.746,0,0,0-1.028,3.82,1.876,1.876,0,0,0,.317.433c-1.568,1.821-3.014,5.02-.567,9.744,1.458,2.444,2.4,6.036,1.75,8.008-.667,1.969-.142,2.764.442,3.482s2.235.931,3.668.135,7.982-4.521,7.982-4.521,6.584-3.633,8.028-4.443S45.262,873.221,44.9,872.383ZM24.031,861.3a7,7,0,0,0-1.014.7c-.028-.014-.04-.056-.068-.1a1.183,1.183,0,0,1,.444-1.674,1.3,1.3,0,0,1,1.736.459c.014.042.041.069.041.108A6.544,6.544,0,0,0,24.031,861.3Z"/>
                            <path class="notification-round" d="M45,863.9a5.558,5.558,0,1,1-5.557-5.4A5.48,5.48,0,0,1,45,863.9Z"/>
                        </g>
                        <path class="notification-bell" d="M32.088,883.4a4.5,4.5,0,0,0,6.014,1.529,4.217,4.217,0,0,0,1.64-5.814Z"/>
                    </g>
                </svg>
                <span class="notification-num" id="count"></span>
            </div>
            <div id="notification-container" class="notification-container"></div>
        </div>
        <div class="user-info-menu">
            <a th:href="@{/users/{userKey}/editSelf(userKey=${#authentication.details.userKey})}">
                <img class="user-profile" th:src="@{{avatarPath}(avatarPath=${#authentication.details.avatarPath})}" alt="profile pic"/>
                <span class="user-name" sec:authentication="details.userName"></span>
                <span class="my-modify"></span>
            </a>
        </div>
        <div class="logout-menu">
            <a href="javascript:logout()">
                <span class="my-logout"></span>
                <span th:text="#{common.btn.logout}"></span>
            </a>
        </div>
    </div>
</div>
<div>
    <form id="logoutForm" name="logoutForm" th:action="@{/logout}" method="post"></form>
</div>
</body>
<script type="text/javascript" th:inline="javascript">
    let notificationDiv = null;
    window.addEventListener('load', function() {
        notificationDiv = document.getElementById('notification-container');
        hiddenProgressBar();
        setInterval(function () {
            getNotificationList(true);
        }, 60000); // 60초 주기
        getNotificationList(true);

        document.addEventListener('click', notificationContainerOff, false);
        OverlayScrollbars(document.querySelectorAll('.scroll-wrap'), {className: 'scrollbar'});
    });

    function logout() {
        document.getElementById('logoutForm').submit();
    }

    function toggleNotificationContainer() {
        if (notificationDiv!== null) {
            if (notificationDiv.classList.contains('on')) {
                notificationDiv.classList.remove('on');
            } else {
                notificationDiv.classList.add('on');
            }
        }
    }

    function notificationContainerOff(e) {
        //알림창 내부를 클릭한 경우 동작하지 않는다.
        if (aliceJs.clickInsideElement(e, 'notification-container') || aliceJs.clickInsideElement(e, 'notification-menu')) { return false; }

        if (notificationDiv && notificationDiv.classList.contains('on')) {
            notificationDiv.classList.remove('on');
        }
    }

    // Get notification list.
    function getNotificationList(isShow) {
        restSubmitNotification('get', '/notifications/list', function (result) {
            notificationDiv.innerHTML = result;
            const count = document.getElementById('count');
            const noConfirmNotification = notificationDiv.querySelectorAll('div[is-confirm=false]'); // 확인 안된 알림
            count.innerText = noConfirmNotification.length.toString();
            if (noConfirmNotification.length !== 0 && !notificationDiv.parentNode.classList.contains('active')) {
                notificationDiv.parentNode.classList.add('active');
            }
            document.getElementById('total').innerText = '(' + noConfirmNotification.length + '/' +
                notificationDiv.querySelectorAll('div.notification:not(.noData)').length + ')';
            
            if (isShow) {
                const noDisplayNotification = notificationDiv.querySelectorAll('div[is-display=false]');
                noDisplayNotification.forEach(function (element) {
                    showNotification({
                        notificationId: element.id,
                        instanceId: element.getAttribute('instance-id'),
                        title: element.querySelector('.title').innerHTML,
                        date: element.querySelector('.date').innerHTML,
                        message: element.querySelector('.message').innerHTML
                    });
                });
            }
        });
    }

    // show notification popup.
    function showNotification(param) {
        let text = '<div class="icon"></div>' +
            '<div class="content"><div class="title">' + param.title + '</div>' +
            '<div class="message text-ellipsis">' + param.message + '</div>' +
            '<div class="date">' + param.date + '</div></div>';
        Toastify({
            text: text,
            duration: 5000,
            close: true,
            gravity: 'bottom',
            position: 'right',
            stopOnFocus: true,
            className: 'alice-toastify alice-toastify-content',
            onShow: function() {
                updateNotification(param.notificationId, 'display');
            },
            onClick: function() {
                openTokenPage(param.notificationId, param.instanceId);
            }
        }).showToast();
    }

    // TODO: 처리할 문서 화면 호출. 해당 문서가 처리되었을 때 이슈로 구현하지 않음. 일단 처리할 문서 목록 화면으로 이동하도록 함.
    // Open token page.
    function openTokenPage(notificationId, instanceId) {
        console.log('[openTokenPage] instance id : ' + instanceId);
        location.href = '/tokens/search';
        updateNotification(notificationId, 'confirm');
    }

    // Update notification.
    function updateNotification(notificationId, target) {
        restSubmitNotification('put', '/rest/notifications/' + notificationId + '/' + target, function () {
            getNotificationList(false);
        });
    }

    // Delete notification.
    function deleteNotification(notificationId) {
        restSubmitNotification('delete', '/rest/notifications/' + notificationId, function () {
            getNotificationList(false);
        });
    }

    // REST API.
    function restSubmitNotification(method, url, result) {
        const opt = {
            method: method,
            url: url,
            showProgressbar: false,
            callbackFunc: function (response) {
                result(response.responseText);
            }
        };
        aliceJs.sendXhr(opt);
    }
</script>
</html>
