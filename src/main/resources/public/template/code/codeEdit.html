<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorator="layout/defaultLayout">
<head>
    <title th:text="#{code.label.code}"></title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="contents-tree-edit">
        <div class="tree-area">
            <div class="page-title">
                <h1 th:text="#{menu.config.code}">></h1>
                <h6 class="title-description" th:text="#{code.msg.description}"></h6>
            </div>
            <div class="search-area">
                <div class="left">
                    <input id="search" class="search column-4">
                    <span id="totalCount" class="txt-num"></span>
                </div>
                <div class="right">
                    <button class="default-fill" id="btnCreate" name="btnCreate" type="button"
                            sec:authorize="hasAuthority('code.create')" th:onclick="|javascript:onCreate()|" th:text="#{common.btn.add}"></button>
                </div>
            </div>
            <div class="list">
                <div id="treeList"></div>
            </div>
        </div>
        <div class="edit-area">
            <div class="scroll-wrap">
                <div class="form-wrap">
                    <div class="form-row">
                        <div class="form-set column-2">
                            <label class="required" th:text="#{code.label.code}" for="txtCode"></label>
                            <input id="txtCode" name="txtCode" type="text" th:value="${codeDetail?.code}" maxlength="100"/>
                        </div>
                        <div class="form-set column-2">
                            <label th:text="#{code.label.pCode}" for="txtPCode"></label>
                            <input id="txtPCode" name="txtPCode" type="text" th:value="${codeDetail?.pCode}" maxlength="100"/>
                        </div>
                    </div>
                    <div class="form-set">
                        <label th:text="#{code.label.codeValue}" for="txtCodeDesc"></label>
                        <textarea id="txtCodeDesc" name="txtCodeDesc" th:maxlength="200" th:rows="7" th:text="${codeDetail?.codeValue}"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-set column-2">
                            <label th:text="#{common.label.createUser}"></label>
                            <input id="txtCreateUserName" name="txtCreateUserName" type="text" th:value="${codeDetail?.createUserName}" th:disabled="true" maxlength="100"/>
                        </div>
                        <div class="form-set column-2">
                            <label th:text="#{common.label.updateUser}"></label>
                            <input id="txtUpdateUserName" name="txtUpdateUserName" type="text" th:value="${codeDetail?.updateUserName}" th:disabled="true" maxlength="100"/>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-set column-2">
                            <label th:text="#{common.label.createDate}"></label>
                            <input id="txtCreateDt" name="txtCreateDt" class="date-icon" type="text" th:disabled="true" maxlength="100"/>
                        </div>
                        <div class="form-set column-2">
                            <label th:text="#{common.label.updateDate}"></label>
                            <input id="txtUpdateDt" name="txtUpdateDt" class="date-icon" type="text" th:disabled="true" maxlength="100"/>
                        </div>
                    </div>
                    <div class="btn-bar margin-top-50">
                        <button sec:authorize="hasAuthority('code.delete')"
                                class="point-fill" type="button" id="btnDelete" name="btnDelete"
                                th:onclick="|javascript:onDelete()|" th:text="#{common.btn.delete}"></button>
                        <button sec:authorize="hasAuthority('code.update')"
                                class="point-fill" type="button" id="btnUpdate" name="btnUpdate"
                                th:onclick="|javascript:onSave('put')|" th:text="#{common.btn.update}"></button>
                        <button sec:authorize="hasAuthority('code.create')"
                                class="point-fill" type="button" id="btnRegist" name="btnRegist"
                                th:onclick="|javascript:onSave('post')|" th:text="#{common.btn.register}"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        const STATUS_SUCCESS = '0';
        const STATUS_SUCCESS_EDIT_CODE = '1';
        const STATUS_ERROR_CODE_DUPLICATION = '2';
        const STATUS_ERROR_CODE_P_CODE_NOT_EXIST = '3';
        const STATUS_ERROR_CODE_P_CODE_USED = '4';

        window.addEventListener('load', function() {
            onCreate();

            function getCodeList() {
                const opt = {
                    method: 'get',
                    url: '/rest/codes?search=' + document.querySelector('#search').value,
                    showProgressbar: false,
                    callbackFunc: function(response) {
                        let responseJson = JSON.parse(response.responseText);
                        if (responseJson.length > 0) {
                            document.querySelector('#totalCount').innerHTML = i18n.msg("common.label.count", responseJson[0].totalCount);
                            let tree = aliceJs.createTree(responseJson, document.querySelector('#treeList'), aliceJs.treeExpandSessionKey);
                            let nodes = document.querySelector('#treeList').querySelectorAll('span');
                            nodes.forEach.call(nodes, function(node) {
                                node.addEventListener('click', function(e) {
                                    onGetDetail(tree.selectedNode.text)
                                });
                            });
                        } else {
                            document.querySelector('#totalCount').innerHTML =i18n.msg("common.label.count", 0);
                            document.querySelector('#treeList').innerHTML = '';
                        }
                        aliceJs.deleteTreeExpandNode(aliceJs.treeExpandSessionKey);
                    }
                };
                aliceJs.sendXhr(opt);
            }
            getCodeList();

            function onGetDetail(codeId) {
                document.querySelectorAll('input[type=text]').forEach(function(object){
                    object.value = '';
                });
                document.querySelector('textarea').value = '';

                const opt = {
                    method: 'get',
                    url: '/rest/codes/' + codeId,
                    showProgressbar: false,
                    callbackFunc: function(response) {
                        let responseJson = JSON.parse(response.responseText);
                        document.getElementById('txtCode').value = responseJson.code;
                        document.getElementById('txtCode').setAttribute('readonly','true');
                        document.getElementById('txtPCode').value = responseJson.pcode;
                        document.getElementById('txtPCode').setAttribute('readonly','true');
                        document.getElementById('txtCodeDesc').value = responseJson.codeValue;
                        document.getElementById('txtCreateUserName').value = responseJson.createUserName;
                        document.getElementById('txtCreateDt').value = i18n.userDateTime(responseJson.createDt);
                        document.getElementById('txtUpdateUserName').value = responseJson.updateUserName;
                        document.getElementById('txtUpdateDt').value = i18n.userDateTime(responseJson.updateDt);
                        if (responseJson.editable) {
                            document.querySelector('#btnUpdate').removeAttribute('disabled');
                            document.querySelector('#btnDelete').removeAttribute('disabled');
                        } else {
                            document.getElementById('btnUpdate').disabled = true;
                            document.getElementById('btnDelete').disabled = true;
                        }
                        document.querySelector('#btnRegist').setAttribute('disabled', 'true');
                        onEdit();
                    }
                };

                aliceJs.sendXhr(opt);
            }
            OverlayScrollbars(document.querySelector('.list'), { className: 'scrollbar' });

            document.getElementById('search').addEventListener('keyup', function(e) { getCodeList(); });
        });

        /** create **/
        function onCreate() {
            document.querySelector('#btnUpdate').style.display = 'none';
            document.querySelector('#btnUpdate').setAttribute('disabled', 'true');
            document.querySelector('#btnDelete').style.display = 'none';
            document.querySelector('#btnDelete').setAttribute('disabled', 'true');
            document.querySelector('#btnRegist').removeAttribute('disabled');
            document.querySelector('#btnRegist').style.display = 'block';
            document.querySelectorAll('input[type=text]').forEach(function(object){
                object.value = '';
            });
            document.querySelector('textarea').value = '';
            document.querySelector('#txtCode').removeAttribute('readonly');
            document.querySelector('#txtPCode').removeAttribute('readonly');
        }

        function onEdit() {
            document.querySelector('#btnUpdate').style.display = 'block';
            document.querySelector('#btnDelete').style.display = 'block';
            document.querySelector('#btnRegist').style.display = 'none';
        }

        /** save **/
        function onSave(method) {
            const jsonData = {
                code: document.getElementById('txtCode').value,
                pCode: document.getElementById('txtPCode').value,
                codeValue: document.getElementById('txtCodeDesc').value
            };

            if (jsonData.code === null || jsonData.code === '') {
                aliceJs.alert([[#{code.msg.enterCode}]]);
                return false;
            }

            let url = '/rest/codes';
            if (method !== 'post') {
                url += '/' + document.getElementById('txtCode').value;
            }

            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(jsonData),
                contentType: 'application/json',
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            aliceJs.setTreeExpandNode(aliceJs.treeExpandSessionKey);
                            aliceJs.alert(i18n.get('common.msg.register'), function() {
                                window.location.href = '/codes/edit';
                            });
                            break;
                        case STATUS_SUCCESS_EDIT_CODE:
                            aliceJs.setTreeExpandNode(aliceJs.treeExpandSessionKey);
                            aliceJs.alert(i18n.get('common.msg.modify'), function() {
                                window.location.href = '/codes/edit';
                            });
                            break;
                        case STATUS_ERROR_CODE_P_CODE_NOT_EXIST:
                            aliceJs.alert(i18n.get('code.msg.pCodeNotExist'));
                            break;
                        case STATUS_ERROR_CODE_DUPLICATION:
                            aliceJs.alert(i18n.get('code.msg.duplicateCode'));
                            break;
                        default:
                            aliceJs.alert(i18n.get('common.msg.fail'));
                            break;
                    }
                }
            };

            aliceJs.sendXhr(opt);
        }

        /** delete **/
        function onDelete() {
            const opt = {
                method: 'delete',
                url: '/rest/codes/' + document.getElementById('txtCode').value,
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            aliceJs.setTreeExpandNode(aliceJs.treeExpandSessionKey);
                            aliceJs.alert(i18n.get('common.msg.delete'), function() {
                                window.location.href ='/codes/edit';
                            });
                            break;
                        case STATUS_ERROR_CODE_P_CODE_USED:
                            aliceJs.alert(i18n.get('code.msg.referenceCodeExist'));
                            break;
                        default:
                            aliceJs.alert(i18n.get('common.msg.fail'));
                            break;
                    }
                }
            };

            aliceJs.sendXhr(opt);
        }
        /*]]>*/
    </script>
</th:block>
</html>
