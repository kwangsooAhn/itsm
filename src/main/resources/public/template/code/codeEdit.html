<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/itsm/pageType/treeEditLayout}">
<head>
    <title th:text="#{code.label.code}"></title>
</head>
<th:block layout:fragment="pageHead">
    <script th:src="@{/assets/js/lib/zPageMutationObserver.js}"></script>
</th:block>
<body>
<div layout:fragment="pageTitle">
    <h1 th:text="#{code.label.code}"></h1>
    <h6 class="description ml-2 pl-2" th:text="#{code.msg.editDescription}"></h6>
</div>
<div layout:fragment="pageSearching">
    <input type="text" class="z-input i-search text-ellipsis col-5 mr-2" id="searchValue" name="searchValue"
           maxlength="100" th:placeholder="#{code.label.searchPlaceholder}"/>
    <span id="totalCount" class="z-search-count"></span>
    <div class="ml-auto" sec:authorize="hasAuthority('system.manage')">
        <button type="button" class="z-button primary" id="btnCreate" name="btnCreate"
                th:text="#{common.btn.add}" th:onclick="|javascript:onCreate()|"></button>
        <button type="button" class="z-button-icon secondary" id="btnExcelDownload" name="btnExcelDownload"
                th:title="#{common.btn.export}" th:onclick="|javascript:onExcelDownload()|">
            <img class="load-svg" th:src="@{/assets/media/icons/icon_download_xls.svg}" />
        </button>
    </div>
</div>
<div layout:fragment="pageTree">
    <div id="treeList"></div>
</div>
<div layout:fragment="pageEdit">
    <div class="z-edit-form flex-fill">
        <div class="z-edit-row flex-row">
            <div class="flex-column flex-fill mr-4">
                <label class="required" th:text="#{code.label.code}" for="txtCode"></label>
                <span id="tooltipCode" th:title="${codeDetail?.code}">
                <input id="txtCode" name="txtCode" class="z-input text-ellipsis col-pct-12" type="text"
                       th:value="${codeDetail?.code}" maxlength="100"/>
                </span>
            </div>
            <div class="flex-column flex-fill">
                <label class="required" th:text="#{code.label.pCode}" for="txtPCode"></label>
                <span id="tooltipPcode" th:title="${codeDetail?.pCode}">
                <input id="txtPCode" name="txtPCode" class="z-input text-ellipsis col-pct-12" type="text"
                       th:value="${codeDetail?.pCode}" maxlength="100"/>
                </span>
            </div>
        </div>
        <div class="z-edit-row flex-row">
            <div class="flex-column flex-fill mr-4">
                <label class="form-title" th:text="#{code.label.name}" for="txtCodeName"></label>
                <input id="txtCodeName" name="txtCodeName" class="z-input text-ellipsis" type="text"
                       th:value="${codeDetail?.codeName}" maxlength="100"/>
            </div>
            <div class="flex-column flex-fill">
                <label class="form-title" th:text="#{code.label.defaultCodeValue}" for="txtCodeValue"></label>
                <input id="txtCodeValue" name="txtCodeValue" class="z-input text-ellipsis" type="text"
                       th:value="${codeDetail?.codeValue}" maxlength="100"/>
            </div>
        </div>
        <div class="z-edit-row flex-column">
            <label class="form-title" th:text="#{code.label.seqNum}" for="txtSeqNum"></label>
            <input id="txtSeqNum" name="txtSeqNum" class="z-input text-ellipsis" type="text" th:value="${codeDetail?.seqNum}"
                   onkeydown="return onlyNumber(event)" onkeyup="aliceJs.removeChar(event)" maxlength="5"/>
        </div>
        <div class="z-edit-row flex-column">
            <label class="z-switch">
                <span class="z-label" th:text="#{code.label.useYn}"></span>
                <input type="checkbox" id="codeUseYn" name="codeUseYn"
                       th:checked="${codeDetail?.useYn == null || codeDetail?.useYn == true}">
                <span></span>
            </label>
        </div>
        <div class="z-edit-row flex-column">
            <label class="form-title" th:text="#{code.label.description}" for="txtCodeDesc"></label>
            <textarea id="txtCodeDesc" name="txtCodeDesc" th:maxlength="200" th:rows="7"
                      class="z-textarea textarea-scroll-wrapper" th:text="${codeDetail?.codeDesc}"></textarea>
        </div>
        <div class="z-edit-row flex-column flex-fill">
            <div class="flex-row justify-content-between">
                <label th:text="#{code.label.codeLang}"></label>
                <button sec:authorize="hasAuthority('system.manage')" type="button"
                        class="z-button-icon extra float-right" id="btnCodeLang">
                    <span class="z-icon i-plus"></span>
                </button>
            </div>
            <div class="horizontal-bar"></div>
            <div id="codeLang"></div>
        </div>
        <div class="flex-row justify-content-end">
            <div class="z-button-list" sec:authorize="hasAuthority('system.manage')">
                <button type="button" class="z-button primary" id="btnRegist" name="btnRegist"
                        th:onclick="|javascript:onSave('POST')|" th:text="#{common.btn.register}"></button>
                <button type="button" class="z-button primary" id="btnUpdate" name="btnUpdate"
                        th:onclick="|javascript:onSave('PUT')|" th:text="#{common.btn.modify}"></button>
                <button type="button" class="z-button danger" id="btnDelete" name="btnDelete"
                        th:onclick="|javascript:zAlert.confirm(i18n.msg('common.msg.confirmDelete'), onDelete)|"
                        th:text="#{common.btn.delete}"></button>
            </div>
        </div>
    </div>
    <template id="langCodeRowTemplate">
        <div class="z-edit-row flex-row align-items-center">
            <label class="required" th:text="#{'code.label.lang'}"></label>
            <div class="col-2 ml-3 mr-5"><select></select></div>
            <label class="required" th:text="#{code.label.name}"></label>
            <input class="z-input text-ellipsis flex-fill ml-3 mr-3" type="text" name="codeLangValue" maxlength="100">
            <button type="button" sec:authorize="hasAuthority('system.manage')" class="z-button-icon extra">
                <span class="z-icon i-delete"></span>
            </button>
        </div>
    </template>
</div>
</body>
<script layout:fragment="pageScript" type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    const STATUS_SUCCESS = '0';
    const STATUS_SUCCESS_EDIT_CODE = '1';
    const STATUS_ERROR_CODE_DUPLICATION = '2';
    const STATUS_ERROR_CODE_P_CODE_NOT_EXIST = '3';
    const STATUS_ERROR_CODE_P_CODE_USED = '4';
    let CODE_DELETE = false;
    let CODE_CREATE = false;
    let CODE_UPDATE = false;
    const sessionKey = 'code_expand_key';
    let observer = aliceJs.pageObserver;

    window.addEventListener('load', function () {
        observer.set();

        if (document.getElementById('btnCodeLang') !== null) {
            document.getElementById('btnCodeLang').addEventListener('click', drawCodeLang);
        }
        OverlayScrollbars(document.querySelector('.z-page-tree'), {className: 'scrollbar'});
        OverlayScrollbars(document.querySelector('.z-page-edit'), {className: 'scrollbar'});
        OverlayScrollbars(document.getElementById('txtCodeDesc'), {className: 'scrollbar'});
        document.getElementById('searchValue').addEventListener('keyup', aliceJs.debounce (() => getCodeList()), false);

        if (document.getElementById('btnUpdate') !== null) {
            CODE_UPDATE = true;
        }
        if (document.getElementById('btnRegist') !== null) {
            CODE_CREATE = true;
        }
        if (document.getElementById('btnDelete') !== null) {
            CODE_DELETE = true;
        }
        document.getElementById('searchValue').focus();
        onCreate();

        getCodeList();
    });

    function getCodeList() {
        const search = encodeURIComponent(document.getElementById('searchValue').value);
        tree.load({
            dataUrl: '/rest/codes?search=' + search,
            target: 'treeList',
            text: 'code',
            leafIcon: '/assets/media/icons/tree/icon_tree_leaf.svg',
            sessionKey: sessionKey,
            totalCount: true,
            onCreate: function () {
                document.getElementById('treeList').querySelector('.node').click();
            },
            selectedNode: function (response) {
                onGetDetail(response.id)
            }
        });
    }

    function onGetDetail(codeId) {
        if (!observer.canPageChange()) { return false; }

        aliceJs.fetchJson('/rest/codes/' + codeId, {
            method: 'GET',
        }).then((responseJson) => {
            // 코드
            const txtCode = document.getElementById('txtCode');
            txtCode.value = responseJson.code;
            txtCode.disabled = true;
            document.getElementById('tooltipCode').title = responseJson.code;
            // 부모 코드
            const pTxtCode = document.getElementById('txtPCode');
            pTxtCode.value = responseJson.pcode;
            pTxtCode.disabled = true;
            document.getElementById('tooltipPcode').title = responseJson.pcode;
            // 코드 이름
            document.getElementById('txtCodeName').value = responseJson.codeName;
            // 코드 값
            document.getElementById('txtCodeValue').value = responseJson.codeValue;
            // 출력 순서
            document.getElementById('txtSeqNum').value = responseJson.seqNum;
            // 코드 설명
            const txtCodeDesc = document.getElementById('txtCodeDesc');
            txtCodeDesc.value = responseJson.codeDesc;
            // 사용 여부
            document.getElementById('codeUseYn').checked = responseJson.useYn;
            // 다국어 코드
            initCodeLang(responseJson.codeLang, responseJson.editable);
            // 편집 가능 여부에 따른 처리
            if (responseJson.editable) {
                if (CODE_UPDATE) {
                    document.getElementById('btnUpdate').disabled = false;
                    document.getElementById('codeUseYn').disabled = false;
                }
                if (CODE_DELETE) {
                    document.getElementById('btnDelete').disabled = false;
                }
                document.querySelector('.z-textarea').classList.remove('z-textarea-readonly');
                txtCodeDesc.readOnly = false;
                document.getElementById('btnCodeLang').disabled = false;
            } else {
                if (CODE_UPDATE) {
                    document.getElementById('btnUpdate').disabled = true;
                    document.getElementById('codeUseYn').disabled = true;
                }
                if (CODE_DELETE) {
                    document.getElementById('btnDelete').disabled = true;
                }
                document.querySelector('.z-textarea').classList.add('z-textarea-readonly');
                txtCodeDesc.readOnly = true;
                document.getElementById('btnCodeLang').disabled = true;
            }
            // 편집 불가 처리
            const editInputElems = document.querySelector('.z-page-edit').querySelectorAll('input[type=text]');
            editInputElems.forEach((elem) => {
                elem.readOnly = !responseJson.editable;
            });
            onEdit();
            observer.isChanged = false;
        });
    }

    /** create **/
    function onCreate() {
        if (!observer.canPageChange()) { return false; }

        if (CODE_CREATE) {
            document.getElementById('btnRegist').style.display = 'block';
        }
        if (CODE_UPDATE) {
            document.getElementById('btnUpdate').style.display = 'none';
        }
        if (CODE_DELETE) {
            document.getElementById('btnDelete').style.display = 'none';
        }

        const editElems = document.querySelector('.z-page-edit').querySelectorAll('input[type=text], textarea');
        editElems.forEach((elem) => {
            elem.readOnly = false;
            elem.value = '';
        });
        document.querySelector('.z-textarea').classList.remove('z-textarea-readonly');
        document.getElementById('txtCode').disabled = false;
        document.getElementById('codeUseYn').disabled = false;
        document.getElementById('btnCodeLang').disabled = false;
        document.getElementById('codeLang').innerHTML = '';

        let selectedNode = tree.getTreeSelectNode();
        if (selectedNode !== null) {
            document.getElementById('txtPCode').value = selectedNode.id;
        }
        observer.isChanged = false;
    }

    function onEdit() {
        if (CODE_UPDATE) {
            document.getElementById('btnUpdate').style.display = 'block';
        }
        if (CODE_DELETE) {
            document.getElementById('btnDelete').style.display = 'block';
        }
        if (CODE_CREATE) {
            document.getElementById('btnRegist').style.display = 'none';
        }
    }


    /** save **/
    function onSave(method) {
        const jsonData = {
            code: document.getElementById('txtCode').value,
            pCode: document.getElementById('txtPCode').value,
            codeName: document.getElementById('txtCodeName').value,
            codeValue: document.getElementById('txtCodeValue').value,
            codeDesc: document.getElementById('txtCodeDesc').value,
            seqNum: document.getElementById('txtSeqNum').value,
            useYn: document.getElementById('codeUseYn').checked
        };

        if (jsonData.code === null || jsonData.code.trim() === '') {
            zAlert.warning([[#{code.msg.enterCode}]]);
            return false;
        }

        if (jsonData.pCode === null || jsonData.pCode.trim() === '') {
            zAlert.warning([[#{code.msg.enterPCode}]]);
            return false;
        }

        if (codeUnacceptableChar(jsonData.code) === false) {
            zAlert.warning(i18n.msg('validation.msg.unacceptableCharacters'), function () {
                document.getElementById('txtCode').focus();
            });
            return false;
        }

        const codeLangList = document.querySelectorAll('input[name=codeLangValue]');
        for (let i = 0; i < codeLangList.length; i++) {
            if (codeLangList[i].value.trim() === "") {
                zAlert.warning([[#{code.msg.enterCodeLangValue}]]);
                return false;
            }
        }

        let codeLangData = {};
        let divLang = document.getElementById('codeLang').children;
        for (let i = 0; i < divLang.length; i++) {
            const selectValue = divLang[i].getElementsByTagName('select')[0].value;
            const codeLangValue = divLang[i].getElementsByTagName('input')[1].value;
            if (typeof codeLangData[selectValue] === 'undefined') {
                codeLangData[selectValue] = codeLangValue;
            } else {
                zAlert.warning(i18n.msg('code.msg.selectNotDuplicateLang'));
                return false;
            }
        }
        if (divLang.length !== 0) {
            jsonData.codeLang = JSON.stringify(codeLangData);
        }

        let url = '/rest/codes';
        if (method !== 'POST') {
            url += '/' + document.getElementById('txtCode').value;
        }
        aliceJs.fetchText(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(jsonData)
        }).then((status) => {
            switch (status) {
                case STATUS_SUCCESS:
                    tree.setTreeExpandNode(sessionKey);
                    zAlert.success(i18n.msg('common.msg.register'), function () {
                        window.location.href = '/codes/edit';
                    });
                    break;
                case STATUS_SUCCESS_EDIT_CODE:
                    tree.setTreeExpandNode(sessionKey);
                    zAlert.success(i18n.msg('common.msg.modify'), function () {
                        window.location.href = '/codes/edit';
                    });
                    break;
                case STATUS_ERROR_CODE_P_CODE_NOT_EXIST:
                    zAlert.warning(i18n.msg('code.msg.pCodeNotExist'));
                    break;
                case STATUS_ERROR_CODE_DUPLICATION:
                    zAlert.warning(i18n.msg('code.msg.duplicateCode'));
                    break;
                default:
                    break;
            }
        });
    }

    /** delete **/
    function onDelete() {
        aliceJs.fetchText('/rest/codes/' + document.getElementById('txtCode').value, {
            method: 'DELETE'
        }).then((status) => {
            switch (status) {
                case STATUS_SUCCESS:
                    tree.setTreeExpandNode(sessionKey);
                    zAlert.success(i18n.msg('common.msg.delete'), function () {
                        window.location.href = '/codes/edit';
                    });
                    break;
                case STATUS_ERROR_CODE_P_CODE_USED:
                    zAlert.warning(i18n.msg('code.msg.referenceCodeExist'));
                    break;
                default:
                    zAlert.danger(i18n.msg('common.msg.fail'));
                    break;
            }
        });
    }

    function codeUnacceptableChar(code) {
        let regex = new RegExp("[/\\\\%;]");
        return !code.match(regex);
    }

    function drawCodeLang(param) {
        const langCodeRow = document.getElementById('langCodeRowTemplate').content.cloneNode(true);

        const langList = /*[[${langList}]]*/'';
        const selectTag = langCodeRow.querySelector('select')
        for (let i = 0; i < langList.length; i++) {
            const selectOption = document.createElement('option');
            selectOption.value = langList[i].codeValue;
            selectOption.text = langList[i].codeValue;
            selectOption.selected = (typeof param !== 'undefined') ? (param.lang === selectOption.value) : '';
            selectTag.appendChild(selectOption);
        }

        langCodeRow.querySelector('input').value = (typeof param.codeLangValue !== 'undefined') ? param.codeLangValue : '';
        const deleteBtn = langCodeRow.querySelector('button.z-button-icon');
        if (deleteBtn !== null) {
            deleteBtn.addEventListener('click', function () {
                const row = deleteBtn.parentNode;
                row.remove();
                observer.isChanged = true;
            });
        }

        document.getElementById('codeLang').appendChild(langCodeRow);
        aliceJs.initDesignedSelectTag(document.querySelector('#codeLang'));
        observer.set();
    }

    function initCodeLang(param, editable) {
        const divCodeLang = document.getElementById('codeLang');
        while (divCodeLang.hasChildNodes()) {
            divCodeLang.removeChild(divCodeLang.firstChild);
        }
        if (param !== '') {
            const codeLang = JSON.parse(param);
            for (let index in codeLang) {
                drawCodeLang({lang: codeLang[index].lang, codeLangValue: codeLang[index].codeValue});
            }
        }
        divCodeLang.querySelectorAll('button').forEach((elem) => {
            elem.disabled = !editable;
        });
    }

    function onExcelDownload() {
        const search = encodeURIComponent(document.getElementById('searchValue').value);
        aliceJs.fetchDownload({
            url: '/rest/codes/excel?search=' + search,
            fileName: i18n.msg('code.label.code') + '_' + new Date().toISOString().substring(0, 10).replace(/-/g, '')
        });
    }

    /*]]>*/
</script>
</html>
