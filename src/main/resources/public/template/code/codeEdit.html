<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorator="layout/defaultLayout">
<head>
    <title th:text="#{code.label.code}"></title>
</head>
<body>
<th:block layout:fragment="content">
    <div class="code-header">
        <div class="header-title flex-row align-items-baseline">
            <h1 th:text="#{code.label.code}"></h1>
            <h6 class="description" th:text="#{code.msg.editDescription}"></h6>
        </div>
        <div class="header-search flex-row">
            <input type="text" class="search col-5 mr-2" id="search" name="search" th:placeholder="#{code.label.searchPlaceholder}"/>
            <span id="totalCount" class="txt-num"></span>
            <div class="ml-auto">
                <button type="button" class="default-fill" id="btnCreate" name="btnCreate" onclick="onCreate();"
                        sec:authorize="hasAuthority('code.create')" th:text="#{common.btn.add}"></button>
            </div>
        </div>
    </div>
    <div class="code-content flex-fill">
        <div class="list-tree">
            <div id="treeList"></div>
        </div>
    </div>
</th:block>
<th:block layout:fragment="aside">
    <div class="aside code">
        <div class="code-content-edit flex-column">
            <div class="edit-form">
                <div class="edit-row flex-row">
                    <div class="edit-column flex-column flex-fill mr-4">
                        <label class="required" th:text="#{code.label.code}" for="txtCode"></label>
                        <input id="txtCode" name="txtCode" type="text" th:value="${codeDetail?.code}" maxlength="100"/>
                    </div>
                    <div class="edit-column flex-column flex-fill">
                        <label class="required" th:text="#{code.label.pCode}" for="txtPCode"></label>
                        <input id="txtPCode" name="txtPCode" type="text" th:value="${codeDetail?.pCode}" maxlength="100"/>
                    </div>
                </div>
                <div class="edit-row flex-row">
                    <div class="edit-column flex-column flex-fill mr-4">
                        <label class="form-title" th:text="#{code.label.name}" for="txtCodeName"></label>
                        <input id="txtCodeName" name="txtCodeName" type="text" th:value="${codeDetail?.codeName}" maxlength="100"/>
                    </div>
                    <div class="edit-column flex-column flex-fill">
                        <label class="form-title" th:text="#{code.label.codeValue}" for="txtCodeValue"></label>
                        <input id="txtCodeValue" name="txtCodeValue" type="text" th:value="${codeDetail?.codeValue}" maxlength="100"/>
                    </div>
                </div>
                <div class="edit-row flex-column">
                    <label class="form-title" th:text="#{code.label.seqNum}" for="txtSeqNum"></label>
                    <input id="txtSeqNum" name="txtSeqNum" type="text" th:value="${codeDetail?.seqNum}"
                           onkeydown="return onlyNumber(event)" onkeyup="removeChar(event)" maxlength="5"/>
                </div>
                <div class="edit-row flex-column">
                    <label class="form-title" th:text="#{code.label.description}" for="txtCodeDesc"></label>
                    <textarea id="txtCodeDesc" name="txtCodeDesc" th:maxlength="200" th:rows="7"
                              class="textarea-scroll-wrapper" th:text="${codeDetail?.codeDesc}"></textarea>
                </div>
                <div class="edit-row flex-row">
                    <div class="edit-column flex-column flex-fill mr-4">
                        <label class="form-title" th:text="#{common.label.createUser}"></label>
                        <input id="txtCreateUserName" name="txtCreateUserName" type="text" th:value="${codeDetail?.createUserName}" th:disabled="true" maxlength="100"/>
                    </div>
                    <div class="edit-column flex-column flex-fill">
                        <label class="form-title" th:text="#{common.label.updateUser}"></label>
                        <input id="txtUpdateUserName" name="txtUpdateUserName" type="text" th:value="${codeDetail?.updateUserName}" th:disabled="true" maxlength="100"/>
                    </div>
                </div>
                <div class="edit-row flex-row">
                    <div class="edit-column flex-column flex-fill mr-4">
                        <label class="form-title" th:text="#{common.label.createDate}"></label>
                        <input id="txtCreateDt" name="txtCreateDt" class="search-datetime" type="text" th:disabled="true" maxlength="100"/>
                    </div>
                    <div class="edit-column flex-column flex-fill">
                        <label class="form-title" th:text="#{common.label.updateDate}"></label>
                        <input id="txtUpdateDt" name="txtUpdateDt" class="search-datetime" type="text" th:disabled="true" maxlength="100"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-row justify-content-end">
            <div class="btn-list">
                <button sec:authorize="hasAuthority('code.create')"
                        class="point-fill" type="button" id="btnRegist" name="btnRegist"
                        th:onclick="|javascript:onSave('post')|" th:text="#{common.btn.register}"></button>
                <button sec:authorize="hasAuthority('code.update')"
                        class="point-fill" type="button" id="btnUpdate" name="btnUpdate"
                        th:onclick="|javascript:onSave('put')|" th:text="#{common.btn.update}"></button>
                <button sec:authorize="hasAuthority('code.delete')"
                        class="point-fill" type="button" id="btnDelete" name="btnDelete"
                        th:onclick="|javascript:aliceJs.confirmIcon(i18n.msg('common.msg.confirmDelete'), onDelete)|" th:text="#{common.btn.delete}"></button>
            </div>
        </div>
    </div>
</th:block>
</body>
<th:block layout:fragment="pageScript">
    <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        const STATUS_SUCCESS = '0';
        const STATUS_SUCCESS_EDIT_CODE = '1';
        const STATUS_ERROR_CODE_DUPLICATION = '2';
        const STATUS_ERROR_CODE_P_CODE_NOT_EXIST = '3';
        const STATUS_ERROR_CODE_P_CODE_USED = '4';
        const sessionKey = 'code_expand_key';

        window.addEventListener('load', function() {
            document.getElementById('search').focus();
            onCreate();

            function getCodeList() {
                tree.load({
                    search: encodeURIComponent(document.querySelector('#search').value.trim()),
                    target: 'treeList',
                    text: 'code',
                    leafIcon: '/assets/media/icons/tree/icon_tree_leaf.svg',
                    sessionKey: sessionKey,
                    totalCount: true,
                    selectedNode: function(response) {
                        onGetDetail(response.id)
                    }
                });
            }
            getCodeList();

            function onGetDetail(codeId) {
                document.querySelectorAll('input[type=text]').forEach(function(object){
                    object.value = '';
                });
                document.querySelector('textarea').value = '';

                const opt = {
                    method: 'get',
                    url: '/rest/codes/' + codeId,
                    showProgressbar: false,
                    callbackFunc: function(response) {
                        let responseJson = JSON.parse(response.responseText);
                        document.getElementById('txtCode').value = responseJson.code;
                        document.getElementById('txtCode').setAttribute('disabled','');
                        document.getElementById('txtPCode').value = responseJson.pcode;
                        document.getElementById('txtPCode').setAttribute('disabled','');
                        document.getElementById('txtCodeName').value = responseJson.codeName;
                        document.getElementById('txtCodeValue').value = responseJson.codeValue;
                        document.getElementById('txtCodeDesc').value = responseJson.codeDesc;
                        document.getElementById('txtSeqNum').value = responseJson.seqNum;
                        document.getElementById('txtCreateUserName').value = responseJson.createUserName;
                        document.getElementById('txtCreateDt').value = i18n.userDateTime(responseJson.createDt);
                        document.getElementById('txtUpdateUserName').value = responseJson.updateUserName;
                        document.getElementById('txtUpdateDt').value = i18n.userDateTime(responseJson.updateDt);
                        if (responseJson.editable) {
                            document.querySelector('#btnUpdate').removeAttribute('disabled');
                            document.querySelector('#btnDelete').removeAttribute('disabled');
                        } else {
                            document.getElementById('btnUpdate').disabled = true;
                            document.getElementById('btnDelete').disabled = true;
                        }
                        document.querySelector('#btnRegist').setAttribute('disabled', 'true');
                        onEdit();
                    }
                };

                aliceJs.sendXhr(opt);
            }
            OverlayScrollbars(document.querySelector('.list-tree'), { className: 'scrollbar' });
            document.getElementById('search').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    getCodeList();
                }
            }, false);
            OverlayScrollbars(document.querySelector('.code-content-edit'), { className: 'scrollbar' });
            OverlayScrollbars(document.querySelectorAll('#txtCodeDesc'), {
                className: 'scrollbar',
                resize: 'vertical',
                sizeAutoCapable: true,
                textarea: {
                    dynHeight: false,
                    dynWidth: false,
                    inheritedAttrs: "class"
                }
            });
        });

        function onlyNumber(event) {
            event = event || window.event;
            const keyID = (event.which) ? event.which : event.keyCode;
            if (!((keyID >= 48 && keyID <= 57) || (keyID >= 96 && keyID <= 105)
                || keyID === 8 || keyID === 9 || keyID === 46 || keyID === 37 || keyID === 39)) {
                return false;
            }
        }

        function removeChar(event) {
            event = event || window.event;
            const keyID = (event.which) ? event.which : event.keyCode;
            if (!(keyID === 8 || keyID === 9 || keyID === 46 || keyID === 37 || keyID === 39)) {
                event.target.value = event.target.value.replace(/[^0-9]/g, '');
            }
        }

        /** create **/
        function onCreate() {
            document.querySelector('#btnUpdate').style.display = 'none';
            document.querySelector('#btnUpdate').setAttribute('disabled', 'true');
            document.querySelector('#btnDelete').style.display = 'none';
            document.querySelector('#btnDelete').setAttribute('disabled', 'true');
            document.querySelector('#btnRegist').removeAttribute('disabled');
            document.querySelector('#btnRegist').style.display = 'block';
            document.querySelectorAll('input[type=text]').forEach(function(object){
                object.value = '';
            });
            document.querySelector('textarea').value = '';
            document.querySelector('#txtCode').removeAttribute('disabled');
            document.querySelector('#txtPCode').removeAttribute('disabled');

            let selectedNode = tree.getTreeSelectNode();
            if (selectedNode !== null) {
                document.querySelector('#txtPCode').value = selectedNode.id;
            }
        }

        function onEdit() {
            document.querySelector('#btnUpdate').style.display = 'block';
            document.querySelector('#btnDelete').style.display = 'block';
            document.querySelector('#btnRegist').style.display = 'none';
        }

        /** save **/
        function onSave(method) {
            const jsonData = {
                code: document.getElementById('txtCode').value,
                pCode: document.getElementById('txtPCode').value,
                codeName: document.getElementById('txtCodeName').value,
                codeValue: document.getElementById('txtCodeValue').value,
                codeDesc: document.getElementById('txtCodeDesc').value,
                seqNum: document.getElementById('txtSeqNum').value
            };

            if (jsonData.code === null || jsonData.code.trim() === '') {
                aliceJs.alertWarning([[#{code.msg.enterCode}]]);
                return false;
            }

            if (jsonData.pCode === null || jsonData.pCode.trim() === '') {
                aliceJs.alertWarning([[#{code.msg.enterPCode}]]);
                return false;
            }

            let url = '/rest/codes';
            if (method !== 'post') {
                url += '/' + document.getElementById('txtCode').value;
            }

            const opt = {
                method: method,
                url: url,
                params: JSON.stringify(jsonData),
                contentType: 'application/json',
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            tree.setTreeExpandNode(sessionKey);
                            aliceJs.alertSuccess(i18n.msg('common.msg.register'), function() {
                                window.location.href = '/codes/edit';
                            });
                            break;
                        case STATUS_SUCCESS_EDIT_CODE:
                            tree.setTreeExpandNode(sessionKey);
                            aliceJs.alertSuccess(i18n.msg('common.msg.modify'), function() {
                                window.location.href = '/codes/edit';
                            });
                            break;
                        case STATUS_ERROR_CODE_P_CODE_NOT_EXIST:
                            aliceJs.alertWarning(i18n.msg('code.msg.pCodeNotExist'));
                            break;
                        case STATUS_ERROR_CODE_DUPLICATION:
                            aliceJs.alertWarning(i18n.msg('code.msg.duplicateCode'));
                            break;
                        default:
                            aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                            break;
                    }
                }
            };

            aliceJs.sendXhr(opt);
        }

        /** delete **/
        function onDelete() {
            const opt = {
                method: 'delete',
                url: '/rest/codes/' + document.getElementById('txtCode').value,
                callbackFunc: function(response) {
                    switch (response.responseText) {
                        case STATUS_SUCCESS:
                            tree.setTreeExpandNode(sessionKey);
                            aliceJs.alertSuccess(i18n.msg('common.msg.delete'), function() {
                                window.location.href ='/codes/edit';
                            });
                            break;
                        case STATUS_ERROR_CODE_P_CODE_USED:
                            aliceJs.alertWarning(i18n.msg('code.msg.referenceCodeExist'));
                            break;
                        default:
                            aliceJs.alertDanger(i18n.msg('common.msg.fail'));
                            break;
                    }
                }
            };

            aliceJs.sendXhr(opt);
        }
        /*]]>*/
    </script>
</th:block>
</html>
